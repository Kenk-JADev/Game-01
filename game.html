<!-- START: ZUEF Widget + BÃ¼roVersum RPG - Ultimate Edition v4.0 -->
<div id="zuef-main-wrapper">

    <!-- Twemoji fÃ¼r Win10/Win11 konsistente Emojis -->
    <script src="https://cdn.jsdelivr.net/npm/@twemoji/api@latest/dist/twemoji.min.js" crossorigin="anonymous"></script>

    <!-- WIDGET (unverÃ¤ndert) -->
    <div class="zuef-centered-col">
        <div class="zuef-premium-card" id="zuef-secret-trigger">
            <div class="zuef-card-body">
                <div class="zuef-status-badge"><span class="zuef-live-dot"></span> LIVE</div>
                <div id="zuef-image-host"></div>
                <div class="zuef-spotlight-effect"></div>
                <div class="zuef-shine-sweep"></div>
            </div>
        </div>
        <div class="zuef-info-section">
            <h2 class="zuef-main-title">Exklusiv bis <span class="zuef-accent-date">18.02.2026</span></h2>
            <div class="zuef-countdown-row">
                <div class="zuef-time-block"><span class="zuef-num" id="cd-d">00</span><span
                        class="zuef-label">Tage</span></div>
                <div class="zuef-divider-line"></div>
                <div class="zuef-time-block"><span class="zuef-num" id="cd-h">00</span><span
                        class="zuef-label">Std</span></div>
                <div class="zuef-divider-line"></div>
                <div class="zuef-time-block"><span class="zuef-num" id="cd-m">00</span><span
                        class="zuef-label">Min</span></div>
                <div class="zuef-divider-line"></div>
                <div class="zuef-time-block"><span class="zuef-num" id="cd-s">00</span><span
                        class="zuef-label">Sek</span></div>
            </div>
        </div>
    </div>

    <!-- RPG OVERLAY -->
    <div id="rpg-overlay">

        <!-- SPLASH (Mobile-Fixed) -->
        <div id="rpg-splash" class="rpg-fullscreen">
            <div class="splash-bg">
                <div class="splash-particles"></div>
                <div class="splash-grid"></div>
            </div>
            <div class="splash-content">
                <div class="splash-logo">
                    <div class="splash-icon">ğŸ¢</div>
                    <div class="splash-icon-glow"></div>
                </div>
                <h1 class="splash-title">
                    <span class="title-letter" style="--i:0">B</span>
                    <span class="title-letter" style="--i:1">Ã¼</span>
                    <span class="title-letter" style="--i:2">r</span>
                    <span class="title-letter" style="--i:3">o</span>
                    <span class="title-letter" style="--i:4">V</span>
                    <span class="title-letter" style="--i:5">e</span>
                    <span class="title-letter" style="--i:6">r</span>
                    <span class="title-letter" style="--i:7">s</span>
                    <span class="title-letter" style="--i:8">u</span>
                    <span class="title-letter" style="--i:9">m</span>
                </h1>
                <div class="splash-subtitle">â€” R O L E P L A Y I N G G A M E â€”</div>
                <div class="splash-version">v4.0.2 Ultimate Edition</div>
                <div class="splash-credits">Entwickelt von Justin</div>
                <div class="splash-loader-container">
                    <div class="splash-loader-bar"></div>
                    <div class="splash-loader-text">Laden...</div>
                </div>
                <!-- MOBILE FIX: Tap-Button fÃ¼r Handy -->
                <button class="splash-start-btn" id="splash-start-btn">
                    <span class="press-icon">â–¶</span>
                    <span>SPIEL STARTEN</span>
                </button>
                <div class="splash-press desktop-only">
                    <span class="press-icon">â–¶</span>
                    <span>DrÃ¼cke ENTER zum Starten</span>
                    <span class="press-icon">â—€</span>
                </div>
            </div>
        </div>

        <!-- MAP TRANSITION -->
        <div id="map-transition">
            <div class="transition-overlay top"></div>
            <div class="transition-overlay bottom"></div>
            <div class="transition-content">
                <div class="transition-icon">ğŸšª</div>
                <div class="transition-text">Lade...</div>
                <div class="transition-dots"><span>.</span><span>.</span><span>.</span></div>
            </div>
        </div>

        <!-- BATTLE PANELS -->
        <div id="battle-panels">
            <div class="battle-panel top"></div>
            <div class="battle-panel bottom"></div>
        </div>

        <!-- CHEAT CONSOLE -->
        <div id="cheat-console">
            <div class="cheat-header">
                <span>ğŸ® Cheat-Konsole</span>
                <button onclick="toggleCheatConsole()">âœ•</button>
            </div>
            <div class="cheat-log" id="cheat-log"></div>
            <input type="text" id="cheat-input" placeholder="Cheat eingeben..." autocomplete="off" />
            <div class="cheat-hints">
                <small>Befehle: /gold, /hp, /lvl, /tp, /godmode, /items, /help</small>
            </div>
        </div>

        <!-- CLOSE BUTTON -->
        <button id="rpg-close-btn" onclick="closeRPG()">âœ•</button>

        <!-- GAME WINDOW -->
        <div id="rpg-game-window">

            <!-- TITLE MENU SCREEN -->
            <div id="rpg-title-screen" class="rpg-screen">
                <div class="title-screen-bg">
                    <div class="title-particles"></div>
                    <div class="title-grid"></div>
                </div>
                <div class="title-screen-content">
                    <div class="title-menu">
                        <div class="title-logo">
                            <div class="title-icon">ğŸ¢</div>
                            <h1>BÃ¼roVersum</h1>
                            <p>Mache dich als Mitarbeiter bereit!</p>
                        </div>
                        <div class="title-buttons">
                            <button class="title-btn" id="title-new-game">
                                <span class="btn-icon">ğŸ†•</span>
                                <span class="btn-text">Neues Spiel</span>
                            </button>
                            <button class="title-btn" id="title-continue" style="display:none;">
                                <span class="btn-icon">â–¶ï¸</span>
                                <span class="btn-text">Fortfahren</span>
                            </button>
                            <button class="title-btn" id="title-delete-save">
                                <span class="btn-icon">ğŸ—‘ï¸</span>
                                <span class="btn-text">Speicherdaten lÃ¶schen</span>
                            </button>
                        </div>
                    </div>
                    <button class="changelog-btn" id="title-changelog" title="Was ist neu?">
                        <span class="changelog-icon">ğŸ“œ</span>
                    </button>
                </div>
            </div>

            <!-- QUIT OPTIONS MODAL (reusable) -->
            <div id="quit-modal" class="quit-modal" style="display:none;">
                <div class="quit-content">
                    <h3>Beenden</h3>
                    <p>Was mÃ¶chtest du tun?</p>
                    <div class="quit-actions">
                        <button class="quit-btn" id="quit-to-title">ZurÃ¼ck zum TitelmenÃ¼</button>
                        <button class="quit-btn danger" id="quit-close-window">Fenster schlieÃŸen</button>
                        <button class="quit-btn secondary" id="quit-cancel">Abbrechen</button>
                    </div>
                </div>
            </div>

            <!-- CHANGELOG MODAL -->
            <div id="changelog-modal" class="changelog-modal">
                <div class="changelog-content">
                    <div class="changelog-header">
                        <h2>ğŸ“œ Changelog</h2>
                        <button class="changelog-close" id="changelog-close">âœ•</button>
                    </div>
                    <div class="changelog-body">
                        <div class="changelog-version">
                            <h3>Version 4.0.2 - Save/Load Fix</h3>
                            <div class="changelog-date">Februar 2026</div>
                            <ul>
                                <li>ğŸ› Speichersystem komplett Ã¼berarbeitet: Name, Geschlecht, Items, Abteilung und Ort
                                    werden nun korrekt gespeichert</li>
                                <li>ğŸ› Laden-Funktion verbessert: Alle Spieler-Daten (Name, Sprite, Gender, Department)
                                    werden vollstÃ¤ndig wiederhergestellt</li>
                                <li>ğŸ› "Fortfahren"-Button im TitelmenÃ¼ stellt nun alle Charaktereigenschaften korrekt
                                    wieder her</li>
                                <li>ğŸ› Speicherdaten enthalten jetzt gender und dept direkt im player-Objekt</li>
                                <li>ğŸ› UI-Elemente (HUD, MenÃ¼, Battle-Screen) zeigen nach dem Laden die korrekten Werte
                                    an</li>
                                <li>ğŸ’¾ "Neues Spiel" Ã¼berschreibt bestehende Saves nicht mehr vor Vertragsunterzeichnung
                                </li>
                            </ul>
                        </div>
                        <div class="changelog-version">
                            <h3>Version 4.0 - Ultimate Edition</h3>
                            <div class="changelog-date">Februar 2026</div>
                            <ul>
                                <li>âœ¨ TitlemenÃ¼ implementiert (Neues Spiel / Fortfahren)</li>
                                <li>ğŸ’¾ Savefile-System mit localStorage</li>
                                <li>âœï¸ TypeWrite-Effekt beim Arbeitsvertrag unterschreiben</li>
                                <li>ğŸšª TÃ¼ren-System zwischen Maps</li>
                                <li>ğŸ—ºï¸ Map-Dekoration und visuelles Design verbessert</li>
                                <li>ğŸ“ Map-Transitions mit Animations-Effekten</li>
                                <li>ğŸ® Improved Menu-System</li>
                                <li>ğŸ› Spieler-Name wird korrekt gespeichert und beim Laden wiederhergestellt</li>
                                <li>ğŸ› "Fortfahren"-Button funktioniert jetzt korrekt</li>
                                <li>ğŸ› Badge-Details (Auszubildende/r, Abteilung) werden erst beim Unterschreiben
                                    angezeigt</li>
                                <li>ğŸ› Spacing-Bug bei "Abteilung: Einkauf" behoben</li>
                                <li>âœ¨ Scrollverhalten im Arbeitsvertrag optimiert</li>
                                <li>ğŸ› Vertragsbutton wird beim Neustarten des Spiels reaktiviert</li>
                            </ul>
                        </div>
                        <div class="changelog-version">
                            <h3>Version 3.5</h3>
                            <div class="changelog-date">Januar 2026</div>
                            <ul>
                                <li>ğŸ¯ Battle-System Ã¼berarbeitet</li>
                                <li>ğŸ“Š Enemy-Management verbessert</li>
                                <li>ğŸ’¬ Dialogue-System erweitert</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- NAME SCREEN -->
            <div id="rpg-name-screen" class="rpg-screen">
                <div class="name-screen-bg">
                    <div class="name-particles"></div>
                    <div class="name-grid"></div>
                </div>
                <div class="name-screen-content">
                    <div class="contract-wrapper">
                        <div class="contract-paper">
                            <div class="contract-header">
                                <div class="contract-logo">ğŸ¢</div>
                                <div class="contract-company">
                                    <h2>BÃ¼roVersum GmbH.</h2>
                                    <p>Personalwesen & Ausbildung</p>
                                </div>
                                <div class="contract-stamp">
                                    <span>âœ“</span>
                                    <small>GENEHMIGT</small>
                                </div>
                            </div>

                            <div class="contract-divider"></div>

                            <div class="contract-title">
                                <span class="doc-icon">ğŸ“„</span>
                                <h3>ARBEITSVERTRAG</h3>
                                <span class="doc-subtitle">Einstellungsformular fÃ¼r neue Mitarbeiter</span>
                            </div>

                            <div class="contract-body">
                                <div class="contract-section">
                                    <label class="contract-label">
                                        <span class="label-num">Â§1</span>
                                        Name des Mitarbeiters:
                                    </label>
                                    <div class="contract-input-wrapper">
                                        <input type="text" id="rpg-name-input" maxlength="12"
                                            placeholder="VollstÃ¤ndiger Name..." autocomplete="off" />
                                        <div class="input-underline"></div>
                                    </div>
                                    <div class="name-error" id="name-error"></div>
                                </div>

                                <div class="contract-section">
                                    <label class="contract-label">
                                        <span class="label-num">Â§2</span>
                                        Geschlecht:
                                    </label>
                                    <div class="gender-select">
                                        <button type="button" class="gender-btn active" data-gender="m" id="gender-m">
                                            <span class="gender-icon">ğŸ§‘â€ğŸ’¼</span>
                                            <span class="gender-text">Mitarbeiter</span>
                                        </button>
                                        <button type="button" class="gender-btn" data-gender="f" id="gender-f">
                                            <span class="gender-icon">ğŸ‘©â€ğŸ’¼</span>
                                            <span class="gender-text">Mitarbeiterin</span>
                                        </button>
                                    </div>
                                </div>

                                <div class="contract-section">
                                    <label class="contract-label">
                                        <span class="label-num">Â§3</span>
                                        Abteilung:
                                    </label>
                                    <div class="dept-select">
                                        <button type="button" class="dept-btn active" data-dept="einkauf"
                                            id="dept-einkauf">
                                            <span class="dept-icon">ğŸ›’</span>
                                            <span class="dept-name">Einkauf</span>
                                        </button>
                                        <button type="button" class="dept-btn" data-dept="verkauf" id="dept-verkauf">
                                            <span class="dept-icon">ğŸ’¼</span>
                                            <span class="dept-name">Verkauf</span>
                                        </button>
                                        <button type="button" class="dept-btn" data-dept="zentrale" id="dept-zentrale">
                                            <span class="dept-icon">ğŸ–¥ï¸</span>
                                            <span class="dept-name">Zentrale</span>
                                        </button>
                                        <button type="button" class="dept-btn" data-dept="verwaltung"
                                            id="dept-verwaltung">
                                            <span class="dept-icon">ğŸ“‹</span>
                                            <span class="dept-name">Verwaltung</span>
                                        </button>
                                    </div>
                                </div>

                                <div class="contract-section">
                                    <label class="contract-label">
                                        <span class="label-num">Â§4</span>
                                        Mitarbeiter-Ausweis:
                                    </label>
                                    <div class="employee-badge">
                                        <div class="badge-photo-frame">
                                            <div class="badge-photo" id="badge-avatar">ğŸ§‘â€ğŸ’¼</div>
                                        </div>
                                        <div class="badge-details">
                                            <div class="badge-name" id="preview-name">HELD</div>
                                            <div class="badge-role" id="badge-role" style="display:none;">
                                                Auszubildende/r</div>
                                            <div class="badge-dept" id="badge-dept" style="display:none;">Abteilung:
                                                Einkauf</div>
                                            <div class="badge-id">ID: #BV-2025-001</div>
                                            <div class="badge-barcode">||||| |||| ||||| ||||</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="contract-footer">
                                <div class="contract-signature">
                                    <div class="signature-line">
                                        <span class="signature-x" id="signature-x-employee"></span>
                                        <div class="signature-placeholder">Unterschrift Mitarbeiter</div>
                                    </div>
                                    <div class="signature-line">
                                        <span class="signature-signed">Patrick Abend</span>
                                        <div class="signature-placeholder">Unterschrift Ausbilder</div>
                                    </div>
                                </div>
                                <div class="contract-date">
                                    Datum: <span id="contract-date"></span>
                                </div>
                            </div>
                        </div>

                        <button id="rpg-start-btn" class="contract-submit-btn">
                            <span class="btn-icon">âœï¸</span>
                            <span class="btn-text">Vertrag unterschreiben & Arbeit beginnen</span>
                            <span class="btn-arrow">â†’</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- GAME SCREEN -->
            <div id="rpg-game-screen" class="rpg-screen">
                <!-- HUD -->
                <div id="rpg-hud">
                    <div class="hud-left">
                        <div class="hud-portrait-frame">
                            <div class="hud-portrait" id="hud-portrait">ğŸ§‘â€ğŸ’¼</div>
                            <div class="hud-level-badge" id="hud-level">1</div>
                        </div>
                        <div class="hud-info">
                            <div class="hud-name" id="hud-player-name">HELD</div>
                            <div class="hud-stats">
                                <div class="hud-bar hp">
                                    <span class="bar-icon">â¤ï¸</span>
                                    <div class="bar-track">
                                        <div class="bar-fill" id="hud-hp-bar"></div>
                                    </div>
                                    <span class="bar-text"><span id="hud-hp">100</span>/<span
                                            id="hud-max-hp">100</span></span>
                                </div>
                                <div class="hud-bar mp">
                                    <span class="bar-icon">â˜•</span>
                                    <div class="bar-track">
                                        <div class="bar-fill" id="hud-mp-bar"></div>
                                    </div>
                                    <span class="bar-text"><span id="hud-mp">10</span>/10</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="hud-center">
                        <div class="hud-location-badge">
                            <span class="loc-icon">ğŸ“</span>
                            <span class="loc-text" id="hud-location">HauptbÃ¼ro</span>
                        </div>
                        <!-- Minimap Toggle -->
                        <button class="minimap-toggle" onclick="toggleMinimap()">ğŸ—ºï¸</button>
                    </div>
                    <div class="hud-right">
                        <div class="hud-gold-display">
                            <span class="gold-icon">ğŸ’°</span>
                            <span class="gold-amount" id="hud-gold">50</span>
                        </div>
                        <div class="hud-exp-display">
                            <span class="exp-icon">â­</span>
                            <div class="exp-bar-mini">
                                <div class="exp-fill-mini" id="hud-exp-bar"></div>
                            </div>
                        </div>
                        <div class="hud-hint">[E] MenÃ¼ â€¢ [C] Cheats</div>
                    </div>
                </div>

                <!-- MINIMAP -->
                <div id="minimap-container">
                    <canvas id="minimap-canvas"></canvas>
                    <div class="minimap-legend">
                        <span>ğŸŸ¢ Du</span>
                        <span>ğŸ”µ NPC</span>
                        <span>ğŸ”´ Gegner</span>
                        <span>ğŸŸ¡ TÃ¼r</span>
                    </div>
                </div>

                <!-- VIEWPORT (mit Kamera) -->
                <div id="rpg-viewport">
                    <div id="rpg-camera">
                        <canvas id="rpg-canvas"></canvas>
                        <div id="rpg-parallax-layer"></div>
                        <div id="rpg-deco-layer"></div>
                        <div id="rpg-chest-layer"></div>
                        <div id="rpg-door-layer"></div>
                        <div id="rpg-player" class="rpg-sprite">
                            <div class="sprite-shadow"></div>
                            <div class="sprite-body">ğŸ§‘â€ğŸ’¼</div>
                            <div class="sprite-name" id="player-sprite-name"></div>
                        </div>
                        <div id="rpg-npc-layer"></div>
                    </div>
                    <div id="interaction-hint">
                        <span class="hint-key">ENTER</span>
                        <span class="hint-action-icon" id="interaction-icon">ğŸ’¬</span>
                        <span class="hint-text" id="interaction-text">Interagieren</span>
                    </div>
                </div>

                <!-- MESSAGE BOX -->
                <div id="rpg-msg-box">
                    <div class="msg-portrait-frame">
                        <div class="msg-portrait" id="msg-portrait"></div>
                    </div>
                    <div class="msg-content">
                        <div class="msg-speaker" id="msg-speaker"></div>
                        <div class="msg-text-container">
                            <div class="msg-choice" id="msg-choice" aria-hidden="true"></div>
                            <div class="msg-text" id="msg-text"></div>
                        </div>
                    </div>
                    <div class="msg-continue">
                        <span class="continue-icon">â–¼</span>
                        <span>ENTER</span>
                    </div>
                </div>
            </div>

            <!-- MENU SCREEN -->
            <div id="rpg-menu-screen" class="rpg-screen">
                <div class="menu-overlay" onclick="closeMenu()"></div>
                <div class="menu-window">
                    <div class="menu-header">
                        <div class="menu-toast" id="menu-toast"></div>
                        <span class="menu-title">ğŸ“‹ HAUPTMENÃœ</span>
                        <button class="menu-close" onclick="closeMenu()">âœ•</button>
                    </div>
                    <div class="menu-body">
                        <div class="menu-tabs">
                            <button class="menu-tab active" data-tab="status">ğŸ‘¤ Status</button>
                            <button class="menu-tab" data-tab="inventory">ğŸ’ Items</button>
                            <button class="menu-tab" data-tab="team">ğŸ‘¥ Team</button>
                            <button class="menu-tab" data-tab="map">ğŸ—ºï¸ Karte</button>
                        </div>
                        <div class="menu-tab-content active" id="tab-status">
                            <div class="menu-player-card">
                                <div class="player-card-left">
                                    <div class="menu-portrait-large" id="menu-portrait">ğŸ§‘â€ğŸ’¼</div>
                                    <div class="menu-player-name" id="menu-player-name">HELD</div>
                                    <div class="menu-player-title" id="menu-player-title">Azubi - Einkauf</div>
                                </div>
                                <div class="player-card-right">
                                    <div class="stat-grid">
                                        <div class="stat-item"><span class="stat-icon">ğŸ“Š</span><span
                                                class="stat-label">Level</span><span class="stat-value"
                                                id="menu-lvl">1</span></div>
                                        <div class="stat-item"><span class="stat-icon">â¤ï¸</span><span
                                                class="stat-label">HP</span><span class="stat-value"
                                                id="menu-hp">100/100</span></div>
                                        <div class="stat-item"><span class="stat-icon">â˜•</span><span
                                                class="stat-label">MP</span><span class="stat-value"
                                                id="menu-mp">10/10</span></div>
                                        <div class="stat-item"><span class="stat-icon">âš”ï¸</span><span
                                                class="stat-label">Angriff</span><span class="stat-value"
                                                id="menu-atk">10</span></div>
                                        <div class="stat-item"><span class="stat-icon">ğŸ›¡ï¸</span><span
                                                class="stat-label">Verteidigung</span><span class="stat-value"
                                                id="menu-def">2</span></div>
                                        <div class="stat-item"><span class="stat-icon">ğŸ’°</span><span
                                                class="stat-label">Gold</span><span class="stat-value"
                                                id="menu-gold">50</span></div>
                                    </div>
                                    <div class="exp-display">
                                        <div class="exp-label">â­ Erfahrung</div>
                                        <div class="exp-bar-large">
                                            <div class="exp-fill-large" id="menu-exp-bar"></div>
                                        </div>
                                        <div class="exp-text" id="menu-exp">0 / 30</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="menu-tab-content" id="tab-inventory">
                            <div class="menu-inventory" id="menu-inventory"></div>
                        </div>
                        <div class="menu-tab-content" id="tab-team">
                            <div class="team-grid" id="team-grid"></div>
                        </div>
                        <div class="menu-tab-content" id="tab-map">
                            <div class="world-map" id="world-map"></div>
                        </div>
                    </div>
                    <div class="menu-footer">
                        <button class="menu-btn save" onclick="saveGame()"><span>ğŸ’¾</span> Speichern</button>
                        <button class="menu-btn load" onclick="loadGame()"><span>ğŸ“‚</span> Laden</button>
                        <button class="menu-btn" onclick="closeMenu()"><span>â†©ï¸</span> ZurÃ¼ck</button>
                        <button class="menu-btn danger" onclick="showQuitOptions()"><span>ğŸšª</span> Beenden</button>
                    </div>
                </div>
            </div>

            <!-- BATTLE SCREEN -->
            <div id="rpg-battle-screen" class="rpg-screen">
                <!-- Battle Transition IN -->
                <div id="battle-transition-in">
                    <div class="bt-stripe" style="--i:0"></div>
                    <div class="bt-stripe" style="--i:1"></div>
                    <div class="bt-stripe" style="--i:2"></div>
                    <div class="bt-stripe" style="--i:3"></div>
                    <div class="bt-stripe" style="--i:4"></div>
                    <div class="bt-stripe" style="--i:5"></div>
                    <div class="bt-stripe" style="--i:6"></div>
                    <div class="bt-stripe" style="--i:7"></div>
                    <div class="bt-flash"></div>
                </div>

                <!-- Battle Transition OUT -->
                <div id="battle-transition-out">
                    <div class="bt-out-top"></div>
                    <div class="bt-out-bottom"></div>
                    <div class="bt-out-content">
                        <div class="bt-out-icon">âš”ï¸</div>
                        <div class="bt-out-text">Kampf beendet!</div>
                    </div>
                </div>

                <!-- Battle BG -->
                <div id="battle-bg">
                    <div class="battle-bg-layer bg-layer-1"></div>
                    <div class="battle-bg-layer bg-layer-2"></div>
                    <div class="battle-bg-floor"></div>
                    <div class="battle-fog fog-1"></div>
                    <div class="battle-fog fog-2"></div>
                    <div class="battle-particles"></div>
                </div>

                <!-- VS Splash -->
                <div id="battle-vs-splash">
                    <div class="vs-bg-effect"></div>
                    <div class="vs-content">
                        <div class="vs-fighter vs-player">
                            <div class="vs-fighter-bg"></div>
                            <div class="vs-sprite-wrapper">
                                <div class="vs-sprite" id="vs-player-sprite">ğŸ§‘â€ğŸ’¼</div>
                                <div class="vs-glow"></div>
                            </div>
                            <div class="vs-info">
                                <div class="vs-name" id="vs-player-name">HELD</div>
                                <div class="vs-title">Azubi</div>
                            </div>
                        </div>
                        <div class="vs-middle">
                            <div class="vs-spark spark-1">âš¡</div>
                            <div class="vs-text">VS</div>
                            <div class="vs-spark spark-2">âš¡</div>
                            <div class="vs-clash-effect"></div>
                        </div>
                        <div class="vs-fighter vs-enemy">
                            <div class="vs-fighter-bg enemy"></div>
                            <div class="vs-sprite-wrapper">
                                <div class="vs-sprite" id="vs-enemy-sprite">ğŸ‘¾</div>
                                <div class="vs-glow enemy"></div>
                            </div>
                            <div class="vs-info">
                                <div class="vs-name" id="vs-enemy-name">GEGNER</div>
                                <div class="vs-title enemy">Feind</div>
                            </div>
                        </div>
                    </div>
                    <div id="vs-message" class="vs-message"></div>
                    <div id="boss-vs-banner" class="boss-vs-banner"></div>
                </div>

                <!-- Turn Indicator -->
                <div id="turn-indicator">
                    <div class="turn-banner">
                        <div class="turn-bg-slide"></div>
                        <div class="turn-content">
                            <span class="turn-icon" id="turn-icon">âš”ï¸</span>
                            <span class="turn-text" id="turn-text">Dein Zug!</span>
                        </div>
                    </div>
                </div>

                <!-- Enemy Area -->
                <div id="battle-enemy-area">
                    <div id="battle-enemy-hud">
                        <div class="enemy-hud-inner">
                            <div class="enemy-name" id="battle-enemy-name">Gegner</div>
                            <div class="enemy-hp-container">
                                <div class="enemy-hp-bar">
                                    <div class="hp-fill" id="battle-enemy-hp-fill"></div>
                                </div>
                                <div class="enemy-hp-text" id="battle-enemy-hp-text">100/100</div>
                            </div>
                        </div>
                    </div>
                    <div id="battle-enemy-sprite-container">
                        <div id="battle-enemy-sprite">ğŸ‘¾</div>
                        <div id="battle-enemy-shadow"></div>
                    </div>
                    <div id="battle-dmg-enemy"></div>
                    <div id="battle-effect-enemy"></div>
                </div>

                <!-- Player Area -->
                <div id="battle-player-area">
                    <div id="battle-player-platform"></div>
                    <div id="battle-player-sprite">ğŸ§‘â€ğŸ’¼</div>
                    <div id="battle-dmg-player"></div>
                    <div id="battle-effect-player"></div>
                </div>

                <!-- Battle UI -->
                <div id="battle-ui">
                    <div id="battle-player-hud">
                        <div class="battle-hud-frame">
                            <div class="player-portrait-battle" id="battle-portrait">ğŸ§‘â€ğŸ’¼</div>
                            <div class="player-info-battle">
                                <div class="player-name-battle" id="battle-player-name">HELD</div>
                                <div class="player-bars-battle">
                                    <div class="p-bar hp">
                                        <span class="p-bar-label">HP</span>
                                        <div class="p-bar-track">
                                            <div class="p-bar-fill" id="battle-hp-fill"></div>
                                        </div>
                                        <span class="p-bar-text" id="battle-hp-text">100/100</span>
                                    </div>
                                    <div class="p-bar mp">
                                        <span class="p-bar-label">â˜•</span>
                                        <div class="p-bar-track">
                                            <div class="p-bar-fill" id="battle-mp-fill"></div>
                                        </div>
                                        <span class="p-bar-text" id="battle-mp-text">10/10</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="battle-log">
                        <div class="log-content" id="battle-log-text"></div>
                    </div>

                    <div id="battle-menu">
                        <div class="battle-cmd" data-cmd="attack"><span class="cmd-icon">âš”ï¸</span><span
                                class="cmd-text">Angriff</span></div>
                        <div class="battle-cmd" data-cmd="skill"><span class="cmd-icon">ğŸ“</span><span
                                class="cmd-text">Skill</span></div>
                        <div class="battle-cmd" data-cmd="item"><span class="cmd-icon">ğŸ’</span><span
                                class="cmd-text">Item</span></div>
                        <div class="battle-cmd" data-cmd="run"><span class="cmd-icon">ğŸšª</span><span
                                class="cmd-text">Flucht</span></div>
                    </div>
                </div>

                <!-- Skill Menu -->
                <div id="battle-skill-menu" class="battle-submenu">
                    <div class="submenu-header">ğŸ“ Skills</div>
                    <div id="battle-skill-list"></div>
                    <button class="submenu-back" onclick="closeSkillMenu()">â† ZurÃ¼ck</button>
                </div>

                <!-- Item Menu -->
                <div id="battle-item-menu" class="battle-submenu">
                    <div class="submenu-header">ğŸ’ Items</div>
                    <div id="battle-item-list"></div>
                    <button class="submenu-back" onclick="closeItemMenu()">â† ZurÃ¼ck</button>
                </div>

                <!-- Victory Screen -->
                <div id="victory-screen">
                    <div class="victory-bg"></div>
                    <div class="victory-content">
                        <div class="victory-stars">â­ â­ â­</div>
                        <div class="victory-title">ğŸ† SIEG!</div>
                        <div class="victory-subtitle">Kampf gewonnen!</div>
                        <div class="victory-rewards">
                            <div class="reward-item gold"><span class="reward-icon">ğŸ’°</span><span
                                    class="reward-text">+<span id="victory-gold">0</span> Gold</span></div>
                            <div class="reward-item exp"><span class="reward-icon">â­</span><span
                                    class="reward-text">+<span id="victory-exp">0</span> EXP</span></div>
                        </div>
                        <div id="xp-bar-container">
                            <div class="xp-bar-label">Erfahrung</div>
                            <div class="xp-bar-bg">
                                <div class="xp-bar-fill" id="xp-bar-fill"></div>
                            </div>
                            <div class="xp-bar-text"><span id="xp-current">0</span> / <span id="xp-max">100</span></div>
                        </div>
                        <div id="levelup-display">
                            <div class="levelup-text">ğŸ‰ LEVEL UP!</div>
                            <div class="levelup-transition">
                                <span class="old-level">Lvl <span id="old-level">1</span></span>
                                <span class="level-arrow">â†’</span>
                                <span class="new-level">Lvl <span id="new-level">2</span></span>
                            </div>
                        </div>
                        <div id="victory-chest" class="chest-container">
                            <div class="chest-icon">ğŸ“¦</div>
                            <div class="chest-text">Truhe gefunden!</div>
                            <div class="chest-item" id="chest-item"></div>
                        </div>
                        <button class="victory-btn" onclick="endVictory()"><span>Weiter</span><span
                                class="btn-arrow">â†’</span></button>
                    </div>
                </div>

                <!-- Defeat Screen -->
                <div id="defeat-screen">
                    <div class="defeat-bg"></div>
                    <div class="defeat-content">
                        <div class="defeat-icon">ğŸ’€</div>
                        <div class="defeat-title">NIEDERLAGE</div>
                        <div class="defeat-text">Du wurdest besiegt...</div>
                        <div class="defeat-penalty">-20 Gold</div>
                        <button class="defeat-btn" onclick="respawnPlayer()"><span>Aufstehen</span></button>
                    </div>
                </div>
            </div>

            <!-- SHOP SCREEN -->
            <div id="rpg-shop-screen" class="rpg-screen">
                <div class="shop-bg">
                    <div class="shop-particles"></div>
                </div>
                <div class="shop-container">
                    <div class="shop-header">
                        <div class="shop-keeper-area">
                            <div class="shop-keeper-sprite">ğŸ›’</div>
                            <div class="shop-keeper-dialog">
                                <span class="keeper-name">HÃ¤ndler Hans</span>
                                <span class="keeper-text" id="shop-keeper-text">"Willkommen!"</span>
                            </div>
                        </div>
                        <div class="shop-player-gold"><span class="gold-coin">ğŸ’°</span><span id="shop-gold">50</span>
                        </div>
                    </div>
                    <div class="shop-items" id="shop-items"></div>
                    <button class="shop-exit-btn" onclick="closeShop()">ğŸšª Verlassen</button>
                </div>
            </div>

            <!-- SKILL SHOP SCREEN -->
            <div id="rpg-skillshop-screen" class="rpg-screen">
                <div class="shop-bg">
                    <div class="shop-particles"></div>
                </div>
                <div class="shop-container">
                    <div class="shop-header">
                        <div class="shop-keeper-area">
                            <div class="shop-keeper-sprite">ğŸ“š</div>
                            <div class="shop-keeper-dialog">
                                <span class="keeper-name">Meister Markus</span>
                                <span class="keeper-text" id="skillshop-keeper-text">"Willkommen zum Skill-Training!"</span>
                            </div>
                        </div>
                        <div class="shop-player-gold"><span class="gold-coin">ğŸ’°</span><span id="skillshop-gold">50</span>
                        </div>
                    </div>
                    <div class="shop-items" id="skillshop-items"></div>
                    <button class="shop-exit-btn" onclick="closeSkillShop()">ğŸšª Verlassen</button>
                </div>
            </div>

            <!-- ENDING SCREEN -->
            <div id="rpg-ending-screen" class="rpg-screen">
                <div class="ending-bg">
                    <div class="ending-stars"></div>
                    <div class="ending-nebula"></div>
                    <div class="ending-lightrays"></div>
                    <div class="ending-particles"></div>
                    <div class="ending-confetti"></div>
                </div>
                <div class="ending-content">
                    <div class="ending-trophy-container">
                        <div class="ending-trophy">ğŸ†</div>
                        <div class="ending-glow"></div>
                        <div class="ending-sparkles">âœ¨</div>
                    </div>
                    <h1 class="ending-title">GLÃœCKWUNSCH!</h1>
                    <div class="ending-subtitle">Du hast BÃ¼roVersum abgeschlossen!</div>
                    <div class="ending-stats-container">
                        <div class="ending-stats">
                            <div class="ending-stat"><span class="stat-label">ğŸ‘¤ Spieler:</span> <span
                                    id="ending-name">HELD</span></div>
                            <div class="ending-stat"><span class="stat-label">ğŸ“Š Level:</span> <span id="ending-level">1</span>
                            </div>
                            <div class="ending-stat"><span class="stat-label">ğŸ’° Gold:</span> <span id="ending-gold">0</span>
                            </div>
                            <div class="ending-stat"><span class="stat-label">âš”ï¸ KÃ¤mpfe:</span> <span
                                    id="ending-battles">0</span></div>
                            <div class="ending-stat"><span class="stat-label">ğŸ“¦ Kisten:</span> <span
                                    id="ending-chests">0</span></div>
                        </div>
                    </div>
                    <div class="ending-credits">
                        <p>ğŸ® Entwickelt von Justin</p>
                        <p>Â© 2026 BÃ¼roVersum GmbH.</p>
                    </div>
                    <div class="ending-buttons">
                        <button class="ending-btn ending-btn-primary" onclick="returnToTitleMenu()">ğŸ  ZurÃ¼ck zum TitlemenÃ¼</button>
                        <button class="ending-btn ending-btn-secondary" onclick="closeRPG()">ğŸšª Spiel Beenden</button>
                    </div>
                </div>
            </div>

            <!-- MOBILE CONTROLS (Verbessert) -->
            <div id="rpg-touch-controls">
                <div class="touch-dpad">
                    <button class="dpad-btn up" data-dir="up">â–²</button>
                    <button class="dpad-btn left" data-dir="left">â—€</button>
                    <button class="dpad-btn center" data-dir="ok">â—</button>
                    <button class="dpad-btn right" data-dir="right">â–¶</button>
                    <button class="dpad-btn down" data-dir="down">â–¼</button>
                </div>
                <div class="touch-actions">
                    <button class="touch-action-btn" onclick="openMenu()">â˜°</button>
                    <button class="touch-action-btn cheat" onclick="toggleCheatConsole()">ğŸ®</button>
                </div>
            </div>
        </div>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&family=Press+Start+2P&display=swap');

        :root {
            --primary: #4a9fff;
            --primary-dark: #1a3a6f;
            --primary-light: #8cf;
            --gold: #ffd700;
            --hp-color: #ff4444;
            --mp-color: #aa8844;
            --success: #44ff88;
            --danger: #ff4444;
            --bg-dark: #0a0a1a;
            --bg-medium: #12122a;
            --bg-light: #1a2a4a;
            --game-width: 900px;
            --game-height: 680px;
            --tile-size: 32px;
            --viewport-width: 864px;
            --viewport-height: 544px;
        }

        /* Twemoji Konsistenz */
        img.emoji {
            height: 1em;
            width: 1em;
            margin: 0 .05em 0 .1em;
            vertical-align: -0.1em;
            display: inline-block;
        }

        /* ===== WIDGET (unverÃ¤ndert) ===== */
        #zuef-main-wrapper {
            width: 100%;
            display: flex;
            justify-content: center;
            padding: 0 0 50px;
            font-family: 'Segoe UI', sans-serif;
        }

        .zuef-centered-col {
            width: 100%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            align-items: center;
            perspective: 1000px;
        }

        .zuef-premium-card {
            width: 100%;
            margin-bottom: 25px;
            cursor: pointer;
            transform-style: preserve-3d;
            transition: transform 0.1s;
        }

        .zuef-card-body {
            background: #fff;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.12);
            position: relative;
        }

        .zuef-promo-img {
            width: 100%;
            display: block;
            transition: transform 0.5s;
        }

        .zuef-premium-card:hover .zuef-promo-img {
            transform: scale(1.05);
        }

        .zuef-status-badge {
            position: absolute;
            top: 12px;
            left: 12px;
            background: rgba(255, 255, 255, 0.95);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 5px;
            z-index: 10;
        }

        .zuef-live-dot {
            width: 8px;
            height: 8px;
            background: #00cc66;
            border-radius: 50%;
            animation: pulseDot 2s infinite;
        }

        @keyframes pulseDot {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(0, 204, 102, 0.6)
            }

            50% {
                box-shadow: 0 0 0 6px rgba(0, 204, 102, 0)
            }
        }

        .zuef-spotlight-effect {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at var(--mx, 50%) var(--my, 50%), rgba(255, 255, 255, 0.25) 0%, transparent 60%);
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 5;
        }

        .zuef-premium-card:hover .zuef-spotlight-effect {
            opacity: 1;
        }

        .zuef-shine-sweep {
            position: absolute;
            top: 0;
            left: -100%;
            width: 60%;
            height: 100%;
            background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.3), transparent);
            transform: skewX(-25deg);
            z-index: 6;
            pointer-events: none;
            animation: shineSweep 6s infinite;
        }

        @keyframes shineSweep {
            0% {
                left: -100%
            }

            15% {
                left: 200%
            }

            100% {
                left: 200%
            }
        }

        .zuef-info-section {
            text-align: center;
            width: 100%;
        }

        .zuef-main-title {
            color: #000;
            font-size: 1.4rem;
            margin: 0 0 15px;
            font-weight: 700;
        }

        .zuef-accent-date {
            color: #0066ff;
            border-bottom: 2px solid #0066ff;
        }

        .zuef-countdown-row {
            display: flex;
            justify-content: center;
            gap: 12px;
            background: #fff;
            padding: 15px 25px;
            border-radius: 12px;
            border: 1px solid #eee;
        }

        .zuef-time-block {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 45px;
        }

        .zuef-num {
            font-size: 1.8rem;
            font-weight: 300;
        }

        .zuef-label {
            font-size: 0.6rem;
            text-transform: uppercase;
            color: #888;
            margin-top: 3px;
            font-weight: 700;
        }

        .zuef-divider-line {
            width: 1px;
            height: 30px;
            background: #eee;
        }

        /* ===== RPG OVERLAY ===== */
        #rpg-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0);
            z-index: 99999;
            display: none;
            justify-content: center;
            align-items: center;
            transition: background 0.5s;
        }

        #rpg-overlay.opening {
            display: flex;
        }

        #rpg-overlay.open {
            display: flex;
            background: rgba(0, 0, 0, 0.92);
        }

        #rpg-overlay.closing {
            display: flex;
            background: rgba(0, 0, 0, 0);
        }

        body.rpg-active {
            overflow: hidden !important;
        }

        /* ===== CLOSE BUTTON ===== */
        #rpg-close-btn {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 100010;
            width: 50px;
            height: 50px;
            background: rgba(0, 0, 0, 0.8);
            border: 3px solid #f44;
            color: #ff6666;
            font-size: 1.8rem;
            border-radius: 50%;
            cursor: pointer;
            opacity: 0;
            transition: all 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 0 20px rgba(255, 68, 68, 0.3);
        }

        #rpg-overlay.open #rpg-close-btn {
            opacity: 1;
        }

        #rpg-close-btn:hover {
            background: rgba(255, 0, 0, 0.4);
            transform: rotate(90deg) scale(1.1);
        }

        /* ===== CHEAT CONSOLE ===== */
        #cheat-console {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 350px;
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid var(--primary);
            border-radius: 10px;
            z-index: 100020;
            display: none;
            flex-direction: column;
            font-family: 'VT323', monospace;
            box-shadow: 0 0 30px rgba(74, 159, 255, 0.3);
        }

        #cheat-console.visible {
            display: flex;
            animation: cheatSlide 0.3s;
        }

        @keyframes cheatSlide {
            from {
                transform: translateY(20px);
                opacity: 0
            }

            to {
                transform: translateY(0);
                opacity: 1
            }
        }

        .cheat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: var(--primary-dark);
            border-bottom: 1px solid var(--primary);
            color: #fff;
            font-size: 1rem;
        }

        .cheat-header button {
            background: none;
            border: none;
            color: #f66;
            font-size: 1.2rem;
            cursor: pointer;
        }

        .cheat-log {
            height: 150px;
            overflow-y: auto;
            padding: 8px;
            font-size: 0.9rem;
            color: #0f0;
            background: #000;
        }

        .cheat-log .error {
            color: #f44;
        }

        .cheat-log .success {
            color: #4f8;
        }

        .cheat-log .info {
            color: #4af;
        }

        #cheat-input {
            padding: 10px;
            background: #111;
            border: none;
            border-top: 1px solid #333;
            color: #0f0;
            font-family: 'VT323', monospace;
            font-size: 1.1rem;
            outline: none;
        }

        #cheat-input::placeholder {
            color: #555;
        }

        .cheat-hints {
            padding: 6px 10px;
            background: #0a0a0a;
            color: #555;
            font-size: 0.75rem;
        }

        /* ===== SPLASH SCREEN ===== */
        .rpg-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100000;
        }

        #rpg-splash.active {
            display: flex;
            animation: fadeIn 0.8s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0
            }

            to {
                opacity: 1
            }
        }

        .splash-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3a 50%, #0a1a2a 100%);
        }

        .splash-particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
        }

        .splash-particles::before,
        .splash-particles::after {
            content: '';
            position: absolute;
            width: 4px;
            height: 4px;
            background: #4af;
            border-radius: 50%;
            box-shadow: 100px 50px 0 #4af, 200px 150px 0 #f4a, 300px 80px 0 #4af, 50px 200px 0 #ff0, 400px 100px 0 #4af, 150px 300px 0 #f4a, 500px 200px 0 #4af, 250px 50px 0 #ff0;
            animation: floatStars 20s linear infinite;
        }

        @keyframes floatStars {
            0% {
                transform: translateY(0)
            }

            100% {
                transform: translateY(-100vh)
            }
        }

        .splash-grid {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: linear-gradient(rgba(74, 159, 255, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(74, 159, 255, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            animation: gridMove 20s linear infinite;
        }

        @keyframes gridMove {
            0% {
                transform: translate(0, 0)
            }

            100% {
                transform: translate(40px, 40px)
            }
        }

        .splash-content {
            position: relative;
            z-index: 1;
            text-align: center;
            font-family: 'Press Start 2P', monospace;
            color: #fff;
        }

        .splash-logo {
            position: relative;
            margin-bottom: 20px;
        }

        .splash-icon {
            font-size: 6rem;
            animation: iconFloat 3s ease-in-out infinite;
            filter: drop-shadow(0 0 30px rgba(74, 159, 255, 0.5));
            position: relative;
            z-index: 2;
        }

        .splash-icon-glow {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 150px;
            height: 150px;
            background: radial-gradient(circle, rgba(74, 159, 255, 0.4) 0%, transparent 70%);
            border-radius: 50%;
            animation: glowPulse 2s ease-in-out infinite;
        }

        @keyframes glowPulse {

            0%,
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 0.5
            }

            50% {
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 1
            }
        }

        @keyframes iconFloat {

            0%,
            100% {
                transform: translateY(0) scale(1)
            }

            50% {
                transform: translateY(-15px) scale(1.05)
            }
        }

        .splash-title {
            font-size: 2.5rem;
            margin: 0;
            display: flex;
            justify-content: center;
            gap: 2px;
        }

        .title-letter {
            display: inline-block;
            color: #4af;
            text-shadow: 0 0 20px #4af, 0 0 40px #4af;
            animation: letterWave 2s ease-in-out infinite;
            animation-delay: calc(var(--i) * 0.1s);
        }

        @keyframes letterWave {

            0%,
            100% {
                transform: translateY(0)
            }

            50% {
                transform: translateY(-10px)
            }
        }

        .splash-subtitle {
            font-size: 0.6rem;
            color: #888;
            margin-top: 10px;
            letter-spacing: 5px;
        }

        .splash-version {
            font-size: 0.5rem;
            color: #555;
            margin-top: 5px;
        }

        .splash-credits {
            font-size: 0.5rem;
            color: var(--primary);
            margin-top: 5px;
            animation: blinkSlow 2s infinite;
        }

        @keyframes blinkSlow {

            0%,
            100% {
                opacity: 1
            }

            50% {
                opacity: 0.3
            }
        }

        .splash-loader-container {
            width: 280px;
            margin: 40px auto 0;
            position: relative;
        }

        .splash-loader-bar {
            width: 0%;
            height: 12px;
            background: linear-gradient(90deg, #4af, #f4a, #4af);
            background-size: 200% 100%;
            border-radius: 6px;
            animation: loadBar 2.5s forwards, shimmer 1s infinite;
            box-shadow: 0 0 20px rgba(74, 159, 255, 0.5);
        }

        .splash-loader-text {
            font-size: 0.5rem;
            color: #888;
            margin-top: 8px;
        }

        @keyframes loadBar {
            to {
                width: 100%
            }
        }

        @keyframes shimmer {
            from {
                background-position: 200% 0
            }

            to {
                background-position: -200% 0
            }
        }

        /* MOBILE START BUTTON */
        .splash-start-btn {
            margin: 30px auto 0;
            padding: 15px 40px;
            background: linear-gradient(180deg, var(--primary), var(--primary-dark));
            border: 3px solid var(--primary-light);
            border-radius: 12px;
            color: #fff;
            font-family: 'Press Start 2P', monospace;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
            animation: pulseBtn 2s infinite;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .splash-start-btn:hover,
        .splash-start-btn:active {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(74, 159, 255, 0.5);
        }

        @keyframes pulseBtn {

            0%,
            100% {
                box-shadow: 0 0 10px rgba(74, 159, 255, 0.3)
            }

            50% {
                box-shadow: 0 0 25px rgba(74, 159, 255, 0.6)
            }
        }

        .splash-press {
            margin-top: 20px;
            font-size: 0.7rem;
            color: #4af;
            animation: pressAnim 2s infinite;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .desktop-only {
            display: flex;
        }

        @media (max-width:920px),
        (pointer:coarse) {
            .desktop-only {
                display: none !important;
            }

            .splash-start-btn {
                display: flex !important;
            }
        }

        @media (min-width:921px) and (pointer:fine) {
            .splash-start-btn {
                display: none;
            }
        }

        /* ===== MAP TRANSITION ===== */
        #map-transition {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 100001;
            display: none;
            justify-content: center;
            align-items: center;
            pointer-events: none;
        }

        #map-transition.active {
            display: flex;
            pointer-events: all;
        }

        .transition-overlay {
            position: absolute;
            left: 0;
            width: 100%;
            height: 55%;
            background: #000;
        }

        .transition-overlay.top {
            top: -55%;
        }

        .transition-overlay.bottom {
            bottom: -55%;
        }

        #map-transition.active .transition-overlay.top {
            animation: transSlideDown 0.4s ease-out forwards, transSlideUp 0.4s 1s ease-in forwards;
        }

        #map-transition.active .transition-overlay.bottom {
            animation: transSlideUp2 0.4s ease-out forwards, transSlideDown2 0.4s 1s ease-in forwards;
        }

        @keyframes transSlideDown {
            to {
                top: 0
            }
        }

        @keyframes transSlideUp {
            to {
                top: -55%
            }
        }

        @keyframes transSlideUp2 {
            to {
                bottom: 0
            }
        }

        @keyframes transSlideDown2 {
            to {
                bottom: -55%
            }
        }

        .transition-content {
            position: relative;
            z-index: 10;
            text-align: center;
            opacity: 0;
        }

        #map-transition.active .transition-content {
            animation: transContentFade 1.4s ease-in-out;
        }

        #map-transition.active.no-content .transition-content {
            animation: none !important;
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }

        @keyframes transContentFade {
            0% {
                opacity: 0;
                transform: scale(0.8)
            }

            30% {
                opacity: 1;
                transform: scale(1)
            }

            70% {
                opacity: 1;
                transform: scale(1)
            }

            100% {
                opacity: 0;
                transform: scale(0.8)
            }
        }

        .transition-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .transition-text {
            font-family: 'VT323', monospace;
            font-size: 2.5rem;
            color: #fff;
            text-shadow: 0 0 20px var(--primary);
        }

        .transition-dots {
            font-size: 2rem;
            color: #fff;
        }

        .transition-dots span {
            opacity: 0;
            animation: dotBlink 1.5s infinite;
        }

        .transition-dots span:nth-child(1) {
            animation-delay: 0s;
        }

        .transition-dots span:nth-child(2) {
            animation-delay: 0.3s;
        }

        .transition-dots span:nth-child(3) {
            animation-delay: 0.6s;
        }

        @keyframes dotBlink {

            0%,
            100% {
                opacity: 0
            }

            50% {
                opacity: 1
            }
        }

        #map-transition.no-content .transition-content {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }

        #map-transition.battle-hold .transition-overlay.top {
            animation: transSlideDown 0.5s ease-out forwards !important;
            z-index: 999999 !important;
            opacity: 1 !important;
            visibility: visible !important;
            display: block !important;
        }

        #map-transition.battle-hold .transition-overlay.bottom {
            animation: transSlideUp2 0.5s ease-out forwards !important;
            z-index: 999999 !important;
            opacity: 1 !important;
            visibility: visible !important;
            display: block !important;
        }

        /* Immediate opening classes for battle transitions */
        #map-transition.opening .transition-overlay.top {
            animation: transSlideUp 0.4s 0s ease-in forwards !important;
        }

        #map-transition.opening .transition-overlay.bottom {
            animation: transSlideDown2 0.4s 0s ease-in forwards !important;
        }

        /* ===== BATTLE PANELS ===== */
        #battle-panels {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 100000;
            pointer-events: none;
            display: none;
        }

        #battle-panels.active {
            display: block;
            pointer-events: all;
        }

        .battle-panel {
            position: absolute;
            left: 0;
            width: 100%;
            height: 55%;
            background: #000;
        }

        .battle-panel.top {
            top: -55%;
        }

        .battle-panel.bottom {
            bottom: -55%;
        }

        /* Opening animation: Panels slide into view */
        #battle-panels.open .battle-panel.top {
            animation: battlePanelTopOpen 0.6s ease-out forwards;
        }

        #battle-panels.open .battle-panel.bottom {
            animation: battlePanelBottomOpen 0.6s ease-out forwards;
        }

        @keyframes battlePanelTopOpen {
            from {
                top: -55%;
            }
            to {
                top: 0;
            }
        }

        @keyframes battlePanelBottomOpen {
            from {
                bottom: -55%;
            }
            to {
                bottom: 0;
            }
        }

        /* Closing animation: Panels slide out */
        #battle-panels.close .battle-panel.top {
            animation: battlePanelTopClose 0.6s ease-in forwards;
        }

        #battle-panels.close .battle-panel.bottom {
            animation: battlePanelBottomClose 0.6s ease-in forwards;
        }

        @keyframes battlePanelTopClose {
            from {
                top: 0;
            }
            to {
                top: -55%;
            }
        }

        @keyframes battlePanelBottomClose {
            from {
                bottom: 0;
            }
            to {
                bottom: -55%;
            }
        }

        /* ===== TITLE MENU SCREEN ===== */
        .title-screen-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f3460 0%, #1a1a2e 50%, #16213e 100%);
            overflow: hidden;
        }

        .title-particles {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0.3;
        }

        .title-particles::before {
            content: '';
            position: absolute;
            width: 300%;
            height: 300%;
            background: radial-gradient(circle, rgba(74, 159, 255, 0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: particleShift 20s linear infinite;
        }

        @keyframes particleShift {
            to {
                transform: translate(100px, 100px)
            }
        }

        .title-grid {
            position: absolute;
            width: 100%;
            height: 100%;
            background:
                linear-gradient(0deg, transparent 24%, rgba(74, 159, 255, 0.05) 25%, rgba(74, 159, 255, 0.05) 26%, transparent 27%, transparent 74%, rgba(74, 159, 255, 0.05) 75%, rgba(74, 159, 255, 0.05) 76%, transparent 77%, transparent),
                linear-gradient(90deg, transparent 24%, rgba(74, 159, 255, 0.05) 25%, rgba(74, 159, 255, 0.05) 26%, transparent 27%, transparent 74%, rgba(74, 159, 255, 0.05) 75%, rgba(74, 159, 255, 0.05) 76%, transparent 77%, transparent);
            background-size: 50px 50px;
        }

        .title-screen-content {
            position: relative;
            z-index: 10;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .title-menu {
            text-align: center;
            animation: titleMenuSlide 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        @keyframes titleMenuSlide {
            from {
                opacity: 0;
                transform: scale(0.8)
            }

            to {
                opacity: 1;
                transform: scale(1)
            }
        }

        .title-logo {
            margin-bottom: 60px;
        }

        .title-icon {
            font-size: 4rem;
            display: block;
            margin-bottom: 20px;
            animation: titleIconBounce 2s ease-in-out infinite;
        }

        @keyframes titleIconBounce {

            0%,
            100% {
                transform: translateY(0)
            }

            50% {
                transform: translateY(-20px)
            }
        }

        .title-logo h1 {
            font-size: 3.5rem;
            color: #4a9fff;
            margin: 0;
            text-shadow: 0 0 20px rgba(74, 159, 255, 0.5);
            font-weight: bold;
        }

        .title-logo p {
            font-size: 1.2rem;
            color: #aaa;
            margin: 5px 0 0 0;
            letter-spacing: 2px;
        }

        .title-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .title-btn {
            padding: 15px 40px;
            font-size: 1.3rem;
            background: linear-gradient(135deg, #4a9fff 0%, #1e88e5 100%);
            color: #fff;
            border: 3px solid #2a6fff;
            border-radius: 10px;
            cursor: pointer;
            font-family: 'VT323', monospace;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-width: 300px;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            box-shadow: 0 5px 15px rgba(74, 159, 255, 0.3);
        }

        .title-btn:hover {
            background: linear-gradient(135deg, #5aa9ff 0%, #2e98f5 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(74, 159, 255, 0.5);
        }

        .title-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(74, 159, 255, 0.3);
        }

        .title-btn .btn-icon {
            font-size: 1.5rem;
        }

        /* ===== CHANGELOG BUTTON ===== */
        .changelog-btn {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #4a9fff 0%, #1e88e5 100%);
            border: 3px solid #2a6fff;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(74, 159, 255, 0.3);
            z-index: 100;
        }

        .changelog-btn:hover {
            background: linear-gradient(135deg, #5aa9ff 0%, #2e98f5 100%);
            transform: scale(1.1);
            box-shadow: 0 8px 20px rgba(74, 159, 255, 0.5);
        }

        .changelog-btn:active {
            transform: scale(0.95);
            box-shadow: 0 2px 10px rgba(74, 159, 255, 0.3);
        }

        .changelog-icon {
            display: block;
        }

        /* ===== CHANGELOG MODAL ===== */
        .changelog-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(3px);
            animation: fadeIn 0.3s ease-out;
        }

        .changelog-modal.active {
            display: flex;
        }

        .changelog-content {
            background: linear-gradient(135deg, #0f3460 0%, #1a1a2e 100%);
            border: 3px solid #4a9fff;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 0 50px rgba(74, 159, 255, 0.3), inset 0 0 50px rgba(0, 0, 0, 0.5);
            font-family: 'VT323', monospace;
        }

        .changelog-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #4a9fff;
        }

        .changelog-header h2 {
            font-size: 1.8rem;
            color: #4a9fff;
            margin: 0;
            text-shadow: 0 0 10px rgba(74, 159, 255, 0.5);
        }

        .changelog-close {
            background: none;
            border: none;
            color: #4a9fff;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .changelog-close:hover {
            color: #fff;
            transform: rotate(90deg);
        }

        .changelog-body {
            color: #aaa;
            font-size: 1rem;
            line-height: 1.6;
        }

        .changelog-version {
            margin-bottom: 25px;
        }

        .changelog-version h3 {
            color: #4a9fff;
            font-size: 1.3rem;
            margin: 0 0 8px 0;
            text-shadow: 0 0 10px rgba(74, 159, 255, 0.3);
        }

        .changelog-date {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 12px;
        }

        .changelog-version ul {
            margin: 10px 0;
            padding-left: 20px;
            list-style: none;
        }

        .changelog-version li {
            margin: 8px 0;
            color: #bbb;
            position: relative;
            padding-left: 15px;
        }

        .changelog-version li:before {
            content: 'â–¸';
            position: absolute;
            left: 0;
            color: #4a9fff;
        }

        .changelog-version li:hover {
            color: #fff;
        }

        /* ===== QUIT MODAL ===== */
        .quit-modal {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1200;
        }

        .quit-content {
            background: linear-gradient(135deg, #0f3460 0%, #16213e 100%);
            border: 2px solid #4a9fff;
            padding: 20px;
            border-radius: 10px;
            width: 320px;
            text-align: center;
            color: #ddd;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
        }

        .quit-content h3 {
            margin: 0 0 8px 0;
            color: #4a9fff;
        }

        .quit-content p {
            margin: 0 0 16px 0;
            color: #bbb;
        }

        .quit-actions {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .quit-btn {
            padding: 8px 12px;
            border-radius: 8px;
            border: 2px solid #2a6fff;
            background: linear-gradient(135deg, #4a9fff, #2e98f5);
            color: #fff;
            cursor: pointer;
        }

        .quit-btn.danger {
            background: linear-gradient(135deg, #ff6b6b, #ff5252);
            border-color: #ff3b3b;
        }

        .quit-btn.secondary {
            background: linear-gradient(135deg, #666, #444);
            border-color: #555;
        }

        /* ===== GAME WINDOW ===== */
        #rpg-game-window {
            width: var(--game-width);
            height: var(--game-height);
            position: relative;
            background: linear-gradient(180deg, var(--bg-medium), var(--bg-dark));
            border: 4px solid var(--primary);
            border-radius: 16px;
            box-shadow: 0 0 100px rgba(74, 159, 255, 0.3), inset 0 0 50px rgba(0, 0, 0, 0.5);
            font-family: 'VT323', monospace;
            color: #fff;
            overflow: hidden;
            opacity: 0;
            transform: scale(0.7) translateY(80px);
            transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        #rpg-overlay.open #rpg-game-window {
            opacity: 1;
            transform: scale(1) translateY(0);
        }

        #rpg-overlay.closing #rpg-game-window {
            opacity: 0;
            transform: scale(0.7) translateY(80px);
        }

        .rpg-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
        }

        .rpg-screen.active {
            display: flex;
        }

        /* ===== VIEWPORT MIT KAMERA ===== */
        #rpg-viewport {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: #1a1a2e;
        }

        #rpg-camera {
            position: absolute;
            will-change: transform;
        }

        #rpg-camera:not(.battle-zoom-in) {
            transition: transform 0.15s ease-out;
        }

        #rpg-canvas {
            position: absolute;
            top: 0;
            left: 0;
            image-rendering: pixelated;
        }

        /* ===== TÃœREN (GrÃ¶ÃŸer & Sichtbarer) ===== */
        .map-door {
            position: absolute;
            width: 48px;
            height: 64px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 15;
        }

        .map-door .door-frame {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, #4a3a2a 0%, #3a2a1a 100%);
            border: 3px solid #2a1a0a;
            border-radius: 6px 6px 0 0;
            box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.5);
        }

        .map-door .door-icon {
            position: relative;
            z-index: 2;
            font-size: 2rem;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
        }

        .map-door .door-label {
            position: absolute;
            bottom: -18px;
            font-size: 0.7rem;
            color: #fff;
            background: rgba(0, 0, 0, 0.7);
            padding: 2px 6px;
            border-radius: 3px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .map-door:hover .door-label {
            opacity: 1;
        }

        .map-door:hover {
            transform: scale(1.1);
            filter: brightness(1.2);
        }

        .map-door.locked {
            filter: grayscale(0.5);
        }

        .map-door.locked::after {
            content: 'ğŸ”’';
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 0.8rem;
        }

        .map-door.boss .door-frame {
            background: linear-gradient(180deg, #6a4a2a 0%, #4a3a1a 100%);
            border-color: var(--gold);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3), inset 0 0 15px rgba(0, 0, 0, 0.5);
        }

        /* ===== KISTEN ===== */
        .map-chest {
            position: absolute;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 12;
        }

        .map-chest .chest-sprite {
            font-size: 1.8rem;
            filter: drop-shadow(2px 2px 2px rgba(0, 0, 0, 0.5));
            transition: transform 0.3s;
        }

        .map-chest:hover .chest-sprite {
            transform: scale(1.2) rotate(5deg);
        }

        .map-chest.opened .chest-sprite {
            filter: grayscale(0.8) opacity(0.5);
        }

        .map-chest .chest-glow {
            position: absolute;
            width: 40px;
            height: 40px;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.4) 0%, transparent 70%);
            border-radius: 50%;
            animation: chestGlow 2s infinite;
        }

        .map-chest.opened .chest-glow {
            display: none;
        }

        @keyframes chestGlow {

            0%,
            100% {
                transform: scale(1);
                opacity: 0.5
            }

            50% {
                transform: scale(1.3);
                opacity: 1
            }
        }

        /* ===== MINIMAP ===== */
        #minimap-container {
            position: absolute;
            top: 70px;
            right: 10px;
            width: 150px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid var(--primary);
            border-radius: 8px;
            padding: 5px;
            z-index: 50;
            display: none;
        }

        #minimap-container.visible {
            display: block;
            animation: minimapFade 0.3s;
        }

        @keyframes minimapFade {
            from {
                opacity: 0;
                transform: translateX(10px)
            }

            to {
                opacity: 1;
                transform: translateX(0)
            }
        }

        #minimap-canvas {
            width: 100%;
            height: 100px;
            border-radius: 4px;
            image-rendering: pixelated;
        }

        .minimap-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
            font-size: 0.6rem;
            color: #aaa;
        }

        .minimap-toggle {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--primary);
            border-radius: 4px;
            padding: 3px 8px;
            color: #fff;
            cursor: pointer;
            font-size: 0.9rem;
            margin-left: 10px;
        }

        /* ===== HUD ===== */
        #rpg-hud {
            height: 65px;
            padding: 8px 15px;
            background: linear-gradient(180deg, #1a3a6e, #0d1f3c);
            border-bottom: 3px solid var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
            z-index: 100;
        }

        .hud-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .hud-portrait-frame {
            position: relative;
        }

        .hud-portrait {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #2a4a7a, #1a2a4a);
            border: 2px solid var(--primary);
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.6rem;
        }

        .hud-level-badge {
            position: absolute;
            bottom: -4px;
            right: -4px;
            background: linear-gradient(135deg, var(--gold), #c9a227);
            color: #000;
            font-size: 0.65rem;
            font-weight: bold;
            padding: 2px 5px;
            border-radius: 6px;
            border: 1px solid #fff;
        }

        .hud-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .hud-name {
            font-size: 1.2rem;
            color: var(--gold);
            text-shadow: 0 0 10px var(--gold);
        }

        .hud-stats {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .hud-bar {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .bar-icon {
            font-size: 0.75rem;
        }

        .bar-track {
            width: 90px;
            height: 10px;
            background: #111;
            border: 1px solid #333;
            border-radius: 3px;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            transition: width 0.5s;
        }

        .hud-bar.hp .bar-fill {
            background: linear-gradient(90deg, #a00, #f44);
        }

        .hud-bar.mp .bar-fill {
            background: linear-gradient(90deg, #640, #a80);
        }

        .bar-text {
            font-size: 0.75rem;
            min-width: 50px;
            color: #ccc;
        }

        .hud-center {
            display: flex;
            align-items: center;
        }

        .hud-location-badge {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid var(--primary);
            border-radius: 12px;
            padding: 5px 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .loc-icon {
            font-size: 0.85rem;
        }

        .loc-text {
            font-size: 0.95rem;
            color: var(--primary-light);
        }

        .hud-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 3px;
        }

        .hud-gold-display {
            display: flex;
            align-items: center;
            gap: 4px;
            background: rgba(255, 215, 0, 0.1);
            padding: 3px 8px;
            border-radius: 6px;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .gold-icon {
            font-size: 1rem;
        }

        .gold-amount {
            font-size: 1.1rem;
            color: var(--gold);
            font-weight: bold;
        }

        .hud-exp-display {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .exp-icon {
            font-size: 0.75rem;
        }

        .exp-bar-mini {
            width: 50px;
            height: 4px;
            background: #222;
            border-radius: 2px;
            overflow: hidden;
        }

        .exp-fill-mini {
            height: 100%;
            background: linear-gradient(90deg, #88f, #f8f);
            width: 0%;
            transition: width 0.5s;
        }

        .hud-hint {
            font-size: 0.65rem;
            color: #555;
        }

        /* ===== PLAYER SPRITE ===== */
        .rpg-sprite {
            position: absolute;
            width: 32px;
            height: 32px;
            z-index: 20;
            /* SMOOTH MOVEMENT - kein Teleport */
            transition: none;
        }

        .rpg-sprite.smooth-move {
            transition: left 0.1s linear, top 0.1s linear;
        }

        .sprite-shadow {
            width: 22px;
            height: 7px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 50%;
            position: absolute;
            bottom: -2px;
            left: 5px;
            filter: blur(2px);
        }

        .sprite-body {
            font-size: 26px;
            position: absolute;
            bottom: 2px;
            left: 3px;
            filter: drop-shadow(2px 2px 2px rgba(0, 0, 0, 0.5));
            transition: transform 0.1s;
        }

        .sprite-name {
            position: absolute;
            top: -16px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.65rem;
            color: var(--gold);
            white-space: nowrap;
            text-shadow: 1px 1px 2px #000;
        }

        #rpg-player.walking .sprite-body {
            animation: walkBounce 0.15s infinite;
        }

        @keyframes walkBounce {

            0%,
            100% {
                transform: translateY(0)
            }

            50% {
                transform: translateY(-4px)
            }
        }

        #rpg-player.face-left .sprite-body {
            transform: scaleX(-1);
        }

        /* ===== NPC SPRITES ===== */
        .rpg-npc {
            position: absolute;
            width: 32px;
            height: 32px;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            font-size: 26px;
            cursor: pointer;
            z-index: 15;
            filter: drop-shadow(2px 2px 2px rgba(0, 0, 0, 0.5));
            transition: all 0.2s;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .rpg-npc:hover,
        .rpg-npc:active {
            filter: drop-shadow(0 0 12px var(--gold));
            transform: scale(1.1);
        }

        .rpg-npc .npc-indicator {
            position: absolute;
            top: -20px;
            font-size: 12px;
            animation: bounce 1s infinite;
        }

        .rpg-npc .npc-name {
            position: absolute;
            top: -34px;
            font-size: 0.6rem;
            color: #fff;
            background: rgba(0, 0, 0, 0.7);
            padding: 2px 5px;
            border-radius: 3px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .rpg-npc:hover .npc-name {
            opacity: 1;
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0)
            }

            50% {
                transform: translateY(-5px)
            }
        }

        .npc-idle {
            animation: npcIdle 2s infinite ease-in-out;
        }

        @keyframes npcIdle {

            0%,
            100% {
                transform: translateY(0)
            }

            50% {
                transform: translateY(-2px)
            }
        }

        /* ===== INTERACTION HINT ===== */
        #interaction-hint {
            position: absolute;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%) translateY(10px) scale(0.98);
            background: rgba(0, 0, 0, 0.85);
            border: 2px solid var(--primary);
            border-radius: 8px;
            padding: 8px 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: opacity 180ms ease, transform 180ms ease, visibility 0s linear 180ms;
        }

        #interaction-hint.visible {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0) scale(1);
            pointer-events: none;
            transition: opacity 180ms ease, transform 180ms ease, visibility 0s;
        }

        .hint-key {
            background: var(--primary);
            color: #000;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.85rem;
        }

        .hint-action-icon {
            font-size: 1.1rem;
        }

        .hint-text {
            color: #fff;
            font-size: 1rem;
        }

        #interaction-hint.mode-attack {
            border-color: #ff6666;
        }

        #interaction-hint.mode-attack .hint-key {
            background: #ff6666;
        }

        #interaction-hint.mode-shop {
            border-color: var(--gold);
        }

        #interaction-hint.mode-shop .hint-key {
            background: var(--gold);
        }

        #interaction-hint.mode-chest {
            border-color: #8b4513;
        }

        #interaction-hint.mode-chest .hint-key {
            background: #8b4513;
            color: #fff;
        }

        /* ===== MESSAGE BOX ===== */
        #rpg-msg-box {
            position: absolute;
            bottom: 8px;
            left: 8px;
            right: 8px;
            min-height: 100px;
            background: linear-gradient(180deg, rgba(26, 58, 110, 0.98), rgba(13, 31, 60, 0.99));
            border: 3px solid var(--primary);
            border-radius: 10px;
            padding: 12px;
            display: none;
            z-index: 100;
            box-shadow: 0 -5px 25px rgba(0, 0, 0, 0.5);
        }

        #rpg-msg-box.visible {
            display: flex;
            gap: 12px;
            animation: msgSlide 0.3s;
        }

        @keyframes msgSlide {
            from {
                transform: translateY(25px);
                opacity: 0
            }

            to {
                transform: translateY(0);
                opacity: 1
            }
        }

        .msg-portrait-frame {
            flex-shrink: 0;
        }

        .msg-portrait {
            width: 65px;
            height: 65px;
            background: linear-gradient(135deg, #2a4a7a, #1a2a4a);
            border: 2px solid var(--primary);
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.5rem;
        }

        .msg-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .msg-speaker {
            color: var(--gold);
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .msg-text-container {
            flex: 1;
            overflow: hidden;
        }

        .msg-text {
            font-size: 1.2rem;
            line-height: 1.4;
        }

        .msg-continue {
            position: absolute;
            bottom: 8px;
            right: 15px;
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.85rem;
            color: #888;
            animation: continueBlink 1s infinite;
        }

        @keyframes continueBlink {

            0%,
            100% {
                opacity: 1
            }

            50% {
                opacity: 0.4
            }
        }

        /* ===== MENU SYSTEM ===== */
        .menu-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
        }

        .menu-window {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: min(520px, 95vw);
            max-height: 90%;
            background: linear-gradient(180deg, #1a3a6e, #0d1f3c);
            border: 3px solid var(--primary);
            border-radius: 14px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: menuPop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        @keyframes menuPop {
            from {
                transform: translate(-50%, -50%) scale(0.7);
                opacity: 0
            }

            to {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1
            }
        }

        .menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: linear-gradient(90deg, #2a5a9f, #1a3a6f);
            border-bottom: 2px solid var(--primary);
        }

        .menu-title {
            font-size: 1.3rem;
            color: #fff;
        }

        .menu-close {
            background: none;
            border: none;
            color: #f44;
            font-size: 1.6rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .menu-close:hover {
            color: #ff8888;
            transform: scale(1.2) rotate(90deg);
        }

        .menu-body {
            padding: 0;
            max-height: 350px;
            overflow-y: auto;
        }

        .menu-tabs {
            display: flex;
            border-bottom: 2px solid #333;
        }

        .menu-tab {
            flex: 1;
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            border: none;
            color: #888;
            font-family: 'VT323', monospace;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .menu-tab:hover {
            background: rgba(74, 159, 255, 0.1);
            color: #aaa;
        }

        .menu-tab.active {
            background: rgba(74, 159, 255, 0.2);
            color: var(--primary-light);
            border-bottom: 2px solid var(--primary);
        }

        .menu-tab-content {
            display: none;
            padding: 15px;
        }

        .menu-tab-content.active {
            display: block;
        }

        .menu-player-card {
            display: flex;
            gap: 15px;
        }

        .player-card-left {
            text-align: center;
        }

        .menu-portrait-large {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #2a4a7a, #1a2a4a);
            border: 3px solid var(--primary);
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3rem;
            margin-bottom: 6px;
        }

        .menu-player-name {
            font-size: 1.2rem;
            color: var(--gold);
        }

        .menu-player-title {
            font-size: 0.8rem;
            color: #888;
        }

        .player-card-right {
            flex: 1;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
            margin-bottom: 10px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(0, 0, 0, 0.3);
            padding: 6px;
            border-radius: 5px;
        }

        .stat-icon {
            font-size: 1rem;
        }

        .stat-label {
            flex: 1;
            color: #888;
            font-size: 0.85rem;
        }

        .stat-value {
            color: #fff;
            font-size: 0.95rem;
        }

        .exp-display {
            background: rgba(0, 0, 0, 0.3);
            padding: 8px;
            border-radius: 6px;
        }

        .exp-label {
            color: #888;
            font-size: 0.85rem;
            margin-bottom: 5px;
        }

        .exp-bar-large {
            height: 12px;
            background: #222;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 3px;
        }

        .exp-fill-large {
            height: 100%;
            background: linear-gradient(90deg, #88f, #f8f);
            transition: width 0.5s;
        }

        .exp-text {
            font-size: 0.8rem;
            color: #aaa;
            text-align: right;
        }

        .menu-inventory {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
        }

        .menu-item {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid #333;
            border-radius: 6px;
            padding: 10px;
            text-align: center;
            transition: all 0.2s;
            cursor: pointer;
        }

        .menu-item:hover {
            border-color: var(--primary);
            background: rgba(74, 159, 255, 0.1);
        }

        .menu-item.usable {
            border-color: rgba(68, 255, 136, 0.35);
        }

        .menu-item.usable:hover {
            background: rgba(68, 255, 136, 0.1);
            transform: translateY(-2px);
        }

        .menu-item-icon {
            font-size: 1.6rem;
            display: block;
            margin-bottom: 3px;
        }

        .menu-item-name {
            font-size: 0.9rem;
            color: #fff;
        }

        .menu-item-count {
            font-size: 0.75rem;
            color: var(--gold);
        }

        .team-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .team-member {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid #333;
            border-radius: 6px;
            padding: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .team-member.met {
            border-color: var(--primary);
            background: rgba(74, 159, 255, 0.1);
        }

        .team-portrait {
            font-size: 1.6rem;
            width: 35px;
            text-align: center;
        }

        .team-info {
            flex: 1;
        }

        .team-name {
            font-size: 0.9rem;
            color: #fff;
        }

        .team-role {
            font-size: 0.7rem;
            color: #888;
        }

        /* World Map Tab */
        .world-map {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            padding: 10px;
        }

        .world-map-room {
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid #444;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .world-map-room:hover {
            border-color: var(--primary);
            transform: scale(1.02);
        }

        .world-map-room.current {
            border-color: var(--gold);
            background: rgba(255, 215, 0, 0.1);
        }

        .world-map-room.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .world-map-room .room-icon {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .world-map-room .room-name {
            font-size: 0.9rem;
            color: #fff;
        }

        .world-map-room .room-status {
            font-size: 0.7rem;
            color: #888;
            margin-top: 3px;
        }

        .menu-footer {
            display: flex;
            gap: 8px;
            padding: 10px 15px;
            border-top: 1px solid #333;
            background: rgba(0, 0, 0, 0.3);
            flex-wrap: wrap;
        }

        .menu-btn {
            flex: 1;
            min-width: 80px;
            padding: 8px;
            background: linear-gradient(180deg, #2a5a9f, #1a3a6f);
            border: 2px solid var(--primary);
            border-radius: 5px;
            color: #fff;
            font-family: 'VT323', monospace;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: all 0.2s;
        }

        .menu-btn:hover {
            transform: translateY(-2px);
        }

        .menu-btn.save {
            background: linear-gradient(180deg, #2a9f5a, #1a6f3a);
            border-color: #4f8;
        }

        .menu-btn.load {
            background: linear-gradient(180deg, #5a5a9f, #3a3a6f);
            border-color: #88f;
        }

        .menu-btn.danger {
            background: linear-gradient(180deg, #9f2a2a, #6f1a1a);
            border-color: #f44;
        }

        .menu-toast {
            display: none;
            padding: 10px 14px;
            background: rgba(0, 0, 0, 0.35);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            color: #ddd;
            font-size: 1rem;
        }

        .menu-toast.show {
            display: block;
        }

        .menu-toast.good {
            color: #44ff88;
        }

        .menu-toast.bad {
            color: #ff6666;
        }

        /* ===== BATTLE SCREEN ===== */
        #rpg-battle-screen {
            background: #000;
            overflow: hidden;
        }

        #battle-transition-in {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            display: none;
            pointer-events: none;
            overflow: hidden;
        }

        #battle-transition-in.active {
            display: block;
        }

        .bt-stripe {
            position: absolute;
            width: 100%;
            height: 12.5%;
            background: linear-gradient(90deg, #fff, var(--primary), #fff);
            transform: scaleX(0);
        }

        .bt-stripe:nth-child(odd) {
            transform-origin: left center;
        }

        .bt-stripe:nth-child(even) {
            transform-origin: right center;
        }

        #battle-transition-in.active .bt-stripe {
            animation: stripeIn 0.8s calc(var(--i) * 0.05s) forwards;
        }

        @keyframes stripeIn {
            0% {
                transform: scaleX(0)
            }

            40% {
                transform: scaleX(1)
            }

            60% {
                transform: scaleX(1)
            }

            100% {
                transform: scaleX(0)
            }
        }

        .bt-stripe:nth-child(1) {
            top: 0%;
        }

        .bt-stripe:nth-child(2) {
            top: 12.5%;
        }

        .bt-stripe:nth-child(3) {
            top: 25%;
        }

        .bt-stripe:nth-child(4) {
            top: 37.5%;
        }

        .bt-stripe:nth-child(5) {
            top: 50%;
        }

        .bt-stripe:nth-child(6) {
            top: 62.5%;
        }

        .bt-stripe:nth-child(7) {
            top: 75%;
        }

        .bt-stripe:nth-child(8) {
            top: 87.5%;
        }

        .bt-flash {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #fff;
            opacity: 0;
        }

        #battle-transition-in.active .bt-flash {
            animation: flashBattle 0.8s 0.3s;
        }

        @keyframes flashBattle {
            0% {
                opacity: 0;
                filter: invert(0);
            }

            10% {
                opacity: 1;
                filter: invert(1);
            }

            20% {
                opacity: 0.8;
                filter: invert(0);
            }

            30% {
                opacity: 1;
                filter: invert(1);
            }

            40% {
                opacity: 0.8;
                filter: invert(0);
            }

            50% {
                opacity: 1;
                filter: invert(1);
            }

            100% {
                opacity: 0;
                filter: invert(0);
            }
        }

        /* Cinematic Battle Zoom */
        .battle-zoom-in {
            animation: zoomInToBattle 1.2s cubic-bezier(.17, .67, .12, .99) forwards !important;
        }

        @keyframes zoomInToBattle {
            0% {
                transform: scale(1) translateZ(0);
            }
            50% {
                transform: scale(8) translateZ(0);
            }
            100% {
                transform: scale(16) translateZ(0);
            }
        }

        .battle-spiral-blur {
            animation: spiralBlur 1.2s ease-in forwards;
        }

        @keyframes spiralBlur {
            0% {
                filter: blur(0) contrast(1) brightness(1) saturate(1);
            }

            30% {
                filter: blur(4px) contrast(1.2) brightness(0.9) saturate(1.3) hue-rotate(15deg);
            }

            70% {
                filter: blur(12px) contrast(1.6) brightness(0.7) saturate(1.5) hue-rotate(30deg);
            }

            100% {
                filter: blur(16px) contrast(1.8) brightness(0.6) saturate(1.6) hue-rotate(45deg);
            }
        }

        /* Shockwave Effect */
        .battle-shockwave {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border: 4px solid rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 9999;
            animation: shockwaveAnim 0.8s ease-out forwards;
        }

        @keyframes shockwaveAnim {
            0% {
                width: 0;
                height: 0;
                opacity: 1;
                border-width: 30px;
            }

            100% {
                width: 200%;
                height: 200%;
                opacity: 0;
                border-width: 0;
            }
        }

        #battle-transition-out {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            pointer-events: none;
        }

        #battle-transition-out.active {
            display: flex;
            pointer-events: all;
        }

        .bt-out-top,
        .bt-out-bottom {
            position: absolute;
            left: 0;
            width: 100%;
            height: 55%;
            background: #000;
        }

        .bt-out-top {
            top: -55%;
        }

        .bt-out-bottom {
            bottom: -55%;
        }

        #battle-transition-out.active .bt-out-top {
            animation: transSlideDown 0.35s ease-out forwards, transSlideUp 0.35s 0.9s ease-in forwards;
        }

        #battle-transition-out.active .bt-out-bottom {
            animation: transSlideUp2 0.35s ease-out forwards, transSlideDown2 0.35s 0.9s ease-in forwards;
        }

        .bt-out-content {
            position: relative;
            z-index: 10;
            text-align: center;
            opacity: 0;
        }

        #battle-transition-out.active .bt-out-content {
            animation: transContentFade 1.25s ease-in-out;
        }

        .bt-out-icon {
            font-size: 2.5rem;
            margin-bottom: 8px;
        }

        .bt-out-text {
            font-family: 'VT323', monospace;
            font-size: 2rem;
            color: #fff;
            text-shadow: 0 0 15px var(--gold);
        }

        #battle-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .battle-bg-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 200%;
            height: 100%;
        }

        .bg-layer-1 {
            background: linear-gradient(180deg, #0a0a2a 0%, #1a1a4a 30%, #2a2a6a 60%, #3a3a8a 100%);
            animation: bgScroll1 30s linear infinite;
        }

        .bg-layer-2 {
            background: radial-gradient(ellipse at 20% 30%, rgba(100, 100, 200, 0.15) 0%, transparent 50%), radial-gradient(ellipse at 80% 60%, rgba(150, 100, 200, 0.1) 0%, transparent 40%);
            animation: bgScroll2 20s linear infinite;
        }

        @keyframes bgScroll1 {
            0% {
                transform: translateX(0)
            }

            100% {
                transform: translateX(-50%)
            }
        }

        @keyframes bgScroll2 {
            0% {
                transform: translateX(0)
            }

            100% {
                transform: translateX(-50%)
            }
        }

        .battle-bg-floor {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 45%;
            background: linear-gradient(180deg, #3a3a5a 0%, #2a2a4a 40%, #1a2a3a 100%);
        }

        .battle-fog {
            position: absolute;
            width: 150%;
            height: 100%;
            pointer-events: none;
            opacity: 0.4;
        }

        .fog-1 {
            background: linear-gradient(90deg, transparent 0%, rgba(100, 120, 180, 0.3) 20%, rgba(100, 120, 180, 0.4) 50%, rgba(100, 120, 180, 0.3) 80%, transparent 100%);
            animation: fogMove1 15s ease-in-out infinite;
            top: 20%;
        }

        .fog-2 {
            background: linear-gradient(90deg, transparent 0%, rgba(80, 100, 160, 0.25) 30%, rgba(80, 100, 160, 0.35) 60%, transparent 100%);
            animation: fogMove2 20s ease-in-out infinite reverse;
            bottom: 30%;
        }

        @keyframes fogMove1 {

            0%,
            100% {
                transform: translateX(-30%)
            }

            50% {
                transform: translateX(10%)
            }
        }

        @keyframes fogMove2 {

            0%,
            100% {
                transform: translateX(-20%)
            }

            50% {
                transform: translateX(0%)
            }
        }

        .battle-particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        #battle-vs-splash {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 500;
            display: none;
            overflow: hidden;
            opacity: 0;
        }

        #battle-vs-splash.active {
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 1;
            animation: vsScreenFade 2.6s forwards;
        }

        @keyframes vsScreenFade {
            0% {
                opacity: 0
            }

            15% {
                opacity: 1
            }

            85% {
                opacity: 1
            }

            100% {
                opacity: 0
            }
        }

        .vs-bg-effect {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a0a2a 0%, #1a0a2a 25%, #0a1a2a 50%, #2a0a1a 75%, #0a0a2a 100%);
        }

        .vs-content {
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 0 30px;
        }

        .vs-fighter {
            flex: 1;
            text-align: center;
        }

        .vs-fighter.vs-player {
            animation: vsSlideLeft 0.4s 0.1s both;
        }

        .vs-fighter.vs-enemy {
            animation: vsSlideRight 0.4s 0.1s both;
        }

        @keyframes vsSlideLeft {
            from {
                transform: translateX(-100px);
                opacity: 0
            }

            to {
                transform: translateX(0);
                opacity: 1
            }
        }

        @keyframes vsSlideRight {
            from {
                transform: translateX(100px);
                opacity: 0
            }

            to {
                transform: translateX(0);
                opacity: 1
            }
        }

        .vs-fighter-bg {
            position: absolute;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
            width: 100%;
            height: 200px;
            background: linear-gradient(90deg, transparent, rgba(74, 159, 255, 0.2), transparent);
        }

        .vs-fighter-bg.enemy {
            background: linear-gradient(90deg, transparent, rgba(255, 74, 74, 0.2), transparent);
        }

        .vs-sprite-wrapper {
            position: relative;
            display: inline-block;
            margin-bottom: 15px;
        }

        .vs-sprite {
            font-size: 5rem;
            position: relative;
            z-index: 2;
            filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.5));
        }

        .vs-glow {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 120px;
            height: 120px;
            background: radial-gradient(circle, rgba(74, 159, 255, 0.4) 0%, transparent 70%);
            border-radius: 50%;
            animation: vsGlowPulse 0.8s ease-in-out infinite;
        }

        .vs-glow.enemy {
            background: radial-gradient(circle, rgba(255, 74, 74, 0.4) 0%, transparent 70%);
        }

        @keyframes vsGlowPulse {

            0%,
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 0.7
            }

            50% {
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 1
            }
        }

        .vs-info {
            position: relative;
        }

        .vs-name {
            font-family: 'VT323', monospace;
            font-size: 1.8rem;
            color: #fff;
            text-shadow: 0 0 10px var(--primary);
        }

        .vs-title {
            font-size: 1rem;
            color: var(--primary-light);
        }

        .vs-title.enemy {
            color: #ff8888;
        }

        .vs-middle {
            width: 180px;
            flex-shrink: 0;
            text-align: center;
            position: relative;
        }

        .vs-text {
            font-family: 'Press Start 2P', monospace;
            font-size: 3rem;
            color: #fff;
            text-shadow: 0 0 20px #ff0, 0 0 40px #f80, 0 0 60px #f00;
            animation: vsPulse 0.2s infinite alternate;
        }

        @keyframes vsPulse {
            from {
                transform: scale(1)
            }

            to {
                transform: scale(1.1)
            }
        }

        .vs-spark {
            position: absolute;
            font-size: 2rem;
            animation: sparkAnim 0.3s infinite alternate;
        }

        .spark-1 {
            top: -20px;
            left: 20px;
        }

        .spark-2 {
            bottom: -20px;
            right: 20px;
            animation-delay: 0.15s;
        }

        @keyframes sparkAnim {
            from {
                opacity: 0.5;
                transform: scale(0.8)
            }

            to {
                opacity: 1;
                transform: scale(1.2)
            }
        }

        .vs-clash-effect {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            background: radial-gradient(circle, rgba(255, 255, 0, 0.6) 0%, rgba(255, 128, 0, 0.3) 50%, transparent 70%);
            border-radius: 50%;
            animation: clashPulse 0.4s ease-out infinite;
        }

        @keyframes clashPulse {
            0% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 1
            }

            100% {
                transform: translate(-50%, -50%) scale(2);
                opacity: 0
            }
        }

        .vs-message {
            position: absolute;
            bottom: 150px;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'VT323', monospace;
            font-size: 1.2rem;
            color: #fff;
            background: rgba(0, 0, 0, 0.7);
            padding: 12px 24px;
            border: 2px solid #f8f;
            border-radius: 8px;
            animation: vMessagePop 0.5s 0.3s both;
            text-shadow: 0 0 10px #f8f;
            max-width: 80%;
            text-align: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        #battle-vs-splash.active .vs-message {
            opacity: 1;
            pointer-events: auto;
        }

        #battle-vs-splash:not(.active) .vs-message {
            opacity: 0;
            pointer-events: none;
        }

        @keyframes vMessagePop {
            from {
                transform: translateX(-50%) scale(0.5);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) scale(1);
                opacity: 1;
            }
        }

        .boss-vs-banner {
            position: absolute;
            top: 25%;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'Press Start 2P', monospace;
            font-size: 3rem;
            color: #ff0;
            text-shadow: 0 0 20px #f00, 0 0 40px #f00, 0 0 60px #f00;
            animation: bossBannerGlitch 0.6s 0.6s both;
            letter-spacing: 4px;
            z-index: 10;
        }

        @keyframes bossBannerGlitch {
            0% {
                transform: translateX(-50%) rotateZ(-5deg) scale(0);
                opacity: 0;
            }
            50% {
                transform: translateX(-50%) rotateZ(2deg) scale(1.1);
                text-shadow: -2px 0 #ff0, 2px 0 #f00, 4px 0 #f8f;
            }
            100% {
                transform: translateX(-50%) rotateZ(0deg) scale(1);
                opacity: 1;
                text-shadow: 0 0 20px #f00, 0 0 40px #f00, 0 0 60px #f00;
            }
        }

        #turn-indicator {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 60;
            pointer-events: none;
        }

        #turn-indicator.active {
            display: flex;
        }

        .turn-banner {
            position: relative;
            width: 100%;
            height: 60px;
            overflow: hidden;
        }

        .turn-bg-slide {
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 0, 0, 0.9), rgba(0, 0, 0, 0.95), rgba(0, 0, 0, 0.9), transparent);
        }

        #turn-indicator.active .turn-bg-slide {
            animation: turnBgSlide 1.8s ease-in-out forwards;
        }

        @keyframes turnBgSlide {
            0% {
                left: -100%
            }

            20% {
                left: 0
            }

            80% {
                left: 0
            }

            100% {
                left: 100%
            }
        }

        .turn-content {
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            height: 100%;
            opacity: 0;
        }

        #turn-indicator.active .turn-content {
            animation: turnContentFade 1.8s ease-in-out;
        }

        @keyframes turnContentFade {
            0% {
                opacity: 0;
                transform: scale(0.5)
            }

            25% {
                opacity: 1;
                transform: scale(1.1)
            }

            35% {
                transform: scale(1)
            }

            75% {
                opacity: 1;
                transform: scale(1)
            }

            100% {
                opacity: 0;
                transform: scale(0.8)
            }
        }

        .turn-icon {
            font-size: 2rem;
        }

        #turn-text {
            font-family: 'Press Start 2P', monospace;
            font-size: 1rem;
            color: var(--gold);
            text-shadow: 0 0 15px var(--gold);
        }

        #turn-indicator.enemy-turn #turn-text {
            color: #ff6666;
            text-shadow: 0 0 15px #ff6666;
        }

        #battle-enemy-area {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
        }

        #battle-enemy-hud {
            margin-bottom: 10px;
        }

        .enemy-hud-inner {
            background: linear-gradient(180deg, rgba(100, 30, 30, 0.9), rgba(60, 20, 20, 0.9));
            border: 2px solid #f44;
            border-radius: 8px;
            padding: 8px 16px;
            box-shadow: 0 4px 15px rgba(255, 0, 0, 0.3);
        }

        .enemy-name {
            font-size: 1.1rem;
            color: #ff8888;
            margin-bottom: 5px;
        }

        .enemy-hp-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .enemy-hp-bar {
            flex: 1;
            height: 14px;
            background: #300;
            border: 2px solid #600;
            border-radius: 4px;
            overflow: hidden;
            min-width: 140px;
        }

        .hp-fill {
            height: 100%;
            background: linear-gradient(180deg, #f66, #c00, #a00);
            transition: width 0.4s;
        }

        .enemy-hp-text {
            font-size: 0.9rem;
            color: #faa;
            min-width: 60px;
            text-align: right;
        }

        #battle-enemy-sprite-container {
            position: relative;
        }

        #battle-enemy-sprite {
            font-size: 6rem;
            animation: enemyFloat 2.5s infinite ease-in-out;
            filter: drop-shadow(0 15px 25px rgba(0, 0, 0, 0.6));
        }

        @keyframes enemyFloat {

            0%,
            100% {
                transform: translateY(0)
            }

            50% {
                transform: translateY(-10px)
            }
        }

        #battle-enemy-shadow {
            position: absolute;
            bottom: -12px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 15px;
            background: radial-gradient(ellipse, rgba(0, 0, 0, 0.5) 0%, transparent 70%);
        }

        #battle-enemy-sprite.hit {
            animation: enemyHit 0.5s !important;
        }

        @keyframes enemyHit {
            0% {
                transform: translateX(0);
                filter: brightness(3)
            }

            20% {
                transform: translateX(-20px)
            }

            40% {
                transform: translateX(20px)
            }

            60% {
                transform: translateX(-12px)
            }

            80% {
                transform: translateX(12px)
            }

            100% {
                transform: translateX(0);
                filter: brightness(1)
            }
        }

        #battle-enemy-sprite.death {
            animation: enemyDeath 1.2s forwards !important;
        }

        @keyframes enemyDeath {
            0% {
                transform: scale(1) rotate(0);
                opacity: 1
            }

            30% {
                transform: scale(1.2) rotate(10deg);
                filter: brightness(2)
            }

            100% {
                transform: scale(0) rotate(180deg);
                opacity: 0
            }
        }

        #battle-dmg-enemy,
        #battle-dmg-player {
            position: absolute;
            font-family: 'Press Start 2P', monospace;
            font-size: 1.6rem;
            text-shadow: 2px 2px 0 #000;
            pointer-events: none;
            z-index: 100;
            opacity: 0;
        }

        #battle-dmg-enemy {
            top: -20px;
            left: 50%;
        }

        #battle-dmg-player {
            top: -15px;
            left: 50%;
        }

        .dmg-show {
            animation: dmgPop 1.2s forwards !important;
        }

        @keyframes dmgPop {
            0% {
                opacity: 1;
                transform: translateX(-50%) translateY(0) scale(0.5)
            }

            20% {
                transform: translateX(-50%) translateY(-15px) scale(1.4)
            }

            100% {
                opacity: 0;
                transform: translateX(-50%) translateY(-50px) scale(1)
            }
        }

        .dmg-heal {
            color: #4f8 !important;
        }

        .dmg-crit {
            color: #f4f !important;
            font-size: 2rem !important;
        }

        #battle-effect-enemy,
        #battle-effect-player {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem;
            pointer-events: none;
            opacity: 0;
        }

        .effect-show {
            animation: effectPop 0.8s forwards;
        }

        @keyframes effectPop {
            0% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(0)
            }

            50% {
                transform: translate(-50%, -50%) scale(1.3)
            }

            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(1.8)
            }
        }

        #battle-player-area {
            position: absolute;
            bottom: 155px;
            left: 70px;
        }

        @media (max-width:920px),
        (pointer:coarse) {
            #battle-player-area {
                left: 50%;
                transform: translateX(-50%);
            }
        }

        #battle-player-platform {
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 10px;
            background: radial-gradient(ellipse, rgba(74, 159, 255, 0.3) 0%, transparent 70%);
        }

        #battle-player-sprite {
            font-size: 4rem;
            filter: drop-shadow(2px 4px 4px rgba(0, 0, 0, 0.5));
        }

        #battle-player-sprite.attack {
            animation: playerAttack 0.6s;
        }

        @keyframes playerAttack {
            0% {
                transform: translateX(0)
            }

            30% {
                transform: translateX(120px) scale(1.1)
            }

            50% {
                transform: translateX(120px)
            }

            100% {
                transform: translateX(0)
            }
        }

        #battle-player-sprite.skill {
            animation: playerSkill 0.8s;
        }

        @keyframes playerSkill {
            0% {
                transform: scale(1);
                filter: brightness(1)
            }

            30% {
                transform: scale(1.2);
                filter: brightness(2) hue-rotate(180deg)
            }

            60% {
                transform: scale(1.1)
            }

            100% {
                transform: scale(1);
                filter: brightness(1)
            }
        }

        #battle-player-sprite.hurt {
            animation: playerHurt 0.4s;
        }

        @keyframes playerHurt {

            0%,
            100% {
                transform: translateX(0);
                filter: brightness(1)
            }

            25% {
                transform: translateX(-12px);
                filter: brightness(2)
            }

            75% {
                transform: translateX(8px)
            }
        }

        #battle-player-sprite.death {
            animation: playerDeath 1s forwards;
        }

        @keyframes playerDeath {
            0% {
                transform: rotate(0) translateY(0);
                opacity: 1
            }

            100% {
                transform: rotate(90deg) translateY(25px);
                opacity: 0.3
            }
        }

        #battle-ui {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 130px;
            display: flex;
            gap: 6px;
            padding: 6px 10px;
            background: linear-gradient(180deg, transparent 0%, rgba(10, 10, 26, 0.95) 20%, #0a0a1a 100%);
        }

        #battle-player-hud {
            width: 200px;
        }

        .battle-hud-frame {
            height: 100%;
            background: linear-gradient(180deg, #1a3a6e, #0d1f3c);
            border: 2px solid var(--primary);
            border-radius: 8px;
            padding: 8px;
            display: flex;
            gap: 8px;
        }

        .player-portrait-battle {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #2a4a7a, #1a2a4a);
            border: 2px solid var(--primary);
            border-radius: 6px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.8rem;
            flex-shrink: 0;
        }

        .player-info-battle {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .player-name-battle {
            font-size: 0.95rem;
            color: var(--primary-light);
            margin-bottom: 5px;
        }

        .player-bars-battle {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .p-bar {
            display: grid;
            grid-template-columns: 18px minmax(100px, 1fr) 50px;
            align-items: center;
            gap: 5px;
        }

        .p-bar-label {
            font-size: 0.72rem;
        }

        .p-bar-track {
            height: 12px;
            background: #111;
            border: 1px solid #333;
            border-radius: 3px;
            overflow: hidden;
        }

        .p-bar-fill {
            height: 100%;
            transition: width 0.4s;
        }

        .p-bar.hp .p-bar-fill {
            background: linear-gradient(90deg, #900, #f44);
        }

        .p-bar.mp .p-bar-fill {
            background: linear-gradient(90deg, #530, #a80);
        }

        .p-bar-text {
            font-size: 0.72rem;
            text-align: right;
            color: #ccc;
        }

        #battle-log {
            flex: 1;
            background: linear-gradient(180deg, #1a3a6e, #0d1f3c);
            border: 2px solid var(--primary);
            border-radius: 8px;
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .log-content {
            text-align: center;
            font-size: 1.1rem;
            line-height: 1.25;
        }

        #battle-menu {
            width: 132px;
            background: linear-gradient(180deg, #1a3a6e, #0d1f3c);
            border: 2px solid var(--primary);
            border-radius: 8px;
            padding: 4px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px;
        }

        .battle-cmd {
            padding: 6px 4px;
            min-height: 44px;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            transition: all 0.15s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid transparent;
        }

        .battle-cmd:hover {
            background: rgba(74, 159, 255, 0.2);
            border-color: rgba(74, 159, 255, 0.5);
        }

        .battle-cmd.selected {
            background: linear-gradient(180deg, rgba(255, 215, 0, 0.3), rgba(255, 215, 0, 0.1));
            border-color: var(--gold);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        .battle-cmd.disabled {
            opacity: 0.4;
            pointer-events: none;
        }

        .cmd-icon {
            font-size: 1.05rem;
        }

        .cmd-text {
            font-size: 0.68rem;
            white-space: nowrap;
        }

        .battle-submenu {
            position: absolute;
            bottom: 145px;
            left: 50%;
            transform: translateX(-50%);
            width: 260px;
            background: linear-gradient(180deg, #1a3a6e, #0d1f3c);
            border: 3px solid var(--primary);
            border-radius: 10px;
            padding: 10px;
            display: none;
            z-index: 100;
        }

        .battle-submenu.visible {
            display: block;
            animation: submenuPop 0.3s forwards;
        }

        @keyframes submenuPop {
            from {
                transform: translateX(-50%) scale(0.8) translateY(15px);
                opacity: 0
            }

            to {
                transform: translateX(-50%) scale(1) translateY(0);
                opacity: 1
            }
        }

        .submenu-header {
            font-size: 1.1rem;
            color: var(--primary-light);
            padding-bottom: 6px;
            border-bottom: 1px solid #333;
            margin-bottom: 6px;
        }

        .skill-row,
        .item-row {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid transparent;
            border-radius: 5px;
            margin-bottom: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .skill-row:hover,
        .item-row:hover {
            background: rgba(74, 159, 255, 0.2);
            border-color: var(--primary);
        }

        .skill-icon,
        .item-icon {
            font-size: 1.2rem;
        }

        .skill-name,
        .item-name {
            flex: 1;
            font-size: 0.95rem;
        }

        .skill-cost {
            color: var(--mp-color);
            font-size: 0.8rem;
        }

        .item-count {
            color: var(--gold);
            font-size: 0.8rem;
        }

        .submenu-back {
            width: 100%;
            padding: 6px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #444;
            border-radius: 4px;
            color: #aaa;
            font-family: 'VT323', monospace;
            font-size: 0.95rem;
            cursor: pointer;
            margin-top: 6px;
            transition: all 0.2s;
        }

        .submenu-back:hover {
            background: rgba(74, 159, 255, 0.2);
            border-color: var(--primary);
            color: #fff;
        }

        #victory-screen,
        #defeat-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 300;
        }

        #victory-screen.visible,
        #defeat-screen.visible {
            display: flex;
        }

        .victory-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, rgba(255, 215, 0, 0.2) 0%, rgba(0, 0, 0, 0.95) 70%);
        }

        .victory-content {
            position: relative;
            z-index: 1;
            text-align: center;
            animation: victorySlide 0.8s forwards;
        }

        @keyframes victorySlide {
            from {
                transform: translateY(40px) scale(0.8);
                opacity: 0
            }

            to {
                transform: translateY(0) scale(1);
                opacity: 1
            }
        }

        .victory-stars {
            font-size: 1.6rem;
            margin-bottom: 6px;
            animation: starsSparkle 1s infinite;
        }

        @keyframes starsSparkle {

            0%,
            100% {
                transform: scale(1)
            }

            50% {
                transform: scale(1.1);
                filter: brightness(1.3)
            }
        }

        .victory-title {
            font-family: 'Press Start 2P', monospace;
            font-size: 2rem;
            color: var(--gold);
            text-shadow: 0 0 25px var(--gold);
            margin-bottom: 4px;
        }

        .victory-subtitle {
            font-size: 1.1rem;
            color: #aaa;
            margin-bottom: 15px;
        }

        .victory-rewards {
            margin-bottom: 12px;
        }

        .reward-item {
            font-size: 1.2rem;
            margin: 8px 5px;
            padding: 6px 16px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 6px;
            display: inline-block;
        }

        .reward-item.gold {
            border: 2px solid var(--gold);
        }

        .reward-item.exp {
            border: 2px solid #88f;
        }

        #xp-bar-container {
            display: none;
            margin: 12px 0;
            padding: 12px 24px;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid #88f;
            border-radius: 10px;
            text-align: center;
        }

        #xp-bar-container.visible {
            display: block;
        }

        .xp-bar-label {
            font-size: 0.9rem;
            color: #88f;
            margin-bottom: 6px;
            font-weight: bold;
        }

        .xp-bar-bg {
            width: 100%;
            height: 20px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #88f;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 6px;
        }

        .xp-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #4488ff, #88ddff);
            width: 0%;
            transition: width 0.8s ease-out;
            box-shadow: 0 0 10px #88ddff;
        }

        .xp-bar-text {
            font-size: 0.85rem;
            color: #aaa;
        }

        #levelup-display {
            display: none;
            margin: 12px 0;
            padding: 10px 20px;
            background: linear-gradient(135deg, rgba(136, 136, 255, 0.3), rgba(255, 136, 255, 0.3));
            border: 2px solid #f8f;
            border-radius: 10px;
            animation: levelupPulse 0.6s ease-out;
        }

        #levelup-display.visible {
            display: inline-block;
        }

        @keyframes levelupPulse {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .levelup-text {
            font-family: 'Press Start 2P', monospace;
            font-size: 0.8rem;
            color: #f8f;
            margin-bottom: 6px;
            animation: levelupGlitch 0.4s ease-out;
        }

        @keyframes levelupGlitch {
            0% {
                transform: translateX(-3px);
                opacity: 0;
            }
            50% {
                transform: translateX(3px);
            }
            100% {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .levelup-transition {
            font-size: 1.1rem;
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
        }

        .old-level {
            color: #aaa;
            text-decoration: line-through;
            font-size: 0.95rem;
        }

        .level-arrow {
            color: #f8f;
            font-weight: bold;
            animation: arrowBounce 0.6s ease-in-out infinite;
        }

        @keyframes arrowBounce {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(6px); }
        }

        .new-level {
            color: #ffff00;
            font-weight: bold;
            text-shadow: 0 0 10px #ffff00;
        }

        .chest-container {
            margin: 12px 0;
            padding: 12px 20px;
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid var(--gold);
            border-radius: 10px;
            display: none;
        }

        .chest-container.visible {
            display: inline-block;
        }

        .victory-btn {
            padding: 10px 35px;
            background: linear-gradient(180deg, #5a9f2a, #3a6f1a);
            border: 3px solid var(--success);
            border-radius: 8px;
            color: #fff;
            font-family: 'VT323', monospace;
            font-size: 1.2rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s;
            margin-top: 8px;
        }

        .victory-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(68, 255, 136, 0.3);
        }

        .defeat-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, rgba(255, 0, 0, 0.2) 0%, rgba(0, 0, 0, 0.95) 70%);
        }

        .defeat-content {
            position: relative;
            z-index: 1;
            text-align: center;
        }

        .defeat-icon {
            font-size: 4rem;
            margin-bottom: 12px;
            animation: skullFloat 2s infinite;
        }

        @keyframes skullFloat {

            0%,
            100% {
                transform: translateY(0) rotate(-5deg)
            }

            50% {
                transform: translateY(-8px) rotate(5deg)
            }
        }

        .defeat-title {
            font-family: 'Press Start 2P', monospace;
            font-size: 1.6rem;
            color: var(--danger);
            text-shadow: 0 0 25px var(--danger);
            margin-bottom: 10px;
        }

        .defeat-text {
            font-size: 1.1rem;
            color: #888;
            margin-bottom: 6px;
        }

        .defeat-penalty {
            font-size: 1rem;
            color: var(--danger);
            margin-bottom: 12px;
        }

        .defeat-btn {
            padding: 10px 30px;
            background: linear-gradient(180deg, #5a5a5a, #3a3a3a);
            border: 2px solid #888;
            border-radius: 8px;
            color: #fff;
            font-family: 'VT323', monospace;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        /* ===== SHOP ===== */
        #rpg-shop-screen {
            justify-content: center;
            align-items: center;
        }

        /* ===== SKILL SHOP ===== */
        #rpg-skillshop-screen {
            justify-content: center;
            align-items: center;
        }

        .shop-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a2a3a, #0a1a2a, #1a3a2a);
        }

        .shop-container {
            position: relative;
            z-index: 1;
            width: 90%;
            max-width: 520px;
            background: linear-gradient(180deg, #1a3a6e, #0d1f3c);
            border: 4px solid var(--primary);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 0 50px rgba(74, 159, 255, 0.3);
            animation: shopOpen 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        @keyframes shopOpen {
            0% {
                opacity: 0;
                transform: scale(0.8) translateY(30px)
            }

            100% {
                opacity: 1;
                transform: scale(1) translateY(0)
            }
        }

        .shop-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(74, 159, 255, 0.3);
        }

        .shop-keeper-area {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .shop-keeper-sprite {
            font-size: 2.5rem;
            animation: shopkeeperBounce 2s infinite;
        }

        @keyframes shopkeeperBounce {

            0%,
            100% {
                transform: translateY(0)
            }

            50% {
                transform: translateY(-6px)
            }
        }

        .shop-keeper-dialog {
            display: flex;
            flex-direction: column;
        }

        .keeper-name {
            font-size: 1.1rem;
            color: var(--gold);
        }

        .keeper-text {
            font-size: 0.9rem;
            color: #aaa;
            font-style: italic;
        }

        .shop-player-gold {
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(255, 215, 0, 0.1);
            padding: 6px 12px;
            border-radius: 8px;
            border: 2px solid rgba(255, 215, 0, 0.3);
        }

        .gold-coin {
            font-size: 1.4rem;
        }

        #shop-gold {
            font-size: 1.4rem;
            color: var(--gold);
            font-weight: bold;
        }

        .shop-items {
            max-height: 280px;
            overflow-y: auto;
            overflow-x: hidden;
            margin-bottom: 10px;
        }

        .shop-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid transparent;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .shop-item:hover {
            background: rgba(74, 159, 255, 0.15);
            border-color: var(--primary);
            transform: translateX(6px);
        }

        .shop-item.too-expensive {
            opacity: 0.5;
        }

        .shop-item.too-expensive:hover {
            transform: none;
            border-color: #f44;
        }

        .shop-item.purchased {
            animation: purchaseFlash 0.5s;
        }

        @keyframes purchaseFlash {
            0% {
                background: rgba(74, 255, 74, 0.5);
                transform: scale(1.05)
            }

            100% {
                background: rgba(0, 0, 0, 0.3);
                transform: scale(1)
            }
        }

        .shop-item-icon {
            font-size: 2.2rem;
            width: 45px;
            text-align: center;
            transition: transform 0.3s;
        }

        .shop-item:hover .shop-item-icon {
            transform: scale(1.2) rotate(10deg);
        }

        .shop-item-info {
            flex: 1;
            min-width: 0;
        }

        .shop-item-name {
            font-size: 1.2rem;
            color: #fff;
            display: block;
            margin-bottom: 2px;
        }

        .shop-item-desc {
            font-size: 0.9rem;
            color: #888;
        }

        .shop-item-price {
            font-size: 1.3rem;
            color: var(--gold);
            font-weight: bold;
            flex-shrink: 0;
            white-space: nowrap;
        }

        .shop-exit-btn {
            width: 100%;
            padding: 10px;
            background: linear-gradient(180deg, #4a4a4a, #2a2a2a);
            border: 2px solid #666;
            border-radius: 6px;
            color: #fff;
            font-family: 'VT323', monospace;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .shop-exit-btn:hover {
            background: linear-gradient(180deg, #5a5a5a, #3a3a3a);
            transform: translateY(-2px);
        }

        /* ===== ENDING ===== */
        #rpg-ending-screen {
            justify-content: center;
            align-items: center;
        }

        .ending-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3a 25%, #2a1a4a 50%, #1a3a4a 75%, #0a2a3a 100%);
            background-size: 400% 400%;
            animation: endingGradientShift 15s ease infinite;
            overflow: hidden;
        }

        @keyframes endingGradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Animated Stars Background */
        .ending-stars {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(2px 2px at 20px 30px, #fff, transparent),
                radial-gradient(2px 2px at 40px 70px, rgba(255,255,255,0.8), transparent),
                radial-gradient(1px 1px at 90px 40px, #fff, transparent),
                radial-gradient(2px 2px at 160px 120px, rgba(255,255,255,0.9), transparent),
                radial-gradient(1px 1px at 230px 80px, #fff, transparent),
                radial-gradient(2px 2px at 300px 150px, rgba(255,255,255,0.7), transparent),
                radial-gradient(1px 1px at 380px 60px, #fff, transparent),
                radial-gradient(2px 2px at 450px 180px, rgba(255,255,255,0.8), transparent),
                radial-gradient(1px 1px at 520px 100px, #fff, transparent),
                radial-gradient(2px 2px at 600px 200px, rgba(255,255,255,0.9), transparent);
            background-repeat: repeat;
            background-size: 600px 250px;
            animation: starsTwinkle 4s ease-in-out infinite alternate;
            opacity: 0.8;
        }

        @keyframes starsTwinkle {
            0% { opacity: 0.5; transform: scale(1); }
            100% { opacity: 1; transform: scale(1.02); }
        }

        /* Nebula Effect */
        .ending-nebula {
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: 
                radial-gradient(ellipse at 30% 40%, rgba(120, 80, 200, 0.3) 0%, transparent 50%),
                radial-gradient(ellipse at 70% 60%, rgba(80, 150, 220, 0.3) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 80%, rgba(200, 100, 150, 0.2) 0%, transparent 40%);
            animation: nebulaRotate 30s linear infinite;
        }

        @keyframes nebulaRotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Light Rays Effect */
        .ending-lightrays {
            position: absolute;
            top: -100%;
            left: 50%;
            transform: translateX(-50%);
            width: 200%;
            height: 300%;
            background: conic-gradient(from 0deg at 50% 50%, 
                transparent 0deg, rgba(255, 215, 0, 0.03) 10deg, transparent 20deg,
                transparent 40deg, rgba(255, 215, 0, 0.05) 50deg, transparent 60deg,
                transparent 80deg, rgba(255, 215, 0, 0.03) 90deg, transparent 100deg,
                transparent 120deg, rgba(255, 215, 0, 0.04) 130deg, transparent 140deg,
                transparent 160deg, rgba(255, 215, 0, 0.03) 170deg, transparent 180deg,
                transparent 200deg, rgba(255, 215, 0, 0.05) 210deg, transparent 220deg,
                transparent 240deg, rgba(255, 215, 0, 0.03) 250deg, transparent 260deg,
                transparent 280deg, rgba(255, 215, 0, 0.04) 290deg, transparent 300deg,
                transparent 320deg, rgba(255, 215, 0, 0.03) 330deg, transparent 340deg,
                transparent 360deg);
            animation: lightraysRotate 20s linear infinite;
            pointer-events: none;
        }

        @keyframes lightraysRotate {
            0% { transform: translateX(-50%) rotate(0deg); }
            100% { transform: translateX(-50%) rotate(360deg); }
        }

        .ending-confetti {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: radial-gradient(circle, #ffd700 2px, transparent 2px), radial-gradient(circle, #ff6b6b 2px, transparent 2px), radial-gradient(circle, #4ecdc4 2px, transparent 2px), radial-gradient(circle, #ffe66d 2px, transparent 2px);
            background-size: 100px 100px, 80px 80px, 120px 120px, 60px 60px;
            animation: confettiFall 10s linear infinite;
            opacity: 0.4;
        }

        @keyframes confettiFall {
            0% { transform: translateY(-100%) rotate(0deg); }
            100% { transform: translateY(100%) rotate(720deg); }
        }

        .ending-content {
            position: relative;
            z-index: 10;
            text-align: center;
            padding: 20px;
        }

        .ending-trophy-container {
            position: relative;
            margin-bottom: 20px;
            display: inline-block;
        }

        .ending-trophy {
            font-size: 7rem;
            animation: trophyFloat 3s infinite ease-in-out, trophyGlow 2s infinite alternate;
            position: relative;
            z-index: 2;
            filter: drop-shadow(0 0 30px rgba(255, 215, 0, 0.8));
        }

        @keyframes trophyFloat {
            0%, 100% { transform: translateY(0) rotate(-5deg) scale(1); }
            50% { transform: translateY(-20px) rotate(5deg) scale(1.05); }
        }

        @keyframes trophyGlow {
            0% { filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.6)); }
            100% { filter: drop-shadow(0 0 50px rgba(255, 215, 0, 1)) brightness(1.2); }
        }

        .ending-glow {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.6) 0%, rgba(255, 180, 0, 0.3) 40%, transparent 70%);
            animation: glowPulse 2s infinite ease-in-out;
            z-index: 1;
        }

        @keyframes glowPulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.6; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
        }

        .ending-sparkles {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            font-size: 2rem;
            animation: sparklesFloat 2s infinite ease-in-out;
            z-index: 3;
            pointer-events: none;
        }

        @keyframes sparklesFloat {
            0%, 100% { transform: translateX(-50%) translateY(0) scale(1); opacity: 1; }
            50% { transform: translateX(-50%) translateY(-30px) scale(1.3); opacity: 0.7; }
        }

        .ending-title {
            font-family: 'Press Start 2P', monospace;
            font-size: 2rem;
            color: var(--gold);
            text-shadow: 
                0 0 10px var(--gold),
                0 0 20px var(--gold),
                0 0 40px rgba(255, 215, 0, 0.5),
                0 0 80px rgba(255, 215, 0, 0.3);
            margin-bottom: 10px;
            animation: titleShine 3s infinite;
        }

        @keyframes titleShine {
            0%, 100% { text-shadow: 0 0 10px var(--gold), 0 0 20px var(--gold), 0 0 40px rgba(255, 215, 0, 0.5); }
            50% { text-shadow: 0 0 20px var(--gold), 0 0 40px var(--gold), 0 0 80px rgba(255, 215, 0, 0.8), 0 0 120px rgba(255, 215, 0, 0.5); }
        }

        .ending-subtitle {
            font-size: 1.3rem;
            color: #ccc;
            margin-bottom: 25px;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
        }

        .ending-stats-container {
            position: relative;
            display: inline-block;
            margin-bottom: 20px;
        }

        .ending-stats-container::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #ffd700, #ff6b6b, #4ecdc4, #ffd700);
            border-radius: 12px;
            z-index: -1;
            animation: borderGlow 3s linear infinite;
            background-size: 400% 400%;
        }

        @keyframes borderGlow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .ending-stats {
            background: rgba(0, 0, 0, 0.7);
            padding: 20px 35px;
            border-radius: 10px;
            display: inline-block;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .ending-stat {
            font-size: 1.2rem;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            gap: 30px;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .ending-stat:last-child {
            border-bottom: none;
        }

        .ending-stat .stat-label {
            color: #888;
        }

        .ending-stat span:last-child {
            color: var(--gold);
            font-weight: bold;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .ending-credits {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .ending-credits p {
            margin: 5px 0;
        }

        .ending-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .ending-btn {
            padding: 15px 35px;
            border: none;
            border-radius: 10px;
            font-family: 'VT323', monospace;
            font-size: 1.4rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .ending-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }

        .ending-btn:hover::before {
            left: 100%;
        }

        .ending-btn-primary {
            background: linear-gradient(180deg, #5a9f2a, #3a6f1a);
            border: 3px solid var(--success);
            color: #fff;
            box-shadow: 0 0 20px rgba(68, 255, 136, 0.3);
        }

        .ending-btn-primary:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 12px 40px rgba(68, 255, 136, 0.5);
            background: linear-gradient(180deg, #6abf3a, #4a8f2a);
        }

        .ending-btn-secondary {
            background: linear-gradient(180deg, #666, #444);
            border: 3px solid #888;
            color: #fff;
            box-shadow: 0 0 20px rgba(100, 100, 100, 0.3);
        }

        .ending-btn-secondary:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 12px 40px rgba(150, 150, 150, 0.4);
            background: linear-gradient(180deg, #888, #666);
        }

        #rpg-parallax-layer {
            position: absolute;
            top: -30%;
            left: -30%;
            width: 160%;
            height: 160%;
            pointer-events: none;
            overflow: hidden;
            transform-origin: center center;
            will-change: transform;
        }

        #rpg-parallax-layer::before,
        #rpg-parallax-layer::after {
            content: "";
            position: absolute;
            animation: parallaxFloat 20s ease-in-out infinite;
        }

        @keyframes parallaxFloat {

            0%,
            100% {
                transform: translate(0, 0) scale(1);
            }

            50% {
                transform: translate(5%, 2%) scale(1.02);
            }
        }

        /* ===== MOBILE CONTROLS ===== */
        #rpg-touch-controls {
            position: absolute;
            bottom: 160px;
            right: 12px;
            z-index: 200;
            display: none;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .touch-dpad {
            display: grid;
            grid-template-columns: repeat(3, 48px);
            grid-template-rows: repeat(3, 48px);
            gap: 4px;
        }

        .dpad-btn {
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.4);
            color: #fff;
            font-size: 1.3rem;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.1s;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        .dpad-btn:active {
            background: rgba(74, 159, 255, 0.6);
            transform: scale(0.92);
        }

        .dpad-btn.up {
            grid-column: 2;
            grid-row: 1;
        }

        .dpad-btn.left {
            grid-column: 1;
            grid-row: 2;
        }

        .dpad-btn.center {
            grid-column: 2;
            grid-row: 2;
            background: rgba(74, 159, 255, 0.4);
        }

        .dpad-btn.right {
            grid-column: 3;
            grid-row: 2;
        }

        .dpad-btn.down {
            grid-column: 2;
            grid-row: 3;
        }

        .touch-actions {
            position: absolute;
            top: -60px;
            right: 0;
            display: flex;
            gap: 8px;
        }

        .touch-action-btn {
            width: 48px;
            height: 48px;
            background: rgba(74, 159, 255, 0.4);
            border: 2px solid var(--primary);
            border-radius: 8px;
            color: #fff;
            font-size: 1.5rem;
            display: flex;
            justify-content: center;
            align-items: center;
            touch-action: manipulation;
        }

        .touch-action-btn.cheat {
            background: rgba(255, 136, 0, 0.4);
            border-color: #f80;
        }

        /* ===== CHOICE SYSTEM ===== */
        .msg-choice {
            margin-top: 10px;
            display: none;
            flex-direction: column;
            gap: 6px;
        }

        .msg-choice.visible {
            display: flex;
        }

        .choice-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.28);
            border: 1px solid rgba(255, 255, 255, 0.08);
            cursor: pointer;
        }

        .choice-row .choice-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .choice-row .choice-cursor {
            width: 18px;
            text-align: center;
            color: var(--gold);
        }

        .choice-row .choice-text {
            font-size: 1.05rem;
            color: #fff;
        }

        .choice-row.selected {
            background: rgba(74, 159, 255, 0.22);
            border-color: rgba(74, 159, 255, 0.5);
            box-shadow: 0 0 10px rgba(74, 159, 255, 0.18);
        }

        .choice-hint {
            margin-top: 6px;
            font-size: 0.9rem;
            color: #aaa;
            text-align: right;
            opacity: 0.9;
        }

        /* High Quality Dynamic Map Effects */
        :root {
            --cam-x: 0px;
            --cam-y: 0px;
            --cam-x-windows: 0px;
            --cam-y-windows: 0px;
        }

        /* Flur: Schwebende Partikel (Staub/Dust) - Parallax */
        .effect-particles::after,
        .effect-particles::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-repeat: repeat;
            mix-blend-mode: screen;
            opacity: 0.6;
            pointer-events: none;
            z-index: 90;
            will-change: background-position;
        }

        .effect-particles::after {
            /* Layer 1: GroÃŸe Partikel (schneller) */
            background-image: radial-gradient(circle, rgba(255, 255, 255, 0.5) 1px, transparent 1.5px);
            background-size: 120px 120px;
            background-position: var(--cam-x) var(--cam-y);
            animation: particleMove1 30s linear infinite;
        }

        .effect-particles::before {
            /* Layer 2: Kleine Partikel (langsamer) */
            background-image: radial-gradient(circle, rgba(255, 255, 255, 0.3) 1px, transparent 1px);
            background-size: 80px 80px;
            animation: particleMove2 45s linear infinite;
            background-position: var(--cam-x) var(--cam-y);
        }

        /* Boss: Vignette + Dim */
        .effect-dim::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, transparent 30%, rgba(0, 0, 0, 0.9) 100%);
            mix-blend-mode: multiply;
            pointer-events: none;
            z-index: 90;
        }

        /* Spotlight Effect for Boss */
        .effect-dim::before {
            content: "";
            position: absolute;
            top: 20%;
            left: 40%;
            width: 20%;
            height: 30%;
            background: radial-gradient(circle, rgba(255, 255, 200, 0.15) 0%, transparent 70%);
            pointer-events: none;
            z-index: 89;
            filter: blur(20px);
            animation: lightPulse 5s ease-in-out infinite;
        }

        /* Offices: Parallax God Rays */
        .effect-windows::after {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(110deg,
                    transparent 0%,
                    transparent 8%,
                    rgba(255, 255, 220, 0.08) 12%,
                    transparent 16%);
            background-position: var(--cam-x-windows) var(--cam-y-windows);
            pointer-events: none;
            z-index: 90;
            mix-blend-mode: overlay;
        }

        @keyframes fogMove {
            0% {
                transform: translate(0, 0);
            }

            100% {
                transform: translate(-100px, -50px);
            }
        }

        @keyframes lightRayMove {
            0% {
                transform: translateX(0);
            }

            100% {
                transform: translateX(-50px);
            }
        }

        @keyframes particleMove1 {
            0% {
                background-position: var(--cam-x) var(--cam-y);
            }

            100% {
                background-position: calc(var(--cam-x) - 120px) calc(var(--cam-y) - 120px);
            }
        }

        @keyframes particleMove2 {
            0% {
                background-position: var(--cam-x) var(--cam-y);
            }

            100% {
                background-position: calc(var(--cam-x) - 80px) calc(var(--cam-y) - 80px);
            }
        }

        @keyframes lightPulse {
            0% {
                opacity: 0.4;
            }

            50% {
                opacity: 0.7;
            }

            100% {
                opacity: 0.4;
            }
        }

        /* Typewriter Spacing Fixes */
        #badge-dept,
        #preview-dept,
        .signature-x {
            white-space: pre-wrap;
        }

        /* ===== FEEDBACK EFFECTS ===== */
        .bump {
            animation: bump 0.5s ease-out;
        }

        @keyframes bump {
            0% {
                transform: scale(1);
                filter: brightness(1);
            }

            20% {
                transform: scale(1.4);
                filter: brightness(2) saturate(1.5);
            }

            40% {
                transform: scale(0.9);
                filter: brightness(1.2);
            }

            60% {
                transform: scale(1.1);
                filter: brightness(1.1);
            }

            100% {
                transform: scale(1);
                filter: brightness(1);
            }
        }

        .flash-white {
            animation: flashWhite 0.6s ease-out forwards;
        }

        @keyframes flashWhite {
            0% {
                background: white;
                opacity: 0;
            }

            15% {
                opacity: 0.9;
            }

            30% {
                opacity: 0.4;
            }

            45% {
                opacity: 0.9;
            }

            100% {
                opacity: 0;
            }
        }

        @keyframes screenShake {
            0% {
                transform: translate(0, 0);
            }

            10% {
                transform: translate(-4px, -2px);
            }

            20% {
                transform: translate(4px, 2px);
            }

            30% {
                transform: translate(-6px, 1px);
            }

            40% {
                transform: translate(6px, -1px);
            }

            50% {
                transform: translate(-4px, 2px);
            }

            60% {
                transform: translate(4px, -2px);
            }

            70% {
                transform: translate(-2px, 1px);
            }

            80% {
                transform: translate(2px, -1px);
            }

            90% {
                transform: translate(-1px, 0);
            }

            100% {
                transform: translate(0, 0);
            }
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width:920px),
        (pointer:coarse) {
            #rpg-game-window {
                width: 100%;
                height: 100%;
                border-radius: 0;
                border: none;
            }

            #rpg-touch-controls {
                display: block;
            }

            .splash-title {
                font-size: 1.6rem;
            }

            .contract-paper {
                width: 95%;
                padding: 16px;
            }

            #rpg-close-btn {
                top: 8px;
                right: 8px;
                width: 42px;
                height: 42px;
            }

            #cheat-console {
                width: 90%;
                left: 5%;
                bottom: 10px;
            }

            .hud-hint {
                display: none;
            }

            /* HUD Mobile Fixes */
            #rpg-hud {
                height: 60px;
                padding: 6px 10px;
            }

            .hud-portrait {
                width: 38px;
                height: 38px;
                font-size: 1.4rem;
            }

            .hud-name {
                font-size: 1rem;
            }

            .bar-track {
                width: 70px;
                height: 8px;
            }

            .bar-text {
                font-size: 0.7rem;
            }

            .bar-icon {
                font-size: 0.7rem;
            }

            .hud-gold-display {
                font-size: 0.9rem;
            }

            .gold-amount {
                font-size: 1rem;
            }

            .hud-location-badge {
                font-size: 0.85rem;
                padding: 4px 8px;
            }

            .minimap-toggle {
                width: 32px;
                height: 32px;
                font-size: 1rem;
            }

            /* Viewport & Camera Mobile */
            #rpg-viewport {
                position: relative;
            }

            #rpg-camera {
                transform-origin: center center;
            }

            /* Message Box Mobile Fixes */
            #rpg-msg-box {
                padding: 10px;
                min-height: 100px;
                max-height: 140px;
            }

            .msg-portrait-frame {
                width: 50px;
            }

            .msg-portrait {
                width: 50px;
                height: 50px;
                font-size: 2rem;
            }

            .msg-speaker {
                font-size: 0.95rem;
            }

            .msg-text {
                font-size: 1rem;
                line-height: 1.3;
                word-wrap: break-word;
                overflow-wrap: break-word;
            }

            .msg-continue {
                font-size: 0.75rem;
                bottom: 6px;
                right: 10px;
            }

            /* Menu Window Mobile Fix */
            .menu-window {
                width: 95%;
                max-width: 520px;
                max-height: 85vh;
            }

            .menu-body {
                max-height: calc(85vh - 150px);
            }

            .stat-grid {
                grid-template-columns: 1fr;
            }

            .menu-player-card {
                flex-direction: column;
                align-items: center;
            }

            /* Battle Screen Mobile Fixes */
            #battle-enemy-area {
                top: 40px;
            }

            #battle-enemy-sprite {
                font-size: 4rem;
            }

            #battle-player-area {
                bottom: 145px;
                left: 50%;
                transform: translateX(-50%);
            }

            #battle-player-sprite {
                font-size: 3rem;
            }

            #battle-ui {
                height: 140px;
                padding: 6px;
            }

            #battle-player-hud {
                width: 160px;
            }

            .player-portrait-battle {
                width: 40px;
                height: 40px;
                font-size: 1.5rem;
            }

            .player-name-battle {
                font-size: 0.85rem;
            }

            .p-bar {
                grid-template-columns: 16px minmax(70px, 1fr) 45px;
            }

            .p-bar-label {
                font-size: 0.65rem;
            }

            .p-bar-text {
                font-size: 0.65rem;
            }

            #battle-menu {
                width: 110px;
            }

            .battle-cmd {
                min-height: 38px;
                padding: 4px 2px;
            }

            .cmd-icon {
                font-size: 0.95rem;
            }

            .cmd-text {
                font-size: 0.6rem;
            }

            /* Battle Log Text Fix - WICHTIG */
            #battle-log {
                padding: 6px;
                overflow: hidden;
            }

            .log-content {
                font-size: 0.85rem;
                line-height: 1.2;
                word-wrap: break-word;
                overflow-wrap: break-word;
                max-height: 100%;
                overflow-y: auto;
            }

            .battle-submenu {
                width: 90%;
                max-width: 280px;
                bottom: 155px;
            }

            .enemy-name {
                font-size: 0.95rem;
            }

            .enemy-hp-bar {
                min-width: 100px;
            }

            .enemy-hp-text {
                font-size: 0.8rem;
                min-width: 50px;
            }

            /* VS Splash Mobile */
            .vs-content {
                padding: 0 10px;
                flex-direction: column;
                gap: 20px;
            }

            .vs-middle {
                width: 100%;
                order: 2;
            }

            .vs-fighter {
                order: 1;
            }

            .vs-fighter.vs-enemy {
                order: 3;
            }

            .vs-sprite {
                font-size: 3.5rem;
            }

            .vs-text {
                font-size: 2rem;
            }

            .vs-name {
                font-size: 1.4rem;
            }

            /* Splash Screen Mobile */
            .splash-content {
                padding: 20px;
                text-align: center;
            }

            .splash-icon {
                font-size: 4rem;
            }

            .splash-title {
                font-size: 1.6rem;
                text-align: center;
            }

            .splash-subtitle {
                font-size: 0.9rem;
            }

            .splash-version {
                font-size: 0.85rem;
            }

            .splash-credits {
                font-size: 0.8rem;
            }

            .splash-loader-container {
                width: 90%;
                max-width: 280px;
                margin: 40px auto 0;
            }

            .splash-start-btn {
                width: auto;
                max-width: 90%;
                margin: 30px auto 0;
            }


            /* Interaction Hint Mobile */
            #interaction-hint {
                bottom: 10px;
                padding: 6px 12px;
                font-size: 0.85rem;
            }

            .hint-key {
                padding: 3px 8px;
                font-size: 0.75rem;
            }

            .hint-action-icon {
                font-size: 1rem;
            }
        }

        @media (max-height:680px) {
            #rpg-game-window {
                height: 100%;
            }

            #rpg-hud {
                height: 50px;
                padding: 5px 8px;
            }

            .hud-portrait {
                width: 35px;
                height: 35px;
                font-size: 1.2rem;
            }

            .hud-name {
                font-size: 0.9rem;
            }

            .bar-track {
                width: 60px;
                height: 7px;
            }

            #rpg-msg-box {
                min-height: 90px;
                max-height: 120px;
                padding: 8px;
            }

            .msg-text {
                font-size: 0.95rem;
            }

            #battle-ui {
                height: 120px;
            }

            .battle-submenu {
                bottom: 135px;
            }

            #battle-player-area {
                bottom: 130px;
            }
        }

        @media (max-width:480px) {

            /* Extra small screens */
            .splash-title {
                font-size: 1.3rem;
            }

            .title-letter {
                margin: 0 1px;
            }

            .splash-start-btn {
                font-size: 0.65rem;
                padding: 12px 30px;
            }

            #battle-enemy-sprite {
                font-size: 3.5rem;
            }

            #battle-player-sprite {
                font-size: 2.5rem;
            }

            .vs-sprite {
                font-size: 2.8rem;
            }

            .vs-text {
                font-size: 1.5rem;
            }

            /* Ultra compact for tiny screens */
            #rpg-hud {
                height: 55px;
            }

            .hud-portrait {
                width: 32px;
                height: 32px;
                font-size: 1.2rem;
            }

            .hud-name {
                font-size: 0.85rem;
            }

            .bar-track {
                width: 55px;
            }

            .msg-text {
                font-size: 0.9rem;
            }

            .log-content {
                font-size: 0.75rem;
            }

            #battle-log {
                padding: 4px;
            }

            .enemy-name {
                font-size: 0.85rem;
            }
        }

        @media (max-width:380px) {

            /* Very small phones */
            .hud-name {
                display: none;
            }

            .bar-track {
                width: 50px;
            }

            .msg-speaker {
                font-size: 0.85rem;
            }

            .msg-text {
                font-size: 0.85rem;
            }

            .log-content {
                font-size: 0.7rem;
            }

            .splash-title {
                font-size: 1.1rem;
            }

            .splash-start-btn {
                font-size: 0.6rem;
                padding: 10px 25px;
            }
        }

        /* Name Screen Fix */
        #rpg-name-screen {
            overflow: auto;
            padding: 16px 0;
            justify-content: center;
            align-items: center;
        }

        .name-screen-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2a, #0d1d3d, #1a2a3a);
        }

        .name-screen-content {
            position: relative;
            z-index: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            padding: 20px;
        }

        .contract-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            width: 100%;
            padding: 0 12px;
            box-sizing: border-box;
        }

        .contract-paper {
            width: min(560px, 92vw);
            max-height: calc(100vh - 250px);
            overflow: auto;
            padding: 16px 18px;
            background: linear-gradient(180deg, #f8f4e8 0%, #f0ebe0 50%, #e8e2d5 100%);
            border-radius: 8px;
            color: #2a2a2a;
            font-family: 'VT323', monospace;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1), 0 8px 16px rgba(0, 0, 0, 0.1), 0 16px 32px rgba(0, 0, 0, 0.15);
            position: relative;
        }

        .contract-submit-btn {
            width: min(560px, 92vw);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            padding: 15px 30px;
            background: linear-gradient(180deg, #2a6a2a 0%, #1a4a1a 100%);
            border: 3px solid #4a4;
            border-radius: 12px;
            color: #fff;
            font-family: 'VT323', monospace;
            font-size: 1.4rem;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }

        .contract-submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(74, 255, 74, 0.3);
        }

        .contract-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .contract-logo {
            font-size: 2.5rem;
            filter: drop-shadow(2px 2px 2px rgba(0, 0, 0, 0.2));
        }

        .contract-company {
            text-align: center;
            flex: 1;
        }

        .contract-company h2 {
            font-family: 'Press Start 2P', monospace;
            font-size: 0.8rem;
            color: #1a3a6a;
            margin: 0 0 5px;
        }

        .contract-company p {
            font-size: 1rem;
            color: #666;
            margin: 0;
        }

        .contract-stamp {
            width: 60px;
            height: 60px;
            border: 3px solid #2a8a2a;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #2a8a2a;
            transform: rotate(15deg);
            opacity: 0.8;
        }

        .contract-stamp span {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .contract-stamp small {
            font-size: 0.5rem;
            font-weight: bold;
        }

        .contract-divider {
            height: 2px;
            background: linear-gradient(90deg, transparent, #1a3a6a, transparent);
            margin: 10px 0;
        }

        .contract-title {
            text-align: center;
            margin-bottom: 20px;
        }

        .doc-icon {
            font-size: 1.5rem;
            margin-right: 10px;
        }

        .contract-title h3 {
            font-family: 'Press Start 2P', monospace;
            font-size: 0.7rem;
            color: #1a3a6a;
            margin: 10px 0 5px;
            letter-spacing: 3px;
        }

        .doc-subtitle {
            font-size: 1rem;
            color: #888;
        }

        .contract-body {
            margin-bottom: 20px;
        }

        .contract-section {
            margin-bottom: 18px;
        }

        .contract-label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
            color: #444;
            margin-bottom: 8px;
        }

        .label-num {
            background: #1a3a6a;
            color: #fff;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .contract-input-wrapper {
            position: relative;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 4px;
            padding: 8px 12px;
        }

        #rpg-name-input {
            width: 100%;
            background: transparent;
            border: none;
            font-family: 'VT323', monospace;
            font-size: 1.6rem;
            color: #1a1a1a;
            outline: none;
        }

        #rpg-name-input::placeholder {
            color: #aaa;
        }

        .input-underline {
            position: absolute;
            bottom: 0;
            left: 5%;
            width: 90%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #1a3a6a, #1a3a6a, transparent);
        }

        .contract-input-wrapper:focus-within {
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 0 10px rgba(26, 58, 106, 0.2);
        }

        .name-error {
            color: #c00;
            font-size: 0.95rem;
            margin-top: 5px;
            min-height: 20px;
            text-align: center;
        }

        .gender-select {
            display: flex;
            gap: 10px;
        }

        .gender-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.7);
            border: 2px solid #ccc;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'VT323', monospace;
        }

        .gender-btn:hover {
            background: rgba(255, 255, 255, 0.9);
            border-color: #1a3a6a;
        }

        .gender-btn.active {
            background: rgba(26, 58, 106, 0.15);
            border-color: #1a3a6a;
            box-shadow: 0 0 10px rgba(26, 58, 106, 0.2);
        }

        .gender-icon {
            font-size: 2rem;
        }

        .gender-text {
            font-size: 1rem;
            color: #333;
        }

        .gender-btn.active .gender-text {
            color: #1a3a6a;
            font-weight: bold;
        }

        .dept-select {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .dept-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.7);
            border: 2px solid #ccc;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'VT323', monospace;
        }

        .dept-btn:hover {
            background: rgba(255, 255, 255, 0.9);
            border-color: #1a3a6a;
            transform: translateX(3px);
        }

        .dept-btn.active {
            background: rgba(26, 58, 106, 0.15);
            border-color: #1a3a6a;
            box-shadow: 0 0 10px rgba(26, 58, 106, 0.2);
        }

        .dept-icon {
            font-size: 1.4rem;
        }

        .dept-name {
            font-size: 1rem;
            color: #333;
        }

        .dept-btn.active .dept-name {
            color: #1a3a6a;
            font-weight: bold;
        }

        .employee-badge {
            display: flex;
            gap: 15px;
            background: linear-gradient(135deg, #1a3a6a 0%, #2a4a8a 100%);
            padding: 15px;
            border-radius: 8px;
            color: #fff;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .badge-photo-frame {
            width: 70px;
            height: 85px;
            background: #fff;
            border-radius: 6px;
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .badge-photo {
            font-size: 3rem;
        }

        .badge-details {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 3px;
        }

        .badge-name {
            font-size: 1.4rem;
            color: var(--gold);
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .badge-role {
            font-size: 1rem;
            color: #aaccff;
        }

        .badge-dept {
            font-size: 0.9rem;
            color: #88aadd;
        }

        .badge-id {
            font-size: 0.85rem;
            color: #6699cc;
            margin-top: 3px;
        }

        .badge-barcode {
            font-family: monospace;
            font-size: 0.7rem;
            color: #88aadd;
            letter-spacing: 2px;
            margin-top: 5px;
        }

        .contract-footer {
            border-top: 1px dashed #ccc;
            padding-top: 15px;
            margin-top: 15px;
        }

        .contract-signature {
            display: flex;
            justify-content: space-between;
            gap: 30px;
            margin-bottom: 10px;
        }

        .signature-line {
            flex: 1;
            text-align: center;
        }

        .signature-x {
            font-size: 1.5rem;
            color: #888;
        }

        .signature-signed {
            font-family: 'Brush Script MT', cursive;
            font-size: 1.3rem;
            color: #1a3a6a;
        }

        .signature-placeholder {
            border-top: 1px solid #666;
            padding-top: 5px;
            font-size: 0.85rem;
            color: #888;
            margin-top: 5px;
        }

        .contract-date {
            text-align: right;
            font-size: 0.95rem;
            color: #666;
        }

        /* ===== BUG FIX PATCH v4.0.1 ===== */

        /* Fix: Door Frame kleiner & besser positioniert */
        .map-door {
            width: 32px !important;
            height: 40px !important;
            pointer-events: none !important;
            /* Keine Klicks, nur BerÃ¼hrung */
        }

        .map-door .door-frame {
            width: 100% !important;
            height: 100% !important;
            border-width: 2px !important;
            border-radius: 4px 4px 0 0 !important;
        }

        .map-door .door-icon {
            font-size: 1.5rem !important;
        }

        .map-door .door-label {
            display: none !important;
            /* Label verstecken, stÃ¶rt */
        }

        /* Fix: Kisten nicht durchlaufbar - visueller Indikator */
        .map-chest {
            pointer-events: auto !important;
        }

        .map-chest:not(.opened)::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            transform: translateX(-50%);
            width: 24px;
            height: 4px;
            background: rgba(139, 69, 19, 0.5);
            border-radius: 2px;
        }

        /* Fix: Battle HP/MP Bars besser sichtbar */
        #battle-player-hud {
            width: 240px !important;
        }

        .battle-hud-frame {
            padding: 10px !important;
        }

        .player-bars-battle {
            gap: 6px !important;
        }

        .p-bar {
            display: flex !important;
            align-items: center !important;
            gap: 6px !important;
        }

        .p-bar-label {
            min-width: 24px !important;
            font-size: 0.8rem !important;
            color: #fff !important;
        }

        .p-bar-track {
            flex: 1 !important;
            min-width: 80px !important;
            height: 14px !important;
        }

        .p-bar-text {
            min-width: 55px !important;
            font-size: 0.8rem !important;
            color: #fff !important;
            text-align: right !important;
        }

        /* Fix: Player Info im Battle besser lesbar */
        .player-info-battle {
            min-width: 0 !important;
            flex: 1 !important;
        }

        .player-name-battle {
            font-size: 1rem !important;
            margin-bottom: 6px !important;
            color: var(--gold) !important;
        }
    </style>

    <script>
        (function () {
            // Verhindere doppelte Initialisierung
            if (window._bueroversum_init) return;
            window._bueroversum_init = true;

            document.addEventListener("DOMContentLoaded", function () {

                // ===== TWEMOJI PARSER =====
                function parseEmojis(element) {
                    if (typeof twemoji !== 'undefined' && element) {
                        twemoji.parse(element, {
                            folder: 'svg',
                            ext: '.svg',
                            base: 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/'
                        });
                    }
                }

                setTimeout(() => parseEmojis(document.body), 100);

                // ===== WIDGET (FIXED - Keine Duplikate) =====
                (function initWidget() {
                    if (window._bvWidgetInit) return;
                    window._bvWidgetInit = true;

                    const imgHost = document.getElementById("zuef-image-host");
                    if (imgHost && !imgHost.hasChildNodes()) {
                        const img = document.createElement("img");
                        img.src = "http://webshops.zuef.de/DE01BVG/media/71/pagebuilder/Karneval+Angebot+2026.png?size=256";
                        img.alt = "Flyer";
                        img.className = "zuef-promo-img";
                        imgHost.appendChild(img);
                    }

                    const card = document.querySelector(".zuef-premium-card");
                    if (card && !card._eventsBound) {
                        card._eventsBound = true;
                        card.addEventListener("mousemove", (e) => {
                            const rect = card.getBoundingClientRect();
                            const x = e.clientX - rect.left;
                            const y = e.clientY - rect.top;
                            card.style.transform = `perspective(1000px) rotateX(${((y - rect.height / 2) / (rect.height / 2)) * -5}deg) rotateY(${((x - rect.width / 2) / (rect.width / 2)) * 5}deg)`;
                            card.style.setProperty('--mx', x + 'px');
                            card.style.setProperty('--my', y + 'px');
                        });
                        card.addEventListener("mouseleave", () => card.style.transform = '');
                    }

                    if (!window._bvCountdownRunning) {
                        window._bvCountdownRunning = true;
                        const endDate = new Date("2026-02-18T23:59:59").getTime();

                        function tick() {
                            const diff = endDate - Date.now();
                            const dEl = document.getElementById("cd-d");
                            const hEl = document.getElementById("cd-h");
                            const mEl = document.getElementById("cd-m");
                            const sEl = document.getElementById("cd-s");

                            if (!dEl || !hEl || !mEl || !sEl) return;

                            if (diff <= 0) {
                                dEl.innerText = "00";
                                hEl.innerText = "00";
                                mEl.innerText = "00";
                                sEl.innerText = "00";
                                return;
                            }

                            dEl.innerText = Math.floor(diff / 86400000);
                            hEl.innerText = String(Math.floor((diff % 86400000) / 3600000)).padStart(2, '0');
                            mEl.innerText = String(Math.floor((diff % 3600000) / 60000)).padStart(2, '0');
                            sEl.innerText = String(Math.floor((diff % 60000) / 1000)).padStart(2, '0');
                        }

                        tick();
                        setInterval(tick, 1000);
                    }
                })();

                const contractDate = document.getElementById("contract-date");
                if (contractDate) {
                    contractDate.innerText = new Date().toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
                }

                // ===== EASTER EGG TRIGGER =====
                let clickCount = 0, clickTimer = null;
                const trigger = document.getElementById("zuef-secret-trigger");
                if (trigger) {
                    trigger.addEventListener("click", () => {
                        clickCount++;
                        clearTimeout(clickTimer);
                        clickTimer = setTimeout(() => clickCount = 0, 600);
                        if (clickCount >= 1) { clickCount = 0; openRPG(); }
                    });
                }

                // ===== GAME CONSTANTS =====
                const overlay = document.getElementById("rpg-overlay");
                const splash = document.getElementById("rpg-splash");
                const mapTrans = document.getElementById("map-transition");
                const canvas = document.getElementById("rpg-canvas");
                const ctx = canvas ? canvas.getContext("2d") : null;
                const playerEl = document.getElementById("rpg-player");
                const npcLayer = document.getElementById("rpg-npc-layer");
                const decoLayer = document.getElementById("rpg-deco-layer");
                const chestLayer = document.getElementById("rpg-chest-layer");
                const doorLayer = document.getElementById("rpg-door-layer");
                const cameraEl = document.getElementById("rpg-camera");
                const viewport = document.getElementById("rpg-viewport");
                const msgBox = document.getElementById("rpg-msg-box");
                const interactionHint = document.getElementById("interaction-hint");

                const TILE = 32;
                const VIEW_COLS = 27;
                const VIEW_ROWS = 17;
                const VIEW_WIDTH = VIEW_COLS * TILE;
                const VIEW_HEIGHT = VIEW_ROWS * TILE;

                // ===== CAMERA SYSTEM =====
                let cameraX = 0, cameraY = 0;
                let targetCameraX = 0, targetCameraY = 0;
                const CAMERA_SPEED = 0.15;
                let cameraAnimFrame = null;

                // Mobile Camera Deadzone - Kamera bewegt sich erst am Rand
                const isMobile = window.matchMedia('(max-width: 920px), (pointer: coarse)').matches;
                const DEADZONE_PERCENT = isMobile ? 0.25 : 0; // 25% Deadzone auf Mobile

                function updateCamera() {
                    if (!currentMap || currentMap.length === 0) return;

                    const mapWidth = (currentMap[0]?.length || VIEW_COLS) * TILE;
                    const mapHeight = currentMap.length * TILE;

                    // Mobile Deadzone: Kamera bewegt sich erst wenn Spieler auÃŸerhalb der Deadzone ist
                    if (isMobile && DEADZONE_PERCENT > 0) {
                        const deadzoneX = VIEW_WIDTH * DEADZONE_PERCENT;
                        const deadzoneY = VIEW_HEIGHT * DEADZONE_PERCENT;

                        const playerScreenX = player.x * TILE - cameraX;
                        const playerScreenY = player.y * TILE - cameraY;

                        // Nur bewegen wenn Spieler auÃŸerhalb der Deadzone ist
                        if (playerScreenX < deadzoneX) {
                            targetCameraX = player.x * TILE - deadzoneX;
                        } else if (playerScreenX > VIEW_WIDTH - deadzoneX) {
                            targetCameraX = player.x * TILE - (VIEW_WIDTH - deadzoneX);
                        }

                        if (playerScreenY < deadzoneY) {
                            targetCameraY = player.y * TILE - deadzoneY;
                        } else if (playerScreenY > VIEW_HEIGHT - deadzoneY) {
                            targetCameraY = player.y * TILE - (VIEW_HEIGHT - deadzoneY);
                        }
                    } else {
                        // Desktop: Kamera zentriert auf Spieler
                        targetCameraX = player.x * TILE - VIEW_WIDTH / 2 + TILE / 2;
                        targetCameraY = player.y * TILE - VIEW_HEIGHT / 2 + TILE / 2;
                    }

                    targetCameraX = Math.max(0, Math.min(targetCameraX, mapWidth - VIEW_WIDTH));
                    targetCameraY = Math.max(0, Math.min(targetCameraY, mapHeight - VIEW_HEIGHT));

                    if (mapWidth <= VIEW_WIDTH) targetCameraX = (mapWidth - VIEW_WIDTH) / 2;
                    if (mapHeight <= VIEW_HEIGHT) targetCameraY = (mapHeight - VIEW_HEIGHT) / 2;
                }

                function animateCamera() {
                    cameraX += (targetCameraX - cameraX) * CAMERA_SPEED;
                    cameraY += (targetCameraY - cameraY) * CAMERA_SPEED;

                    if (Math.abs(targetCameraX - cameraX) < 0.5) cameraX = targetCameraX;
                    if (Math.abs(targetCameraY - cameraY) < 0.5) cameraY = targetCameraY;

                    if (cameraEl) {
                        cameraEl.style.transform = `translate(${-cameraX}px, ${-cameraY}px)`;
                        // Set parallax offsets for different effect layers
                        document.documentElement.style.setProperty('--cam-x', (-cameraX * 0.5) + "px");
                        document.documentElement.style.setProperty('--cam-y', (-cameraY * 0.5) + "px");
                        document.documentElement.style.setProperty('--cam-x-windows', (-cameraX * 0.3) + "px");
                        document.documentElement.style.setProperty('--cam-y-windows', (-cameraY * 0.3) + "px");
                    }
                    cameraAnimFrame = requestAnimationFrame(animateCamera);
                }

                function startCameraLoop() {
                    if (!cameraAnimFrame) cameraAnimFrame = requestAnimationFrame(animateCamera);
                }

                function stopCameraLoop() {
                    if (cameraAnimFrame) { cancelAnimationFrame(cameraAnimFrame); cameraAnimFrame = null; }
                }

                function snapCamera() {
                    updateCamera();
                    cameraX = targetCameraX;
                    cameraY = targetCameraY;
                    if (cameraEl) cameraEl.style.transform = `translate(${-cameraX}px, ${-cameraY}px)`;
                }

                // ===== NPC MOVEMENT =====
                function startNPCMovementLoop() {
                    if (npcMoveInterval) clearInterval(npcMoveInterval);
                    npcMoveInterval = setInterval(updateNPCs, NPC_MOVE_SPEED);
                }

                function stopNPCMovementLoop() {
                    if (npcMoveInterval) { clearInterval(npcMoveInterval); npcMoveInterval = null; }
                }

                function updateNPCs() {
                    if (gameState !== "MAP" || isTransitioning || isBattleStarting) return;

                    npcs.forEach((npc, i) => {
                        if (!npc.wander) return;

                        // Initialize runtime props if missing
                        if (typeof npc.moveState === 'undefined') {
                            npc.moveState = 'idle';
                            npc.moveTimer = Math.floor(Math.random() * 5) + 2;
                        }

                        if (npc.moveState === 'idle') {
                            npc.moveTimer--;
                            if (npc.moveTimer <= 0) {
                                npc.moveState = 'moving';
                                npc.stepsRemaining = Math.floor(Math.random() * 4) + 1; // 1-4 steps
                                // Pick random direction: 0=up, 1=right, 2=down, 3=left
                                const dir = Math.floor(Math.random() * 4);
                                npc.dx = (dir === 1) ? 1 : (dir === 3) ? -1 : 0;
                                npc.dy = (dir === 2) ? 1 : (dir === 0) ? -1 : 0;
                            }
                        } else if (npc.moveState === 'moving') {
                            const moved = tryMoveNPC(npc, npc.dx, npc.dy, i);
                            npc.stepsRemaining--;
                            if (!moved || npc.stepsRemaining <= 0) {
                                npc.moveState = 'idle';
                                npc.moveTimer = Math.floor(Math.random() * 8) + 4; // pause duration
                            }
                        }
                    });
                    checkNearbyInteractables();
                }

                function tryMoveNPC(npc, dx, dy, index) {
                    const nx = npc.x + dx;
                    const ny = npc.y + dy;

                    // Check bounds
                    const mapCols = currentMap[0]?.length || 0;
                    const mapRows = currentMap.length;
                    if (nx < 0 || nx >= mapCols || ny < 0 || ny >= mapRows) return false;

                    // Check collision with walls/objects
                    const tile = currentMap[ny][nx];
                    const tileData = TILES[tile] || {};
                    if (tileData.block) return false;

                    // Check collision with player
                    if (nx === player.x && ny === player.y) {
                        // If enemy walks into player -> START BATTLE
                        if (npc.type === "enemy" && gameState === "MAP" && !isBattleStarting && !isTransitioning) {
                            startBattle(npc);
                        }
                        return false;
                    }

                    // Check collision with other NPCs
                    if (npcs.some((n, j) => index !== j && n.x === nx && n.y === ny)) return false;

                    // Check collision with chests
                    if (currentChests.some(c => c.x === nx && c.y === ny && !c.opened)) return false;

                    // Move
                    npc.x = nx;
                    npc.y = ny;

                    // Update DOM
                    if (npcLayer && npcLayer.children[index]) {
                        const el = npcLayer.children[index];
                        el.style.transition = `left ${NPC_MOVE_SPEED}ms linear, top ${NPC_MOVE_SPEED}ms linear`;
                        el.style.left = (npc.x * TILE) + "px";
                        el.style.top = (npc.y * TILE) + "px";

                        // Facing (visual only)
                        const spriteSpan = el.querySelector(".npc-sprite") || el; // fallback
                        if (dx > 0) el.style.transform = "scaleX(-1)";
                        else if (dx < 0) el.style.transform = "scaleX(1)";
                        // Note: scaleX flips text too, but simple sprites are emojis so mostly fine.
                        // Ideally we flip only sprite, but structure is: 
                        // <div class="rpg-npc"> <span name>... <span indicator>... TEXT_NODE_EMOJI </div>
                        // The emoji is a text node. Flipping the div flips the name too.
                        // Let's remove the flip for now to avoid upside down text, 
                        // or just accept they don't face left/right visually for now.
                        el.style.transform = "";
                    }
                    return true;
                }

                // ===== NAME CENSORSHIP =====
                const BANNED_WORDS = [
                    'fuck', 'shit', 'ass', 'bitch', 'damn', 'bastard', 'dick', 'cock', 'pussy',
                    'arsch', 'scheiÃŸe', 'scheisse', 'fick', 'ficken', 'hurensohn', 'wichser', 'fotze',
                    'missgeburt', 'behindert', 'schwuchtel', 'nazi', 'hitler', 'hure', 'nutte',
                    'penis', 'vagina', 'titten', 'schwanz', 'muschi', 'nigger', 'nigga', 'kanake',
                    'spast', 'idiot', 'kacke', 'pisse', 'schlampe', 'drecksau', 'arschloch'
                ];

                function containsBannedWord(name) {
                    let cleaned = name.toLowerCase().replace(/[|_]/g, '').replace(/[^a-zÃ¤Ã¶Ã¼ÃŸ]/g, '');
                    const leetMap = { '4': 'a', '@': 'a', '3': 'e', '1': 'i', '!': 'i', '0': 'o', '5': 's', '$': 's', '7': 't' };
                    for (const [leet, char] of Object.entries(leetMap)) {
                        cleaned = cleaned.split(leet).join(char);
                    }
                    return BANNED_WORDS.some(word => cleaned.includes(word));
                }

                function validateName(name) {
                    if (!name || name.trim().length === 0) return { valid: false, error: "Bitte gib einen Namen ein!" };
                    if (name.trim().length < 2) return { valid: false, error: "Name muss mindestens 2 Zeichen haben!" };
                    if (name.trim().length > 12) return { valid: false, error: "Name darf maximal 12 Zeichen haben!" };
                    if (containsBannedWord(name)) return { valid: false, error: "âš ï¸ Dieser Name ist nicht erlaubt!" };
                    if (/^\d+$/.test(name.trim())) return { valid: false, error: "Name darf nicht nur aus Zahlen bestehen!" };
                    return { valid: true, error: "" };
                }

                // ===== TILE DEFINITIONS =====
                const TILES = {
                    0: { bg: "#8090a8", name: "floor" },
                    1: { bg: "#2a3444", block: true, name: "wall" },
                    2: { bg: "#5d4037", block: true, name: "desk" },
                    3: { bg: "#2e7d32", block: true, name: "plant" },
                    4: { bg: "#6a7a8a", name: "carpet" },
                    5: { bg: "#8090a8", name: "rug" },
                    6: { bg: "#4a7c59", name: "door_normal" },
                    7: { bg: "#c9a227", name: "door_boss" },
                    8: { bg: "#5c6bc0", block: true, name: "cabinet" },
                    9: { bg: "#607d8b", block: true, name: "printer" },
                    10: { bg: "#455a64", block: true, name: "shelf" },
                    11: { bg: "#6d4c41", block: true, name: "chair" },
                    12: { bg: "#78909c", block: true, name: "window" },
                    13: { bg: "#90a4ae", name: "floor_light" },
                    14: { bg: "#37474f", block: true, name: "server" },
                    15: { bg: "#8d6e63", block: true, name: "couch" },
                    16: { bg: "#546e7a", name: "floor_tile" },
                    17: { bg: "#455a64", block: true, name: "pillar" },
                    18: { bg: "#78909c", name: "floor_dark" },
                    19: { bg: "#4db6ac", block: true, name: "water_cooler" },
                    20: { bg: "#ff7043", block: true, name: "vending" }
                };

                const DECORATIONS = {
                    desk: { emoji: "ğŸ–¥ï¸", offset: { x: 4, y: -8 } },
                    plant: { emoji: "ğŸŒ¿", offset: { x: 4, y: -6 } },
                    printer: { emoji: "ğŸ–¨ï¸", offset: { x: 2, y: -8 } },
                    cabinet: { emoji: "ğŸ—„ï¸", offset: { x: 4, y: -6 } },
                    shelf: { emoji: "ğŸ“š", offset: { x: 2, y: -8 } },
                    chair: { emoji: "ğŸª‘", offset: { x: 4, y: -4 } },
                    server: { emoji: "ğŸ’»", offset: { x: 2, y: -8 } },
                    couch: { emoji: "ğŸ›‹ï¸", offset: { x: 0, y: -6 } },
                    coffee: { emoji: "â˜•", offset: { x: 8, y: -4 } },
                    lamp: { emoji: "ğŸ’¡", offset: { x: 8, y: -12 } },
                    clock: { emoji: "ğŸ•", offset: { x: 8, y: -4 } },
                    poster: { emoji: "ğŸ–¼ï¸", offset: { x: 4, y: -8 } },
                    water_cooler: { emoji: "ğŸš°", offset: { x: 4, y: -6 } },
                    vending: { emoji: "ğŸ¥¤", offset: { x: 2, y: -8 } }
                };

                // ===== ENEMIES =====
                const ENEMIES = {
                    telefon: { name: "Telefonterrorist", sprite: "ğŸ“", hp: 40, atk: 8, def: 2, gold: 25, exp: 15, vsMessage: "Klingel Klingel! Gehe jetzt dran." },
                    spam: { name: "Spam-Mail-Flut", sprite: "ğŸ“§", hp: 35, atk: 7, def: 1, gold: 20, exp: 12, vsMessage: "Du hast sehr viele Spam-Mails drauf!" },
                    drucker: { name: "Drucker-DÃ¤mon", sprite: "ğŸ–¨ï¸", hp: 55, atk: 12, def: 3, gold: 35, exp: 20, vsMessage: "Drucken wir noch mehr Papier aus, Okay?" },
                    kaffee: { name: "Kaffee-Gremlin", sprite: "â˜•", hp: 45, atk: 9, def: 2, gold: 25, exp: 15, vsMessage: "Komm! Ich bin doch ein leckerer Kaffee!" },
                    meeting: { name: "Meeting-Monster", sprite: "ğŸ“Š", hp: 70, atk: 15, def: 4, gold: 45, exp: 28, vsMessage: "So leute, was haben wir zu Besprechen?" },
                    handy: { name: "Handy-Sucht", sprite: "ğŸ“±", hp: 50, atk: 11, def: 2, gold: 30, exp: 18, vsMessage: "Komm nutze mich! Wir schauen im Social-Media was!" },
                    notification: { name: "Benachrichtigungs-Spam", sprite: "ğŸ””", hp: 45, atk: 10, def: 2, gold: 28, exp: 16, vsMessage: "Du hast zu viele Benachrichtigungen! Gehe die mal nach." },
                    excel: { name: "Excel-Fehler", sprite: "ğŸ“‰", hp: 60, atk: 14, def: 3, gold: 40, exp: 25, vsMessage: "Du hast zu viele Excelfehlern. Bitte behebe die nochmal!" },
                    deadline: { name: "Deadline-Stress", sprite: "â°", hp: 75, atk: 18, def: 4, gold: 55, exp: 35, vsMessage: "Kommt leute! Wir haben ne Deadline, was haben wir!" },
                    bug: { name: "Software-Bug", sprite: "ğŸ›", hp: 50, atk: 12, def: 2, gold: 32, exp: 22, vsMessage: "Oh mann... Es gibt mal wieder Bugs im Programm..." },
                    password: { name: "Passwort-Vergessen", sprite: "ğŸ”", hp: 40, atk: 8, def: 5, gold: 28, exp: 18, vsMessage: "Mist, habe meine Passwort wieder vergessen!" },
                    update: { name: "Windows-Update", sprite: "ğŸ”„", hp: 80, atk: 10, def: 6, gold: 50, exp: 30, vsMessage: "Jetzt kommt ein neues Windows-Update!" },
                    wifi: { name: "WLAN-Ausfall", sprite: "ğŸ“¶", hp: 55, atk: 13, def: 3, gold: 38, exp: 24, vsMessage: "Oh, Wlan-Ausfall. Kann jemand den Router neustarten?" },
                    kunde: { name: "Schwieriger Kunde", sprite: "ğŸ˜¤", hp: 65, atk: 16, def: 3, gold: 45, exp: 28, vsMessage: "Ich sagte: Das ist Papier brauchte! Ist es so Schwer?!" },
                    praktikant: { name: "Verwirrter Praktikant", sprite: "ğŸ¤·", hp: 30, atk: 5, def: 1, gold: 15, exp: 10, vsMessage: "Oh mann... Was mache ich denn jetzt?" },
                    kantine: { name: "Kantinen-Essen", sprite: "ğŸ²", hp: 45, atk: 20, def: 1, gold: 25, exp: 15, vsMessage: "Komm, Ess mich. Ich bin ja leckeres Essen!" },
                    feueralarm: { name: "Fehlalarm", sprite: "ğŸš¨", hp: 90, atk: 8, def: 8, gold: 60, exp: 40, vsMessage: "Fehleralarm! Fehleralarm!" },
                    boss: {
                        name: "Der GeschÃ¤ftsfÃ¼hrer", sprite: "ğŸ‘”", hp: 300, atk: 25, def: 6, gold: 500, exp: 200, isBoss: true,
                        vsMessage: "Du wagst es, gegen mich anzutreten? Nawarten Sie, bis ich meine volle Kraft entfessle!",
                        phases: [
                            { hpPercent: 100, atk: 25, dialog: "Zeit fÃ¼r deine Leistungsbeurteilung!" },
                            { hpPercent: 50, atk: 35, dialog: "Nicht schlecht! Jetzt wird es ernst! ğŸ“ˆ" },
                            { hpPercent: 25, atk: 45, dialog: "UNMÃ–GLICH! Ich KÃœNDIGE dich!" }
                        ]
                    }
                };

                // ===== SHOP & CHEST ITEMS =====
                const SHOP_ITEMS = [
                    { id: "kaffee", name: "Kaffee", icon: "â˜•", desc: "Heilt 40 HP", price: 25, heal: 40 },
                    { id: "energy", name: "Energy Drink", icon: "âš¡", desc: "Heilt 100 HP", price: 60, heal: 100 },
                    { id: "donut", name: "BÃ¼ro-Donut", icon: "ğŸ©", desc: "Heilt 30 HP + 3 MP", price: 35, heal: 30, mpHeal: 3 },
                    { id: "sandwich", name: "Sandwich", icon: "ğŸ¥ª", desc: "Heilt 60 HP", price: 45, heal: 60 },
                    { id: "kuli", name: "Kugelschreiber+", icon: "ğŸ–Šï¸", desc: "+5 Angriff", price: 100, atkBoost: 5 },
                    { id: "aktenkoffer", name: "Aktenkoffer", icon: "ğŸ’¼", desc: "+25 Max HP", price: 150, hpBoost: 25 },
                    { id: "krawatte", name: "Power-Krawatte", icon: "ğŸ‘”", desc: "+3 Verteidigung", price: 120, defBoost: 3 },
                    { id: "thermos", name: "Thermoskanne", icon: "ğŸ«–", desc: "+5 Max MP", price: 80, mpBoost: 5 },
                    { id: "vitamins", name: "Vitamintabletten", icon: "ğŸ’Š", desc: "Heilt 150 HP", price: 100, heal: 150 },
                    { id: "superKaffee", name: "Super-Espresso", icon: "â˜•", desc: "Heilt alles!", price: 200, heal: 9999, mpHeal: 99 }
                ];

                const CHEST_ITEMS = [
                    { name: "GoldmÃ¼nzen", icon: "ğŸ’°", type: "gold", amount: 50 },
                    { name: "Goldschatz", icon: "ğŸ’°", type: "gold", amount: 100 },
                    { name: "Bonus-Kaffee", icon: "â˜•", type: "item", itemId: "kaffee" },
                    { name: "Energy Drink", icon: "âš¡", type: "item", itemId: "energy" },
                    { id: "tacker", name: "Geheimer Tacker", icon: "ğŸ“", type: "atk", amount: 3 },
                    { id: "vitamins", name: "Vitamintabletten", icon: "ğŸ’Š", type: "hp", amount: 15 },
                    { id: "motivation", name: "Motivation", icon: "â­", type: "exp", amount: 20 },
                    { id: "donut", name: "BÃ¼ro-Snack", icon: "ğŸª", type: "item", itemId: "donut" },
                    { id: "akten", name: "Geheime Akten", icon: "ğŸ“", type: "exp", amount: 50 },
                    { id: "sandwich", name: "Bonus-Sandwich", icon: "ğŸ¥ª", type: "item", itemId: "sandwich" }
                ];

                // ===== SKILL SHOP ITEMS =====
                const SKILL_ITEMS = [
                    { id: "tacker", name: "Tacker-Angriff", icon: "ğŸ“", desc: "Klassischer Tacker-Angriff", price: 100, dmgMult: 2, mpCost: 4 },
                    { id: "kaffee", name: "Kaffee-Wurf", icon: "â˜•", desc: "Energiegeladener Kaffee-Wurf", price: 150, dmgMult: 2.5, mpCost: 6 },
                    { id: "meeting", name: "Meeting einberufen", icon: "ğŸ“Š", desc: "Extrem effektive Meeting-Bombe", price: 200, dmgMult: 3, mpCost: 8 },
                    { id: "papier", name: "Papier-Papiertiger", icon: "ğŸ“„", desc: "Papier-basierter Angriff", price: 120, dmgMult: 2.2, mpCost: 5 },
                    { id: "fax", name: "Fax-Blitz", icon: "ğŸ“ ", desc: "Schneller Fax-Angriff", price: 180, dmgMult: 2.8, mpCost: 7 },
                    { id: "printer", name: "Drucker-Crash", icon: "ğŸ–¨ï¸", desc: "Chaotischer Drucker-Crash", price: 220, dmgMult: 3.2, mpCost: 9 }
                ];

                // ===== DOORS =====
                const DOORS = {
                    buero_to_flur: { from: "buero", fromX: 33, fromY: 10, to: "flur", toX: 1, toY: 8, label: "Flur" },
                    flur_to_buero: { from: "flur", fromX: 0, fromY: 8, to: "buero", toX: 32, toY: 10, label: "Einkauf" },

                    zentrale_to_flur: { from: "zentrale", fromX: 1, fromY: 6, to: "flur", toX: 18, toY: 8, label: "Flur" },
                    flur_to_zentrale: { from: "flur", fromX: 19, fromY: 8, to: "zentrale", toX: 2, toY: 6, label: "Zentrale" },

                    boss_to_flur: { from: "boss_office", fromX: 0, fromY: 8, to: "flur", toX: 15, toY: 1, label: "Flur" },
                    flur_to_boss: { from: "flur", fromX: 15, fromY: 0, to: "boss_office", toX: 2, toY: 8, label: "ChefbÃ¼ro", requiresBossKey: true },

                    kantine_to_flur: { from: "kantine", fromX: 13, fromY: 0, to: "flur", toX: 16, toY: 18, label: "Flur" },
                    flur_to_kantine: { from: "flur", fromX: 16, fromY: 19, to: "kantine", toX: 13, toY: 1, label: "Kantine" },

                    lager_to_flur: { from: "lager", fromX: 10, fromY: 0, to: "flur", toX: 4, toY: 18, label: "Flur" },
                    flur_to_lager: { from: "flur", fromX: 4, fromY: 19, to: "lager", toX: 10, toY: 1, label: "Lager" },

                    konferenz_to_flur: { from: "konferenz", fromX: 7, fromY: 12, to: "flur", toX: 4, toY: 1, label: "Flur" },
                    flur_to_konferenz: { from: "flur", fromX: 4, fromY: 0, to: "konferenz", toX: 7, toY: 11, label: "Konferenz" },

                    zentrale_to_server: { from: "zentrale", fromX: 33, fromY: 8, to: "serverraum", toX: 2, toY: 5, label: "Server" },
                    server_to_zentrale: { from: "serverraum", fromX: 1, fromY: 5, to: "zentrale", toX: 32, toY: 8, label: "Zentrale" }
                };

                // ===== MAPS =====
                const MAPS = {
                    buero: {
                        name: "HauptbÃ¼ro - Einkauf",
                        cols: 35, rows: 22,
                        tiles: [
                            [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
                            [1, 12, 0, 0, 0, 0, 0, 12, 0, 0, 0, 0, 0, 0, 12, 0, 0, 0, 0, 0, 0, 12, 0, 0, 0, 0, 0, 12, 0, 0, 0, 0, 0, 12, 1],
                            [1, 0, 2, 11, 0, 0, 0, 0, 0, 2, 11, 0, 0, 0, 0, 0, 2, 11, 0, 0, 0, 0, 0, 2, 11, 0, 0, 0, 0, 2, 11, 0, 0, 0, 1],
                            [1, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 3, 0, 1],
                            [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                            [1, 0, 2, 11, 0, 0, 0, 8, 0, 0, 0, 0, 0, 0, 8, 0, 0, 2, 11, 0, 0, 0, 8, 0, 0, 0, 0, 0, 8, 0, 2, 11, 0, 0, 1],
                            [1, 0, 0, 0, 0, 0, 0, 0, 0, 4, 4, 4, 4, 4, 4, 4, 0, 0, 0, 0, 0, 0, 0, 0, 4, 4, 4, 4, 4, 0, 0, 0, 0, 0, 1],
                            [1, 0, 0, 0, 0, 3, 0, 0, 0, 4, 9, 0, 0, 0, 9, 4, 0, 0, 0, 3, 0, 0, 0, 0, 4, 0, 0, 0, 4, 0, 0, 0, 3, 0, 1],
                            [1, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 4, 0, 0, 0, 0, 0, 1],
                            [1, 0, 2, 11, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 2, 11, 0, 0, 4, 0, 0, 0, 4, 0, 2, 11, 0, 0, 1],
                            [1, 0, 0, 0, 0, 0, 0, 0, 0, 4, 4, 4, 4, 4, 4, 4, 0, 0, 0, 0, 0, 0, 0, 0, 4, 4, 4, 4, 4, 0, 0, 0, 0, 6, 1],
                            [1, 0, 0, 0, 0, 0, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                            [1, 0, 2, 11, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 3, 0, 0, 0, 0, 2, 11, 0, 0, 0, 3, 0, 0, 0, 3, 0, 2, 11, 0, 0, 1],
                            [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                            [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                            [1, 0, 2, 11, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 11, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 11, 0, 0, 1],
                            [1, 0, 0, 0, 0, 3, 0, 0, 0, 8, 0, 0, 0, 0, 8, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 8, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                            [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                            [1, 0, 2, 11, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 11, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 11, 0, 0, 1],
                            [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                            [1, 12, 0, 0, 0, 0, 0, 12, 0, 0, 0, 0, 0, 0, 12, 0, 0, 0, 0, 0, 0, 12, 0, 0, 0, 0, 0, 12, 0, 0, 0, 0, 0, 12, 1],
                            [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]
                        ],
                        decos: [{ x: 11, y: 8, type: "coffee" }, { x: 13, y: 8, type: "coffee" }, { x: 4, y: 1, type: "clock" }, { x: 18, y: 1, type: "poster" }, { x: 26, y: 7, type: "coffee" }],
                        chests: [{ x: 30, y: 3, type: "normal" }, { x: 5, y: 17, type: "normal" }, { x: 28, y: 15, type: "rare" }],
                        npcs: [
                            {
                                x: 3, y: 2, type: "talk", sprite: "ğŸ‘¨â€ğŸ’»", name: "Justin", role: "Azubi & Entwickler",
                                dialog: ["Hey! Ich bin Justin. Willkommen im BÃ¼roVersum!", "Tipp: DrÃ¼cke [C] fÃ¼r die Cheat-Konsole. ğŸ˜‰", "Vergiss nicht: Der Flur ist gefÃ¤hrlicher als er aussiehtâ€¦"],
                                choiceId: "justin_help", choicePrompt: "Kann ich dir helfen?"
                            },
                            {
                                x: 10, y: 2, type: "talk", sprite: "ğŸ‘¨â€ğŸ¦±", name: "Jannik", role: "Azubi Einkauf",
                                dialog: ["Moin! Ich bin Jannik.", "Im Einkauf geht's oft um Timing.", "Hol dir was fÃ¼r Angriff oder Max-HP!"],
                                wander: true
                            },
                            {
                                x: 17, y: 2, type: "talk", sprite: "ğŸ‘©â€ğŸ¦±", name: "Hamda", role: "Azubi Einkauf",
                                dialog: ["Hi! Hamda hier.", "Orientier dich an den TÃ¼ren (ğŸšª).", "Du schaffst das! ğŸ’ª"],
                                wander: true
                            },
                            {
                                x: 3, y: 9, type: "talk", sprite: "ğŸ‘©", name: "Deborha", role: "Azubi Einkauf",
                                dialog: ["Hey! Deborha hier.", "Kaffee ist quasi eine Superkraft. â˜•"],
                                wander: true
                            },
                            {
                                x: 12, y: 8, type: "shop", sprite: "ğŸ›’", name: "HÃ¤ndler Hans", role: "VerkÃ¤ufer",
                                dialog: ["Ich habe alles was du brauchst!", "Kaffee? Donuts? Alles da!"]
                            },
                            {
                                x: 14, y: 8, type: "skillshop", sprite: "ğŸ“š", name: "Meister Markus", role: "Skill-Trainer",
                                dialog: ["Willkommen zum Skill-Training!", "Lerne neue mÃ¤chtige FÃ¤higkeiten!"]
                            },


                            { x: 20, y: 9, type: "enemy", sprite: "ğŸ“", name: "Telefonterror", enemyId: "telefon" },
                            { x: 6, y: 12, type: "enemy", sprite: "ğŸ“§", name: "Spam-Mail", enemyId: "spam" },
                            { x: 28, y: 8, type: "enemy", sprite: "ğŸ“‰", name: "Excel-Fehler", enemyId: "excel" },
                            { x: 15, y: 16, type: "enemy", sprite: "ğŸ¤·", name: "Praktikant", enemyId: "praktikant" }
                        ],
                        start: { x: 5, y: 7 }
                    },

                    flur: {
                        name: "Hauptflur",
                        cols: 20, rows: 20,
                        tiles: (function () {
                            let t = [];
                            for (let y = 0; y < 20; y++) {
                                t[y] = [];
                                for (let x = 0; x < 20; x++) {
                                    if (y === 0 || y === 19 || x === 0 || x === 19) t[y][x] = 1; // Wall
                                    else t[y][x] = 13; // Floor everywhere (less plants)
                                }
                            }

                            // Deko-Pflanzen (Tile 3 - Block) in Ecken
                            t[1][1] = 3; t[1][2] = 3; t[2][1] = 3;
                            t[1][18] = 3; t[1][17] = 3; t[2][18] = 3;
                            t[18][1] = 3; t[18][2] = 3; t[17][1] = 3;
                            t[18][18] = 3; t[18][17] = 3; t[17][18] = 3;

                            // Central Carpet Path (Tile 4)
                            for (let x = 2; x < 18; x++) { t[8][x] = 4; t[9][x] = 4; } // Horizontal
                            for (let y = 2; y < 18; y++) { t[y][9] = 4; t[y][10] = 4; } // Vertical Center 

                            // Paths to doors
                            // Left (Einkauf)
                            t[8][1] = 4; t[9][1] = 4;
                            // Right (Zentrale)
                            t[8][18] = 4; t[9][18] = 4;
                            // Bottom Left (Lager 4,19)
                            for (let y = 10; y < 19; y++) t[y][4] = 4;
                            // Bottom Right (Kantine 16,19)
                            for (let y = 10; y < 19; y++) t[y][16] = 4;
                            // Top Left (Konferenz 4,0)
                            for (let y = 1; y < 8; y++) t[y][4] = 4;
                            // Top Right (Boss 15,0) - Shifted from 16 to 15
                            for (let y = 1; y < 8; y++) t[y][15] = 4;

                            // Connect vertical paths to horizontal center path
                            t[8][4] = 4; t[9][4] = 4; // Lager/Konf connection point
                            t[8][16] = 4; t[9][16] = 4; // Kantine connection point
                            t[8][15] = 4; t[9][15] = 4; // Boss connection point

                            // Doors
                            t[8][0] = 6;   // Einkauf
                            t[8][19] = 6;  // Zentrale
                            t[19][16] = 6; // Kantine
                            t[19][4] = 6;  // Lager
                            t[0][4] = 6;   // Konferenz
                            t[0][15] = 7;  // Boss (shifted to 15)

                            return t;
                        })(),
                        decos: [
                            { x: 9, y: 7, type: "water_cooler" }, { x: 11, y: 7, type: "poster" }
                        ],
                        chests: [{ x: 2, y: 16, type: "normal" }, { x: 17, y: 3, type: "rare" }],
                        npcs: [
                            { x: 16, y: 10, type: "talk", sprite: "ğŸ‘¨â€ğŸ’¼", name: "Andreas", role: "Verkauf", dialog: ["Guten Tag!"], choiceId: "andreas_quest", choicePrompt: "Ich suche etwas...", wander: true },
                            { x: 5, y: 5, type: "enemy", sprite: "ğŸ“", name: "Telefonterror", enemyId: "telefon", wander: true },
                            { x: 15, y: 15, type: "enemy", sprite: "ğŸ“§", name: "Spam-Mail", enemyId: "spam" },
                            { x: 15, y: 5, type: "enemy", sprite: "ğŸ“‰", name: "Excel-Fehler", enemyId: "excel" },
                            { x: 5, y: 15, type: "enemy", sprite: "ğŸ¤·", name: "Praktikant", enemyId: "praktikant", wander: true },
                        ],
                        start: { x: 5, y: 9 }
                    },

                    zentrale: {
                        name: "Zentrale",
                        cols: 35, rows: 22,
                        tiles: (function () {
                            let t = [];
                            for (let y = 0; y < 22; y++) {
                                t[y] = [];
                                for (let x = 0; x < 35; x++) {
                                    if (y === 0 || y === 21 || x === 0 || x === 34) t[y][x] = 1;
                                    else if ((y === 1 || y === 20) && (x % 7 === 0)) t[y][x] = 12;
                                    else if (y === 1 || y === 20) t[y][x] = 13;
                                    else if (x === 1 && y === 6) t[y][x] = 6;
                                    else if (x === 33 && y === 8) t[y][x] = 6;
                                    else if ((x === 8 || x === 9 || x === 14 || x === 15 || x === 24 || x === 25) && y === 3) t[y][x] = 14;
                                    else t[y][x] = y === 1 || y === 20 ? 13 : 0;
                                }
                            }
                            return t;
                        })(),
                        decos: [{ x: 12, y: 7, type: "coffee" }, { x: 13, y: 7, type: "coffee" }, { x: 25, y: 7, type: "coffee" }],
                        chests: [{ x: 31, y: 3, type: "rare" }, { x: 3, y: 18, type: "normal" }, { x: 28, y: 14, type: "normal" }],
                        npcs: [
                            {
                                x: 12, y: 8, type: "talk", sprite: "ğŸ‘¨â€ğŸ’»", name: "Sertac", role: "Zentrale / IT",
                                dialog: ["SelamÃ¼n aleykÃ¼m! ğŸ‘‹", "Ich bin Sertac â€“ Zentrale. Offiziell... Tja, was soll ich sagen. Ja man Digga...", "Manchmal hab ich keinen Bock mehr...", "Aber ohne die Zentrale lÃ¤uft hier gar nix â€“ alles landet bei mir digga.", "Wenn du schon da bistâ€¦ holst du mir Kaffee?"],
                                choiceId: "sertac_coffee", choicePrompt: "Holst du mir Kaffee?"
                            },
                            {
                                x: 4, y: 3, type: "talk", sprite: "ğŸ‘¨â€ğŸ«", name: "Herr Abend", role: "Ausbilder",
                                dialog: ["Guten Tag! Patrick Abend.", "Berichtsheft nicht vergessen. ğŸ˜„"]
                            },


                            { x: 21, y: 7, type: "enemy", sprite: "ğŸ“±", name: "Handy-Sucht", enemyId: "handy" },
                            { x: 4, y: 11, type: "enemy", sprite: "ğŸ””", name: "Notifications", enemyId: "notification" },
                            { x: 15, y: 14, type: "enemy", sprite: "ğŸ›", name: "Software-Bug", enemyId: "bug" },
                            { x: 26, y: 11, type: "enemy", sprite: "ğŸ”", name: "Passwort-Vergessen", enemyId: "password" }
                        ],
                        start: { x: 2, y: 6 }
                    },

                    kantine: {
                        name: "Kantine",
                        cols: 30, rows: 20,
                        tiles: (function () {
                            let t = [];
                            for (let y = 0; y < 20; y++) {
                                t[y] = [];
                                for (let x = 0; x < 30; x++) {
                                    if (y === 0 && x === 13) t[y][x] = 6;
                                    else if (y === 0 || y === 19 || x === 0 || x === 29) t[y][x] = 1;
                                    else if (y >= 3 && y <= 5 && x >= 3 && x <= 7) t[y][x] = 4;
                                    else if (y >= 3 && y <= 5 && x >= 12 && x <= 16) t[y][x] = 4;
                                    else if (y >= 3 && y <= 5 && x >= 21 && x <= 25) t[y][x] = 4;
                                    else if (y >= 10 && y <= 12 && x >= 3 && x <= 7) t[y][x] = 4;
                                    else if (y >= 10 && y <= 12 && x >= 12 && x <= 16) t[y][x] = 4;
                                    else if (y >= 10 && y <= 12 && x >= 21 && x <= 25) t[y][x] = 4;
                                    else if (y === 2 && x >= 1 && x <= 5) t[y][x] = 20;
                                    else t[y][x] = 16;
                                }
                            }
                            return t;
                        })(),
                        decos: [{ x: 2, y: 2, type: "vending" }, { x: 3, y: 2, type: "vending" }, { x: 5, y: 4, type: "coffee" }, { x: 14, y: 4, type: "coffee" }, { x: 23, y: 4, type: "coffee" }],
                        chests: [{ x: 27, y: 2, type: "rare" }, { x: 2, y: 17, type: "normal" }],
                        npcs: [

                            { x: 15, y: 8, type: "talk", sprite: "ğŸ‘¨â€ğŸ³", name: "Koch Werner", role: "Chefkoch", dialog: ["Mahlzeit! Werner hier.", "Heute gibt's Ãœberraschungseintopf!"] },
                            { x: 8, y: 4, type: "enemy", sprite: "ğŸ²", name: "Kantinen-Essen", enemyId: "kantine" },
                            { x: 22, y: 11, type: "enemy", sprite: "ğŸ²", name: "Kantinen-Essen", enemyId: "kantine" },
                            { x: 14, y: 14, type: "enemy", sprite: "ğŸ˜¤", name: "Hungriger Kunde", enemyId: "kunde", wander: true }
                        ],
                        start: { x: 13, y: 17 }
                    },

                    lager: {
                        name: "Lager",
                        cols: 28, rows: 18,
                        tiles: (function () {
                            let t = [];
                            for (let y = 0; y < 18; y++) {
                                t[y] = [];
                                for (let x = 0; x < 28; x++) {
                                    if (y === 0 || y === 17 || x === 0 || x === 27) t[y][x] = 1;
                                    else if (y === 0 && x === 10) t[y][x] = 6;
                                    else if ((x === 3 || x === 7 || x === 11 || x === 15 || x === 19 || x === 23) && y >= 3 && y <= 15 && y % 2 === 1) t[y][x] = 10;
                                    else if ((x === 4 || x === 8 || x === 12 || x === 16 || x === 20 || x === 24) && y >= 3 && y <= 15 && y % 2 === 1) t[y][x] = 10;
                                    else t[y][x] = 18;
                                }
                            }
                            t[0][10] = 6;
                            return t;
                        })(),
                        decos: [],
                        chests: [
                            { x: 5, y: 4, type: "normal" }, { x: 9, y: 4, type: "normal" }, { x: 13, y: 4, type: "rare" },
                            { x: 17, y: 4, type: "normal" }, { x: 21, y: 4, type: "normal" }, { x: 25, y: 4, type: "rare" },
                            { x: 5, y: 8, type: "normal" }, { x: 9, y: 8, type: "rare" }, { x: 13, y: 8, type: "normal" },
                            { x: 17, y: 8, type: "normal" }, { x: 21, y: 8, type: "normal" }, { x: 25, y: 8, type: "normal" },
                            { x: 5, y: 12, type: "rare" }, { x: 9, y: 12, type: "normal" }, { x: 13, y: 12, type: "normal" },
                            { x: 17, y: 12, type: "rare" }, { x: 21, y: 12, type: "normal" }, { x: 25, y: 12, type: "rare" }
                        ],
                        npcs: [
                            { x: 14, y: 10, type: "talk", sprite: "ğŸ‘·", name: "Lagerarbeiter Tim", role: "Lager", dialog: ["Hey! Tim hier.", "Im Lager gibt's viele SchÃ¤tze."] },
                            { x: 6, y: 6, type: "enemy", sprite: "ğŸ“¦", name: "Fallende Kiste", enemyId: "praktikant" },
                            { x: 18, y: 6, type: "enemy", sprite: "ğŸ”„", name: "Windows-Update", enemyId: "update" },
                            { x: 12, y: 14, type: "enemy", sprite: "ğŸ“¶", name: "WLAN-Ausfall", enemyId: "wifi" }
                        ],
                        start: { x: 10, y: 1 }
                    },

                    serverraum: {
                        name: "Serverraum",
                        cols: 25, rows: 16,
                        tiles: (function () {
                            let t = [];
                            for (let y = 0; y < 16; y++) {
                                t[y] = [];
                                for (let x = 0; x < 25; x++) {
                                    if (y === 0 || y === 15 || x === 0 || x === 24) t[y][x] = 1;
                                    else if (x === 1 && y === 5) t[y][x] = 6;
                                    else if ((x === 4 || x === 8 || x === 12 || x === 16 || x === 20) && y >= 2 && y <= 13) t[y][x] = 14;
                                    else t[y][x] = 18;
                                }
                            }
                            return t;
                        })(),
                        decos: [],
                        chests: [{ x: 22, y: 2, type: "rare" }, { x: 22, y: 13, type: "rare" }, { x: 6, y: 7, type: "normal" }],
                        npcs: [
                            { x: 10, y: 7, type: "talk", sprite: "ğŸ¤–", name: "Server-Admin", role: "IT", dialog: ["*BEEP BOOP*", "Server-Status: Online."] },
                            { x: 6, y: 4, type: "enemy", sprite: "ğŸ›", name: "Kritischer Bug", enemyId: "bug" },
                            { x: 14, y: 10, type: "enemy", sprite: "ğŸ”„", name: "Updates", enemyId: "update" },
                            { x: 18, y: 7, type: "enemy", sprite: "ğŸš¨", name: "Fehlalarm", enemyId: "feueralarm" }
                        ],
                        start: { x: 2, y: 5 }
                    },

                    konferenz: {
                        name: "Konferenzraum",
                        cols: 22, rows: 14,
                        tiles: (function () {
                            let t = [];
                            for (let y = 0; y < 14; y++) {
                                t[y] = [];
                                for (let x = 0; x < 22; x++) {
                                    if (y === 0 || y === 13 || x === 0 || x === 21) t[y][x] = 1;
                                    else if (y === 12 && x === 7) t[y][x] = 6;
                                    else if (y >= 4 && y <= 9 && x >= 6 && x <= 15) t[y][x] = 4;
                                    else if (y === 1 && (x === 5 || x === 10 || x === 15)) t[y][x] = 12;
                                    else t[y][x] = 0;
                                }
                            }
                            return t;
                        })(),
                        decos: [{ x: 10, y: 6, type: "coffee" }, { x: 11, y: 6, type: "coffee" }, { x: 3, y: 2, type: "poster" }, { x: 18, y: 2, type: "poster" }],
                        chests: [{ x: 19, y: 2, type: "normal" }, { x: 2, y: 11, type: "normal" }],
                        npcs: [
                            { x: 10, y: 5, type: "talk", sprite: "ğŸ‘”", name: "Manager Stefan", role: "Management", dialog: ["Ah, ein Teilnehmer!", "Wir besprechen hier KPIs."] },
                            { x: 8, y: 7, type: "enemy", sprite: "ğŸ“Š", name: "Endlos-Meeting", enemyId: "meeting" },
                            { x: 13, y: 7, type: "enemy", sprite: "ğŸ“Š", name: "PowerPoint-Terror", enemyId: "meeting" }
                        ],
                        start: { x: 7, y: 11 }
                    },

                    boss_office: {
                        name: "ChefbÃ¼ro",
                        cols: 24, rows: 16,
                        tiles: (function () {
                            let t = [];
                            for (let y = 0; y < 16; y++) {
                                t[y] = [];
                                for (let x = 0; x < 24; x++) {
                                    if (y === 0 || y === 15 || x === 0 || x === 23) t[y][x] = 1;
                                    else t[y][x] = 4; // Carpet floor
                                }
                            }
                            // Windows
                            t[0][4] = 12; t[0][6] = 12; t[0][17] = 12; t[0][19] = 12;
                            t[0][10] = 12; t[0][13] = 12;

                            // Desk (Tile 2 = blocked)
                            for (let y = 5; y < 8; y++) for (let x = 10; x < 14; x++) t[y][x] = 2;

                            // Plants
                            t[1][1] = 3; t[1][22] = 3; t[14][1] = 3; t[14][22] = 3;

                            // Door back to Flur
                            t[8][0] = 6;

                            return t;
                        })(),
                        decos: [{ x: 12, y: 4, type: "lamp" }, { x: 13, y: 4, type: "coffee" }, { x: 12, y: 8, type: "chair" }],
                        chests: [{ x: 22, y: 2, type: "rare" }, { x: 22, y: 13, type: "rare" }],
                        npcs: [
                            { x: 12, y: 4, type: "enemy", sprite: "ğŸ‘”", name: "Der GeschÃ¤ftsfÃ¼hrer", enemyId: "boss", isBoss: true }
                        ],
                        start: { x: 2, y: 8 }
                    }
                };

                // ===== GAME STATE =====
                let gameState = "SPLASH";
                let player = {};
                let keysHeld = {}, directionHistory = [], moveInterval = null, lastMoveTime = 0;
                let npcMoveInterval = null;
                const NPC_MOVE_SPEED = 500; // ms per step
                let currentMapId = "", currentMap = [], npcs = [], currentDecos = [], currentChests = [];
                let currentEnemy = null, enemyHp = 0, enemyMaxHp = 0, battleMenuIndex = 0;
                let isPlayerTurn = true, battleLocked = false, bossPhase = 0;
                let msgQueue = [], isTyping = false, fullText = "", typeIndex = 0;
                let currentMsgCallback = null, msgLocked = false, typeTimer = null;
                let isTransitioning = false, transitionTimeout = null;
                let isBattleStarting = false, battleStartTimeout = null;
                let defeatedEnemies = new Set();
                let openedChests = new Set();
                let battleCount = 0, chestCount = 0;
                let nearbyNPC = null, nearbyChest = null;
                let turnIndicatorTimeout = null;
                let metNPCs = [];
                let playerGender = "m", playerDept = "einkauf";
                let minimapVisible = false;
                let godMode = false;
                let cheatConsoleVisible = false;

                // Movement state (FIXED)
                let isMoving = false;
                let lastMoveTimestamp = 0;
                const MOVE_DURATION = 120;
                const MOVE_COOLDOWN = 100;

                const DEPT_NAMES = { einkauf: "Einkauf", verkauf: "Verkauf", zentrale: "Zentrale", verwaltung: "Verwaltung" };
                const GENDER_SPRITES = { m: "ğŸ§‘â€ğŸ’¼", f: "ğŸ‘©â€ğŸ’¼" };
                const GENDER_TITLES = { m: "Auszubildender", f: "Auszubildende" };

                // ===== SMOOTH MOVEMENT (FIXED - Keine doppelte Bewegung) =====
                function smoothMove(dx, dy) {
                    const now = Date.now();
                    if (now - lastMoveTimestamp < MOVE_COOLDOWN) return false;
                    if (isMoving || gameState !== "MAP" || isTransitioning || isBattleStarting) return false;

                    const nx = player.x + dx;
                    const ny = player.y + dy;

                    const mapCols = currentMap[0]?.length || 0;
                    const mapRows = currentMap.length;
                    if (nx < 0 || nx >= mapCols || ny < 0 || ny >= mapRows) return false;

                    if (dx < 0) { player.facing = "left"; playerEl.classList.add("face-left"); }
                    else if (dx > 0) { player.facing = "right"; playerEl.classList.remove("face-left"); }
                    else if (dy < 0) { player.facing = "up"; }
                    else if (dy > 0) { player.facing = "down"; }

                    const tile = currentMap[ny] ? currentMap[ny][nx] : 1;
                    const tileData = TILES[tile] || {};

                    if (tileData.block) return false;

                    const npcHit = npcs.find(n => n.x === nx && n.y === ny);
                    if (npcHit) { interactNPC(npcHit); return false; }

                    // Chest collision (FIXED - blockiert)
                    const chestHit = currentChests.find(c => c.x === nx && c.y === ny && !c.opened);
                    if (chestHit) {
                        const idx = currentChests.indexOf(chestHit);
                        const chestEl = chestLayer?.querySelector(`[data-index="${idx}"]`);
                        if (chestEl) openChest(chestHit, chestEl);
                        return false;
                    }

                    // Door check (FIXED - durch BerÃ¼hrung)
                    if (tileData.name === "door_normal" || tileData.name === "door_boss") {
                        handleDoor(nx, ny, tileData);
                        return false;
                    }

                    isMoving = true;
                    lastMoveTimestamp = now;
                    player.x = nx;
                    player.y = ny;
                    if (typeof checkSecretDocumentTile === "function") checkSecretDocumentTile();

                    playerEl.classList.add("walking");
                    playerEl.style.transition = `left ${MOVE_DURATION}ms linear, top ${MOVE_DURATION}ms linear`;
                    playerEl.style.left = (player.x * TILE) + "px";
                    playerEl.style.top = (player.y * TILE) + "px";

                    updateCamera();

                    setTimeout(() => {
                        isMoving = false;
                        playerEl.classList.remove("walking");
                        playerEl.style.transition = "";
                        checkNearbyInteractables();
                    }, MOVE_DURATION);

                    return true;
                }

                function tryMove(dx, dy) {
                    if (isMoving) return;
                    smoothMove(dx, dy);
                }

                // ===== CHEST SYSTEM =====
                function spawnChests() {
                    if (!chestLayer) return;
                    chestLayer.innerHTML = "";

                    currentChests.forEach((chest, i) => {
                        const chestKey = `${currentMapId}_${chest.x}_${chest.y}`;
                        if (openedChests.has(chestKey)) chest.opened = true;

                        const el = document.createElement("div");
                        el.className = "map-chest" + (chest.opened ? " opened" : "");
                        el.innerHTML = `
                                <div class="chest-glow"></div>
                                <div class="chest-sprite">${chest.opened ? "ğŸ“­" : (chest.type === "rare" ? "ğŸ" : "ğŸ“¦")}</div>
                            `;
                        el.style.left = (chest.x * TILE) + "px";
                        el.style.top = (chest.y * TILE) + "px";
                        el.dataset.index = i;

                        el.addEventListener("click", () => {
                            const dist = Math.abs(player.x - chest.x) + Math.abs(player.y - chest.y);
                            if (dist <= 1 && !chest.opened && gameState === "MAP") openChest(chest, el);
                        });

                        chestLayer.appendChild(el);
                    });

                    parseEmojis(chestLayer);
                }

                function openChest(chest, el) {
                    if (chest.opened) return;

                    chest.opened = true;
                    chestCount++;
                    const chestKey = `${currentMapId}_${chest.x}_${chest.y}`;
                    openedChests.add(chestKey);

                    el.classList.add("opened");
                    el.querySelector(".chest-sprite").innerText = "ğŸ“­";

                    let loot;
                    if (chest.type === "rare") {
                        const rareItems = CHEST_ITEMS.filter(i => i.type === "gold" && i.amount >= 50 || i.type === "item" || i.type === "atk");
                        loot = rareItems[Math.floor(Math.random() * rareItems.length)];
                    } else {
                        loot = CHEST_ITEMS[Math.floor(Math.random() * CHEST_ITEMS.length)];
                    }

                    let lootMsg = "";
                    if (loot.type === "gold") {
                        player.gold += loot.amount;
                        lootMsg = `${loot.icon} +${loot.amount} Gold!`;
                    } else if (loot.type === "item") {
                        const itemData = SHOP_ITEMS.find(s => s.id === loot.itemId);
                        if (itemData) {
                            const existing = player.inventory.find(i => i.id === loot.itemId);
                            if (existing) existing.count++;
                            else player.inventory.push({ id: loot.itemId, name: itemData.icon + " " + itemData.name, heal: itemData.heal, mpHeal: itemData.mpHeal || 0, count: 1 });
                        }
                        lootMsg = `${loot.icon} ${loot.name} erhalten!`;
                    } else if (loot.type === "atk") {
                        player.atk += loot.amount;
                        lootMsg = `${loot.icon} +${loot.amount} Angriff!`;
                    } else if (loot.type === "hp") {
                        player.maxHp += loot.amount;
                        player.hp += loot.amount;
                        lootMsg = `${loot.icon} +${loot.amount} Max HP!`;
                    } else if (loot.type === "exp") {
                        player.exp += loot.amount;
                        checkLevelUp();
                        lootMsg = `${loot.icon} +${loot.amount} EXP!`;
                    }

                    updateHUD();
                    showMessage(`ğŸ“¦ Truhe geÃ¶ffnet! ${lootMsg}`, "ğŸ“¦ Loot", "ğŸ“¦");
                }

                function checkNearbyInteractables() {
                    checkNearbyNPC();
                    checkNearbyChest();
                }

                function checkNearbyChest() {
                    nearbyChest = null;
                    for (const chest of currentChests) {
                        if (chest.opened) continue;
                        const dist = Math.abs(player.x - chest.x) + Math.abs(player.y - chest.y);
                        if (dist === 1) { nearbyChest = chest; break; }
                    }

                    if (nearbyChest && !nearbyNPC) {
                        const textEl = document.getElementById("interaction-text");
                        const iconEl = document.getElementById("interaction-icon");
                        if (textEl) textEl.innerText = "Ã–ffnen";
                        if (iconEl) iconEl.innerText = "ğŸ“¦";
                        interactionHint.classList.remove("mode-attack", "mode-shop", "mode-talk", "mode-default");
                        interactionHint.classList.add("visible", "mode-chest");
                    }
                }

                // ===== DOOR SYSTEM (FIXED) =====
                function spawnDoors() {
                    if (!doorLayer) return;
                    doorLayer.innerHTML = "";

                    for (const [doorId, door] of Object.entries(DOORS)) {
                        if (door.from !== currentMapId) continue;

                        const isBoss = door.label === "ChefbÃ¼ro" || doorId.includes("boss");
                        const isLocked = door.requiresBossKey && !canAccessBoss();

                        const el = document.createElement("div");
                        el.className = "map-door" + (isBoss ? " boss" : "") + (isLocked ? " locked" : "");
                        el.innerHTML = `<div class="door-frame"></div><div class="door-icon">ğŸšª</div>`;
                        el.style.left = (door.fromX * TILE) + "px";
                        el.style.top = (door.fromY * TILE - 8) + "px";
                        el.style.pointerEvents = "none";
                        el.dataset.doorId = doorId;

                        doorLayer.appendChild(el);
                    }

                    parseEmojis(doorLayer);
                }

                function canAccessBoss() {
                    const flurEnemies = MAPS.flur?.npcs?.filter(n => n.type === "enemy" && !n.isBoss) || [];
                    return flurEnemies.every(npc => {
                        const key = `flur_${npc.x}_${npc.y}_${npc.enemyId}`;
                        return defeatedEnemies.has(key);
                    });
                }

                function handleDoor(x, y, tileData) {
                    if (isTransitioning) return;

                    for (const [doorId, door] of Object.entries(DOORS)) {
                        if (door.from === currentMapId && door.fromX === x && door.fromY === y) {
                            if (door.requiresBossKey && !canAccessBoss()) {
                                const remaining = (MAPS.flur?.npcs?.filter(n => {
                                    if (n.type !== "enemy" || n.isBoss) return false;
                                    const key = `flur_${n.x}_${n.y}_${n.enemyId}`;
                                    return !defeatedEnemies.has(key);
                                }) || []).length;
                                showMessage(`Die TÃ¼r ist verschlossen! Besiege noch ${remaining} Gegner.`, "ğŸšª TÃ¼r", "ğŸšª");
                                return;
                            }

                            loadMap(door.to, true);
                            setTimeout(() => {
                                player.x = door.toX;
                                player.y = door.toY;
                                updatePlayerSprite();
                                snapCamera();
                            }, 550);
                            return;
                        }
                    }
                }

                function checkLevelUp() {
                    while (player.exp >= player.expNext) {
                        player.lvl++;
                        player.exp -= player.expNext;
                        player.expNext = Math.floor(player.expNext * 1.4);
                        player.maxHp += 20;
                        player.hp = player.maxHp;
                        player.atk += 4;
                        player.def += 2;
                        player.maxMp += 3;
                        player.mp = player.maxMp;
                    }
                }

                // ===== MINIMAP =====
                window.toggleMinimap = function () {
                    minimapVisible = !minimapVisible;
                    const container = document.getElementById("minimap-container");
                    if (container) container.classList.toggle("visible", minimapVisible);
                    if (minimapVisible) updateMinimap();
                };

                function updateMinimap() {
                    if (!minimapVisible) return;

                    const miniCanvas = document.getElementById("minimap-canvas");
                    if (!miniCanvas) return;
                    const mctx = miniCanvas.getContext("2d");

                    const mapCols = currentMap[0]?.length || 27;
                    const mapRows = currentMap.length || 17;
                    const scale = Math.min(150 / mapCols, 100 / mapRows);

                    miniCanvas.width = mapCols * scale;
                    miniCanvas.height = mapRows * scale;

                    for (let y = 0; y < mapRows; y++) {
                        for (let x = 0; x < mapCols; x++) {
                            const tile = currentMap[y] ? currentMap[y][x] : 0;
                            const tileData = TILES[tile] || TILES[0];
                            mctx.fillStyle = tileData.block ? "#333" : "#666";
                            if (tileData.name?.includes("door")) mctx.fillStyle = "#cc0";
                            mctx.fillRect(x * scale, y * scale, scale, scale);
                        }
                    }

                    npcs.forEach(npc => {
                        if (npc.type === "enemy") mctx.fillStyle = "#f44";
                        else if (npc.type === "shop") mctx.fillStyle = "#fc0";
                        else mctx.fillStyle = "#4af";
                        mctx.fillRect(npc.x * scale, npc.y * scale, scale, scale);
                    });

                    currentChests.forEach(chest => {
                        if (!chest.opened) {
                            mctx.fillStyle = chest.type === "rare" ? "#f0f" : "#fa0";
                            mctx.fillRect(chest.x * scale, chest.y * scale, scale, scale);
                        }
                    });

                    mctx.fillStyle = "#0f0";
                    mctx.fillRect(player.x * scale - 1, player.y * scale - 1, scale + 2, scale + 2);
                }

                // ===== CHEAT SYSTEM =====
                window.toggleCheatConsole = function () {
                    const consoleEl = document.getElementById("cheat-console");
                    cheatConsoleVisible = !cheatConsoleVisible;
                    if (consoleEl) consoleEl.classList.toggle("visible", cheatConsoleVisible);
                    if (cheatConsoleVisible) {
                        const input = document.getElementById("cheat-input");
                        if (input) input.focus();
                    }
                };

                function logCheat(msg, type = "info") {
                    const log = document.getElementById("cheat-log");
                    if (!log) return;
                    const line = document.createElement("div");
                    line.className = type;
                    line.innerText = "> " + msg;
                    log.appendChild(line);
                    log.scrollTop = log.scrollHeight;
                }

                function executeCheat(cmd) {
                    const parts = cmd.trim().toLowerCase().split(" ");
                    const cheat = parts[0];
                    const arg = parseInt(parts[1]) || 0;

                    switch (cheat) {
                        case "/help":
                            logCheat("Befehle: /gold, /hp, /maxhp, /mp, /atk, /def, /lvl, /exp, /tp, /godmode, /items, /killall, /openall, /reset", "info");
                            break;
                        case "/gold":
                            player.gold += arg || 1000;
                            updateHUD();
                            logCheat(`+${arg || 1000} Gold!`, "success");
                            break;
                        case "/hp":
                            player.hp = Math.min(player.maxHp, player.hp + (arg || player.maxHp));
                            updateHUD();
                            logCheat(`HP geheilt!`, "success");
                            break;
                        case "/maxhp":
                            player.maxHp += arg || 100;
                            player.hp = player.maxHp;
                            updateHUD();
                            logCheat(`Max HP +${arg || 100}!`, "success");
                            break;
                        case "/mp":
                            player.mp = Math.min(player.maxMp, player.mp + (arg || player.maxMp));
                            updateHUD();
                            logCheat(`MP aufgefÃ¼llt!`, "success");
                            break;
                        case "/atk":
                            player.atk += arg || 50;
                            updateHUD();
                            logCheat(`Angriff +${arg || 50}!`, "success");
                            break;
                        case "/def":
                            player.def += arg || 20;
                            updateHUD();
                            logCheat(`Verteidigung +${arg || 20}!`, "success");
                            break;
                        case "/lvl":
                            const lvl = arg || 10;
                            player.lvl = lvl;
                            player.maxHp = 100 + (lvl - 1) * 20;
                            player.hp = player.maxHp;
                            player.atk = 10 + (lvl - 1) * 4;
                            player.def = 2 + (lvl - 1) * 2;
                            player.maxMp = 10 + (lvl - 1) * 3;
                            player.mp = player.maxMp;
                            updateHUD();
                            logCheat(`Level ${lvl}!`, "success");
                            break;
                        case "/exp":
                            player.exp += arg || 100;
                            checkLevelUp();
                            updateHUD();
                            logCheat(`+${arg || 100} EXP!`, "success");
                            break;
                        case "/tp":
                            const mapName = parts[1] || "buero";
                            if (MAPS[mapName]) {
                                loadMap(mapName, true);
                                logCheat(`Teleportiert zu: ${MAPS[mapName].name}`, "success");
                            } else {
                                logCheat(`Map nicht gefunden. VerfÃ¼gbar: ${Object.keys(MAPS).join(", ")}`, "error");
                            }
                            break;
                        case "/godmode":
                            godMode = !godMode;
                            logCheat(`God Mode: ${godMode ? "AN" : "AUS"}`, godMode ? "success" : "info");
                            break;
                        case "/items":
                            SHOP_ITEMS.forEach(item => {
                                if (item.heal || item.mpHeal) {
                                    const existing = player.inventory.find(i => i.id === item.id);
                                    if (existing) existing.count += 10;
                                    else player.inventory.push({ id: item.id, name: item.icon + " " + item.name, heal: item.heal, mpHeal: item.mpHeal || 0, count: 10 });
                                }
                            });
                            logCheat("Alle Items erhalten!", "success");
                            break;
                        case "/killall":
                            npcs.filter(n => n.type === "enemy").forEach(npc => {
                                defeatedEnemies.add(`${currentMapId}_${npc.x}_${npc.y}_${npc.enemyId}`);
                            });
                            npcs = npcs.filter(n => n.type !== "enemy");
                            spawnNPCs();
                            logCheat("Alle Gegner besiegt!", "success");
                            break;
                        case "/openall":
                            currentChests.forEach(chest => {
                                if (!chest.opened) {
                                    chest.opened = true;
                                    openedChests.add(`${currentMapId}_${chest.x}_${chest.y}`);
                                }
                            });
                            spawnChests();
                            player.gold += 500;
                            updateHUD();
                            logCheat("Alle Kisten geÃ¶ffnet! +500 Gold!", "success");
                            break;
                        case "/reset":
                            logCheat("Spiel wird zurÃ¼ckgesetzt...", "info");
                            setTimeout(() => { resetGame(); showScreen("rpg-name-screen"); gameState = "NAME"; }, 500);
                            break;
                        default:
                            logCheat(`Unbekannt: ${cheat}. Tippe /help`, "error");
                    }
                }

                const cheatInput = document.getElementById("cheat-input");
                if (cheatInput) {
                    cheatInput.addEventListener("keydown", (e) => {
                        if (e.key === "Enter") {
                            const cmd = e.target.value.trim();
                            if (cmd) { executeCheat(cmd); e.target.value = ""; }
                        }
                        if (e.key === "Escape") toggleCheatConsole();
                        e.stopPropagation();
                    });
                }

                // ===== RESET FUNCTION =====
                function resetGame() {
                    stopCameraLoop();
                    stopNPCMovementLoop();
                    gameState = "SPLASH";
                    player = {
                        name: "Held", x: 5, y: 7, hp: 100, maxHp: 100, mp: 10, maxMp: 10,
                        gold: 50, lvl: 1, atk: 10, def: 2, exp: 0, expNext: 30,
                        inventory: [{ id: "kaffee", name: "â˜• Kaffee", heal: 40, count: 3 }],
                        gender: "m", dept: "einkauf", sprite: "ğŸ§‘â€ğŸ’¼", facing: "right"
                    };
                    playerGender = "m"; playerDept = "einkauf";
                    currentMapId = ""; currentMap = []; npcs = []; currentDecos = []; currentChests = [];
                    currentEnemy = null; msgQueue = []; isTyping = false; msgLocked = false;
                    fullText = ""; typeIndex = 0; // Reset TypeWrite state
                    if (typeTimer) clearTimeout(typeTimer);
                    battleLocked = false; defeatedEnemies = new Set(); openedChests = new Set();
                    metNPCs = []; battleCount = 0; chestCount = 0; bossPhase = 0;
                    nearbyNPC = null; nearbyChest = null; isTransitioning = false; isBattleStarting = false;
                    isMoving = false; godMode = false; minimapVisible = false; cheatConsoleVisible = false;

                    if (transitionTimeout) clearTimeout(transitionTimeout);
                    if (battleStartTimeout) clearTimeout(battleStartTimeout);
                    if (turnIndicatorTimeout) clearTimeout(turnIndicatorTimeout);

                    // Reset UI
                    if (msgBox) msgBox.classList.remove("visible");
                    if (interactionHint) interactionHint.classList.remove("visible");
                    document.getElementById("victory-screen")?.classList.remove("visible");
                    document.getElementById("defeat-screen")?.classList.remove("visible");
                    document.getElementById("battle-item-menu")?.classList.remove("visible");
                    document.getElementById("battle-skill-menu")?.classList.remove("visible");
                    document.getElementById("battle-vs-splash")?.classList.remove("active");
                    document.getElementById("turn-indicator")?.classList.remove("active", "enemy-turn");
                    document.getElementById("levelup-display")?.classList.remove("visible");
                    document.getElementById("battle-transition-in")?.classList.remove("active");
                    document.getElementById("battle-panels")?.classList.remove("active", "open", "close");
                    // Reset effects
                    document.getElementById("rpg-game-window")?.classList.remove("effect-particles", "effect-dim", "effect-windows");
                    document.getElementById("battle-transition-out")?.classList.remove("active");
                    document.getElementById("cheat-console")?.classList.remove("visible");
                    document.getElementById("minimap-container")?.classList.remove("visible");

                    const nameErr = document.getElementById("name-error");
                    const nameInp = document.getElementById("rpg-name-input");
                    const msgText = document.getElementById("msg-text");
                    const cheatLog = document.getElementById("cheat-log");
                    if (nameErr) nameErr.innerText = "";
                    if (nameInp) nameInp.value = "";
                    if (msgText) msgText.innerHTML = "";
                    if (cheatLog) cheatLog.innerHTML = "";
                    if (mapTrans) mapTrans.classList.remove("active", "battle-hold", "no-content", "opening");

                    // Clear signature and badge previews
                    document.querySelectorAll('.signature-x').forEach(el => el.innerText = '');
                    const previewNameEl = document.getElementById('preview-name');
                    const badgeRoleEl = document.getElementById('badge-role');
                    const badgeDeptEl = document.getElementById('badge-dept');
                    if (previewNameEl) previewNameEl.innerText = 'HELD';
                    if (badgeRoleEl) { badgeRoleEl.innerText = GENDER_TITLES['m']; badgeRoleEl.style.display = 'none'; }
                    if (badgeDeptEl) { badgeDeptEl.innerText = 'Abteilung: Einkauf'; badgeDeptEl.style.display = 'none'; }

                    // Re-enable contract button and all name-input controls
                    const contractBtn = document.getElementById("rpg-start-btn");
                    if (contractBtn) { contractBtn.disabled = false; contractBtn.style.opacity = "1"; }
                    if (nameInp) nameInp.disabled = false;
                    document.querySelectorAll(".gender-btn").forEach(btn => btn.disabled = false);
                    document.querySelectorAll(".dept-btn").forEach(btn => btn.disabled = false);

                    cameraX = 0; cameraY = 0; targetCameraX = 0; targetCameraY = 0;
                    if (cameraEl) cameraEl.style.transform = "";

                    showScreen(null);
                }

                // ===== SAVEFILE SYSTEM =====
                window.SAVEFILE_KEY = "bueroversum_save";

                function getSaveFile() {
                    const save = localStorage.getItem(window.SAVEFILE_KEY);
                    return save ? JSON.parse(save) : null;
                }

                function setSaveFile(data) {
                    localStorage.setItem(window.SAVEFILE_KEY, JSON.stringify(data));
                }

                function deleteSaveFile() {
                    localStorage.removeItem(window.SAVEFILE_KEY);
                }

                function hasSaveFile() {
                    return getSaveFile() !== null;
                }

                // ===== OPEN/CLOSE RPG =====
                window.openRPG = function () {
                    resetGame();
                    overlay.classList.add("opening");
                    document.body.classList.add("rpg-active");
                    if (splash) splash.classList.add("active");
                    gameState = "SPLASH";
                    setTimeout(() => {
                        overlay.classList.remove("opening");
                        overlay.classList.add("open");
                        parseEmojis(overlay);
                    }, 50);
                };

                window.closeRPG = function () {
                    stopCameraLoop();
                    stopNPCMovementLoop();
                    overlay.classList.remove("open");
                    overlay.classList.add("closing");
                    setTimeout(() => {
                        overlay.classList.remove("closing");
                        if (splash) splash.classList.remove("active");
                        document.body.classList.remove("rpg-active");
                        resetGame();
                    }, 600);
                };

                window.returnToTitleMenu = function () {
                    // Stop game loops
                    stopCameraLoop();
                    stopNPCMovementLoop();
                    
                    // Hide ending screen
                    const endingScreen = document.getElementById("rpg-ending-screen");
                    if (endingScreen) endingScreen.classList.remove("active");
                    
                    // Reset game state
                    resetGame();
                    
                    // Show splash/title screen with animation
                    if (splash) {
                        splash.classList.add("active");
                        // Reset splash animation
                        const logo = splash.querySelector(".splash-logo");
                        const title = splash.querySelector(".splash-title");
                        if (logo) {
                            logo.style.animation = "none";
                            logo.offsetHeight; // Trigger reflow
                            logo.style.animation = "";
                        }
                        if (title) {
                            title.style.animation = "none";
                            title.offsetHeight; // Trigger reflow
                            title.style.animation = "";
                        }
                    }
                    
                    // Show start button
                    const startBtn = document.getElementById("splash-start-btn");
                    if (startBtn) {
                        startBtn.style.display = "block";
                        startBtn.style.opacity = "0";
                        setTimeout(() => {
                            startBtn.style.transition = "opacity 0.5s";
                            startBtn.style.opacity = "1";
                        }, 100);
                    }
                };

                window.quitGame = function () { closeRPG(); };

                if (overlay) overlay.addEventListener("click", (e) => { if (e.target === overlay) closeRPG(); });
                document.getElementById("rpg-close-btn")?.addEventListener("click", closeRPG);

                function showScreen(id) {
                    document.querySelectorAll(".rpg-screen").forEach(s => s.classList.remove("active"));
                    if (id) {
                        const el = document.getElementById(id);
                        if (el) { el.classList.add("active"); parseEmojis(el); }
                    }
                }

                // ===== SPLASH SCREEN =====
                function skipSplash() {
                    if (gameState !== "SPLASH") return;
                    if (splash) splash.style.animation = "fadeIn 0.5s reverse forwards";
                    setTimeout(() => {
                        if (splash) { splash.classList.remove("active"); splash.style.animation = ""; }
                        showScreen("rpg-title-screen");
                        gameState = "TITLE";
                        updateTitleMenu();
                    }, 500);
                }

                document.getElementById("splash-start-btn")?.addEventListener("click", (e) => { e.preventDefault(); e.stopPropagation(); skipSplash(); });
                if (splash) {
                    splash.addEventListener("click", () => { if (gameState === "SPLASH") skipSplash(); });
                    splash.addEventListener("touchend", (e) => { if (gameState === "SPLASH") { e.preventDefault(); skipSplash(); } }, { passive: false });
                }

                // ===== TITLE MENU =====
                function updateTitleMenu() {
                    const continueBtn = document.getElementById("title-continue");
                    if (continueBtn) continueBtn.style.display = hasSaveFile() ? "flex" : "none";
                }

                function startNewGame() {
                    // Reset state so no previous name/signature persists
                    resetGame();
                    startMapTransition();
                    setTimeout(() => {
                        showScreen("rpg-name-screen");
                        gameState = "NAME";
                        // ensure input is focused and previews are reset
                        const nameInp = document.getElementById("rpg-name-input");
                        if (nameInp) { nameInp.value = ""; nameInp.focus(); }
                        const paper = document.querySelector('.contract-paper');
                        if (paper) paper.scrollTop = 0;
                    }, 550);
                }

                function continueGame() {
                    const save = getSaveFile();
                    if (!save) return;

                    // Restore gender and department first
                    playerGender = save.gender || "m";
                    playerDept = save.dept || "einkauf";

                    // Restore player object with all properties
                    player = save.player || {};
                    player.name = save.name || player.name || "Held";

                    // Ensure player has gender, dept, and sprite
                    player.gender = playerGender;
                    player.dept = playerDept;
                    player.sprite = player.sprite || GENDER_SPRITES[playerGender];
                    player.unlockedSkills = save.unlockedSkills || player.unlockedSkills || ["tacker", "kaffee", "meeting"];

                    // Restore location
                    currentMapId = save.currentMapId || "buero";

                    // Restore game progress
                    defeatedEnemies = new Set(save.defeatedEnemies || []);
                    openedChests = new Set(save.openedChests || []);
                    metNPCs = save.metNPCs || [];
                    battleCount = save.battleCount || 0;
                    chestCount = save.chestCount || 0;

                    // Update ALL visible name/sprite fields immediately
                    const _upd = (id, val) => { const el = document.getElementById(id); if (el) el.innerText = val; };
                    _upd("hud-player-name", player.name);
                    _upd("player-sprite-name", player.name);
                    _upd("battle-player-name", player.name);
                    _upd("menu-player-name", player.name);
                    _upd("vs-player-name", player.name);

                    _upd("hud-portrait", player.sprite);
                    _upd("menu-portrait", player.sprite);
                    _upd("battle-portrait", player.sprite);
                    _upd("vs-player-sprite", player.sprite);

                    const spriteBody = document.querySelector("#rpg-player .sprite-body");
                    if (spriteBody) spriteBody.innerText = player.sprite;

                    const battlePortrait = document.querySelector(".player-portrait-battle");
                    if (battlePortrait) battlePortrait.innerText = player.sprite;

                    _upd("menu-player-title", GENDER_TITLES[playerGender] + " - " + DEPT_NAMES[playerDept]);

                    if (mapTrans) {
                        const transText = mapTrans.querySelector('.transition-text');
                        if (transText) transText.innerText = MAPS[currentMapId]?.name || 'Laden...';
                    }
                    startMapTransition();
                    setTimeout(() => {
                        showScreen("rpg-game-screen");
                        loadMap(currentMapId);
                        gameState = "MAP";
                        updateHUD();
                    }, 550);
                }

                function deleteSaveData() {
                    if (confirm("Willst du wirklich alle Speicherdaten lÃ¶schen?")) {
                        deleteSaveFile();
                        updateTitleMenu();
                        showMessage("Speicherdaten wurden gelÃ¶scht.", "ğŸ—‘ï¸ GelÃ¶scht", "ğŸ—‘ï¸");
                    }
                }

                document.getElementById("title-new-game")?.addEventListener("click", startNewGame);
                document.getElementById("title-continue")?.addEventListener("click", continueGame);
                document.getElementById("title-delete-save")?.addEventListener("click", deleteSaveData);

                // ===== CHANGELOG =====
                function openChangelog() {
                    const modal = document.getElementById("changelog-modal");
                    if (modal) modal.classList.add("active");
                }

                function closeChangelog() {
                    const modal = document.getElementById("changelog-modal");
                    if (modal) modal.classList.remove("active");
                }

                document.getElementById("title-changelog")?.addEventListener("click", openChangelog);
                document.getElementById("changelog-close")?.addEventListener("click", closeChangelog);
                document.getElementById("changelog-modal")?.addEventListener("click", (e) => {
                    if (e.target.id === "changelog-modal") closeChangelog();
                });

                // ===== QUIT OPTIONS =====
                function showQuitOptions() {
                    const q = document.getElementById('quit-modal');
                    if (q) q.style.display = 'flex';
                }

                function closeQuitOptions() {
                    const q = document.getElementById('quit-modal');
                    if (q) q.style.display = 'none';
                }

                function goToTitleFromMenu() {
                    // Close menu and show title screen
                    closeMenu();
                    showScreen('rpg-title-screen');
                    gameState = 'TITLE';
                    // ensure overlay open
                    if (overlay && !overlay.classList.contains('open')) overlay.classList.add('open');
                    closeQuitOptions();
                    // Reset effects
                    document.getElementById('rpg-game-window')?.classList.remove('effect-particles', 'effect-dim', 'effect-windows');
                }

                // Expose to global so inline onclick works
                window.showQuitOptions = showQuitOptions;
                window.closeQuitOptions = closeQuitOptions;
                window.goToTitleFromMenu = goToTitleFromMenu;

                document.getElementById('quit-to-title')?.addEventListener('click', goToTitleFromMenu);
                document.getElementById('quit-close-window')?.addEventListener('click', () => { closeQuitOptions(); closeRPG(); });
                document.getElementById('quit-cancel')?.addEventListener('click', closeQuitOptions);
                document.getElementById('quit-modal')?.addEventListener('click', (e) => { if (e.target.id === 'quit-modal') closeQuitOptions(); });

                // ===== NAME INPUT =====
                const nameInput = document.getElementById("rpg-name-input");
                const nameError = document.getElementById("name-error");
                const previewName = document.getElementById("preview-name");

                document.querySelectorAll(".gender-btn").forEach(btn => {
                    btn.addEventListener("click", () => {
                        document.querySelectorAll(".gender-btn").forEach(b => b.classList.remove("active"));
                        btn.classList.add("active");
                        playerGender = btn.dataset.gender;
                        updateBadgePreview();
                    });
                });

                document.querySelectorAll(".dept-btn").forEach(btn => {
                    btn.addEventListener("click", () => {
                        document.querySelectorAll(".dept-btn").forEach(b => b.classList.remove("active"));
                        btn.classList.add("active");
                        playerDept = btn.dataset.dept;
                        updateBadgePreview();
                    });
                });

                function updateBadgePreview() {
                    const avatar = document.getElementById("badge-avatar");
                    const role = document.getElementById("badge-role");
                    const dept = document.getElementById("badge-dept");
                    if (avatar) avatar.innerText = GENDER_SPRITES[playerGender];
                    if (role) role.innerText = GENDER_TITLES[playerGender];
                    if (dept) dept.innerText = "Abteilung: " + DEPT_NAMES[playerDept];
                }

                if (nameInput) {
                    nameInput.addEventListener("input", () => {
                        const val = nameInput.value.trim();
                        if (previewName) previewName.textContent = val || "HELD";
                        const validation = validateName(val);
                        if (nameError) nameError.innerText = (val.length > 0 && !validation.valid) ? validation.error : "";
                    });
                }

                // ===== START GAME =====
                document.getElementById("rpg-start-btn")?.addEventListener("click", startGame);
                if (nameInput) nameInput.addEventListener("keydown", (e) => { if (e.key === "Enter") startGame(); });

                function startGame() {
                    const nameVal = nameInput?.value.trim() || "";
                    const validation = validateName(nameVal);

                    if (!validation.valid) {
                        if (nameError) nameError.innerText = validation.error;
                        nameInput?.focus();
                        return;
                    }

                    player.name = nameVal || "Held";
                    player.gender = playerGender;
                    player.dept = playerDept;
                    player.sprite = GENDER_SPRITES[playerGender];
                    player.unlockedSkills = ["tacker", "kaffee", "meeting"]; // Start mit 3 Skills

                    // Starte TypeWrite-Effekt auf dem Arbeitsvertrag
                    playContractTypeWriteAnimation();
                }

                function playContractTypeWriteAnimation() {
                    const paper = document.querySelector('.contract-paper');
                    if (paper) paper.scrollTop = 0;
                    const contractBody = document.querySelector(".contract-body");
                    const contractButton = document.getElementById("rpg-start-btn");

                    if (contractButton) contractButton.disabled = true;
                    if (contractButton) contractButton.style.opacity = "0.5";

                    // Deaktiviere alle Eingabe-Buttons wÃ¤hrend TypeWrite aktiv ist
                    const nameInput = document.getElementById("rpg-name-input");
                    if (nameInput) nameInput.disabled = true;
                    document.querySelectorAll(".gender-btn").forEach(btn => btn.disabled = true);
                    document.querySelectorAll(".dept-btn").forEach(btn => btn.disabled = true);

                    // Zeige badge-role und badge-dept an, bevor TypeWrite startet
                    const badgeRole = document.getElementById("badge-role");
                    const badgeDept = document.getElementById("badge-dept");
                    if (badgeRole) badgeRole.style.display = "block";
                    if (badgeDept) badgeDept.style.display = "block";

                    const texts = [
                        { id: "preview-name", text: player.name },
                        { id: "badge-role", text: GENDER_TITLES[playerGender] },
                        { id: "badge-dept", text: "Abteilung: " + DEPT_NAMES[playerDept] },
                        { id: "signature-x-employee", text: player.name, speed: 120 }
                    ];

                    let currentIndex = 0;

                    function typeNextField() {
                        if (currentIndex >= texts.length) {
                            // Alle Felder sind fertig - jetzt zur Game gehen
                            setTimeout(() => finishContractAndStartGame(), 1500);
                            return;
                        }

                        const field = texts[currentIndex];
                        const element = document.getElementById(field.id);

                        if (field.id === "signature-x-employee") {
                            // Typing into all signature elements (handles duplicated IDs/screens)
                            const sigEls = document.querySelectorAll('.signature-x');
                            if (sigEls && sigEls.length) {
                                sigEls.forEach(el => el.innerText = "");
                                // helper to return a Promise wrapping typewriteText
                                const promises = Array.from(sigEls).map(el => typewriteTextPromise(el, field.text, field.speed || 60));
                                // Scroll smooth zur Signatur innerhalb des contract-paper Containers
                                setTimeout(() => {
                                    const paper = document.querySelector('.contract-paper');
                                    const sigEl = sigEls[0];
                                    if (paper && sigEl) {
                                        const paperRect = paper.getBoundingClientRect();
                                        const sigRect = sigEl.getBoundingClientRect();
                                        const relativeTop = sigRect.top - paperRect.top + paper.scrollTop;
                                        const targetScroll = relativeTop - (paperRect.height * 0.3);
                                        paper.scrollTo({ top: Math.max(0, targetScroll), behavior: 'smooth' });
                                    }
                                }, 50);
                                Promise.all(promises).then(() => {
                                    currentIndex++;
                                    setTimeout(typeNextField, 200);
                                });
                                return;
                            }
                        }

                        if (element) {
                            element.textContent = "";
                            typewriteText(element, field.text, field.speed || 30, () => {
                                currentIndex++;
                                setTimeout(typeNextField, 200);
                            });

                            // Scroll zum Element damit man sieht wenn getippt wird
                            setTimeout(() => {
                                if (element) {
                                    const paper = document.querySelector('.contract-paper');
                                    if (paper) {
                                        const paperRect = paper.getBoundingClientRect();
                                        const elRect = element.getBoundingClientRect();
                                        const relativeTop = elRect.top - paperRect.top + paper.scrollTop;
                                        const targetScroll = relativeTop - (paperRect.height * 0.3);
                                        paper.scrollTo({ top: Math.max(0, targetScroll), behavior: 'smooth' });
                                    }
                                }
                            }, 50);
                        } else {
                            currentIndex++;
                            typeNextField();
                        }
                    }

                    typeNextField();
                }

                function typewriteText(element, text, speed = 50, callback) {
                    let currentChar = 0;
                    element.textContent = "";

                    function type() {
                        if (currentChar < text.length) {
                            element.textContent += text[currentChar];
                            currentChar++;
                            setTimeout(type, speed);
                        } else {
                            if (callback) callback();
                        }
                    }
                    type();
                }

                function typewriteTextPromise(element, text, speed = 50) {
                    return new Promise((resolve) => {
                        typewriteText(element, text, speed, resolve);
                    });
                }

                function finishContractAndStartGame() {
                    // Re-enable all input elements after TypeWrite is done
                    const nameInput = document.getElementById("rpg-name-input");
                    if (nameInput) nameInput.disabled = false;
                    document.querySelectorAll(".gender-btn").forEach(btn => btn.disabled = false);
                    document.querySelectorAll(".dept-btn").forEach(btn => btn.disabled = false);

                    // Update UI
                    const updateText = (id, text) => { const el = document.getElementById(id); if (el) el.innerText = text; };
                    updateText("hud-player-name", player.name);
                    updateText("player-sprite-name", player.name);
                    updateText("battle-player-name", player.name);
                    updateText("menu-player-name", player.name);
                    updateText("hud-portrait", player.sprite);
                    updateText("menu-portrait", player.sprite);
                    updateText("menu-player-title", GENDER_TITLES[playerGender] + " - " + DEPT_NAMES[playerDept]);

                    const spriteBody = document.querySelector("#rpg-player .sprite-body");
                    if (spriteBody) spriteBody.innerText = player.sprite;

                    const updateSprite = (id, sprite) => { const el = document.getElementById(id); if (el) el.innerText = sprite; };
                    updateSprite("vs-player-sprite", player.sprite);
                    updateSprite("battle-portrait", player.sprite);

                    const battlePortrait = document.querySelector(".player-portrait-battle");
                    if (battlePortrait) battlePortrait.innerText = player.sprite;

                    let startMap = "buero";
                    if (playerDept === "verkauf") startMap = "flur";
                    else if (playerDept === "zentrale") startMap = "zentrale";

                    // Speicherdaten
                    setSaveFile({
                        name: player.name,
                        gender: playerGender,
                        dept: playerDept,
                        player: player,
                        currentMapId: startMap,
                        unlockedSkills: player.unlockedSkills || []
                    });

                    startMapTransition();
                    setTimeout(() => {
                        loadMap(startMap, false);
                        showScreen("rpg-game-screen");
                        gameState = "MAP";
                        startCameraLoop();
                        updateHUD();

                        const genderWord = playerGender === "f" ? "Mitarbeiterin" : "Mitarbeiter";
                        showMessage(`Willkommen bei BÃ¼roVersum GmbH, ${player.name}! ğŸ¢`, "ğŸ“‹ System", "ğŸ“‹");
                        queueMessage(`Du bist jetzt ${genderWord} in der Abteilung ${DEPT_NAMES[playerDept]}.`, "ğŸ“‹ System", "ğŸ“‹");
                        queueMessage("Deine Mission: Besiege alle Gegner und den GeschÃ¤ftsfÃ¼hrer!", "ğŸ“‹ System", "ğŸ“‹");
                        queueMessage("[Pfeiltasten] Bewegen â€¢ [Enter] Interagieren â€¢ [E] MenÃ¼ â€¢ [C] Cheats", "ğŸ“‹ System", "ğŸ“‹");
                    }, 550);
                }

                // ===== MAP TRANSITION ANIMATION =====
                let mapTransitionTimeout = null;

                function startMapTransition() {
                    if (mapTrans) {
                        // Wenn eine Animation bereits lÃ¤uft, stoppe sie
                        if (mapTransitionTimeout) clearTimeout(mapTransitionTimeout);

                        // Stelle sicher, dass die active class immer gesetzt ist
                        mapTrans.classList.remove("active");
                        // Force reflow um die Animation neu zu starten
                        void mapTrans.offsetWidth;
                        mapTrans.classList.add("active");

                        mapTransitionTimeout = setTimeout(() => {
                            mapTrans.classList.remove("active");
                            mapTransitionTimeout = null;
                        }, 1500);  // Animation: 0.4s + 1s delay + 0.4s = 1.4s + Puffer
                    }
                }

                // ===== MAP LOADING =====
                function loadMap(mapId, showTransition = true) {
                    if (isTransitioning) return;

                    if (showTransition && mapId !== currentMapId) {
                        isTransitioning = true;
                        gameState = "TRANSITION";

                        const mapData = MAPS[mapId];
                        const transText = mapTrans?.querySelector(".transition-text");
                        if (transText) transText.innerText = mapData ? mapData.name : "Laden...";
                        if (mapTrans) mapTrans.classList.add("active");

                        transitionTimeout = setTimeout(() => actuallyLoadMap(mapId), 500);

                        setTimeout(() => {
                            if (mapTrans) mapTrans.classList.remove("active");
                            isTransitioning = false;
                            gameState = "MAP";
                            startCameraLoop();
                        }, 1600);  // Animation: 0.4s + 1s delay + 0.4s = 1.4s + Puffer
                    } else {
                        actuallyLoadMap(mapId);
                        startCameraLoop();
                    }
                }

                function actuallyLoadMap(mapId) {
                    currentMapId = mapId;
                    const mapData = MAPS[mapId];
                    if (!mapData) return;

                    currentMap = JSON.parse(JSON.stringify(mapData.tiles));
                    currentDecos = mapData.decos ? JSON.parse(JSON.stringify(mapData.decos)) : [];
                    currentChests = mapData.chests ? JSON.parse(JSON.stringify(mapData.chests)) : [];

                    npcs = JSON.parse(JSON.stringify(mapData.npcs)).filter(npc => {
                        if (npc.type === "enemy") {
                            return !defeatedEnemies.has(`${mapId}_${npc.x}_${npc.y}_${npc.enemyId}`);
                        }
                        return true;
                    });

                    currentChests.forEach(chest => {
                        chest.opened = openedChests.has(`${mapId}_${chest.x}_${chest.y}`);
                    });

                    player.x = mapData.start.x;
                    player.y = mapData.start.y;

                    const mapCols = mapData.cols || currentMap[0]?.length || VIEW_COLS;
                    const mapRows = mapData.rows || currentMap.length || VIEW_ROWS;
                    if (canvas) {
                        canvas.width = mapCols * TILE;
                        canvas.height = mapRows * TILE;
                    }

                    const locEl = document.getElementById("hud-location");
                    if (locEl) locEl.innerText = mapData.name;

                    drawMap();
                    drawDecorations();
                    spawnChests();
                    spawnDoors();
                    updatePlayerSprite();

                    // Map Effects (immer anwenden, wenn Map geladen wird)
                    const gameWin = document.getElementById("rpg-game-window");
                    if (gameWin) {
                        gameWin.classList.remove("effect-particles", "effect-dim", "effect-windows");
                        if (mapId === "flur") gameWin.classList.add("effect-particles");
                        if (mapId === "boss_office") gameWin.classList.add("effect-dim");
                        if (mapId === "buero" || mapId === "zentrale") gameWin.classList.add("effect-windows");
                        if (mapId === "kantine") gameWin.classList.add("effect-windows");
                    }
                    spawnNPCs();
                    snapCamera();
                    updateMinimap();
                    startCameraLoop();
                    startNPCMovementLoop();

                    parseEmojis(document.getElementById("rpg-game-screen"));
                }

                function drawMap() {
                    if (!ctx || !currentMap.length) return;
                    const mapCols = currentMap[0]?.length || VIEW_COLS;
                    const mapRows = currentMap.length;

                    ctx.clearRect(0, 0, canvas.width, canvas.height);

                    for (let y = 0; y < mapRows; y++) {
                        for (let x = 0; x < mapCols; x++) {
                            const tile = currentMap[y]?.[x] || 0;
                            const tileData = TILES[tile] || TILES[0];
                            ctx.fillStyle = tileData.bg;
                            ctx.fillRect(x * TILE, y * TILE, TILE, TILE);
                            ctx.strokeStyle = "rgba(0,0,0,0.08)";
                            ctx.strokeRect(x * TILE, y * TILE, TILE, TILE);
                        }
                    }
                }

                function drawDecorations() {
                    if (!decoLayer) return;
                    decoLayer.innerHTML = "";
                    const mapCols = currentMap[0]?.length || VIEW_COLS;
                    const mapRows = currentMap.length;

                    for (let y = 0; y < mapRows; y++) {
                        for (let x = 0; x < mapCols; x++) {
                            const tile = currentMap[y]?.[x] || 0;
                            const tileData = TILES[tile];
                            if (tileData && DECORATIONS[tileData.name]) {
                                const deco = DECORATIONS[tileData.name];
                                const el = document.createElement("div");
                                el.style.cssText = `position:absolute;left:${x * TILE + deco.offset.x}px;top:${y * TILE + deco.offset.y}px;font-size:18px;pointer-events:none;`;
                                el.innerText = deco.emoji;
                                decoLayer.appendChild(el);
                            }
                        }
                    }

                    currentDecos.forEach(d => {
                        const deco = DECORATIONS[d.type];
                        if (deco) {
                            const el = document.createElement("div");
                            el.style.cssText = `position:absolute;left:${d.x * TILE + deco.offset.x}px;top:${d.y * TILE + deco.offset.y}px;font-size:18px;pointer-events:none;`;
                            el.innerText = deco.emoji;
                            decoLayer.appendChild(el);
                        }
                    });

                    parseEmojis(decoLayer);
                }

                function spawnNPCs() {
                    if (!npcLayer) return;
                    npcLayer.innerHTML = "";

                    npcs.forEach((npc, i) => {
                        const el = document.createElement("div");
                        el.className = "rpg-npc npc-idle";
                        let indicator = "ğŸ’¬";
                        if (npc.type === "shop") indicator = "ğŸ›’";
                        else if (npc.type === "skillshop") indicator = "ğŸ“š";
                        else if (npc.type === "enemy") indicator = "â—";
                        if (npc.isBoss) indicator = "ğŸ‘‘";

                        el.innerHTML = `<span class="npc-name">${npc.name}</span><span class="npc-indicator">${indicator}</span>${npc.sprite}`;
                        el.style.left = (npc.x * TILE) + "px";
                        el.style.top = (npc.y * TILE) + "px";
                        el.dataset.index = i;

                        el.addEventListener("click", () => {
                            const dist = Math.abs(player.x - npc.x) + Math.abs(player.y - npc.y);
                            if (dist <= 2 && gameState === "MAP") interactNPC(npc);
                        });

                        npcLayer.appendChild(el);
                    });

                    parseEmojis(npcLayer);
                }

                function updatePlayerSprite() {
                    if (!playerEl) return;
                    playerEl.style.left = (player.x * TILE) + "px";
                    playerEl.style.top = (player.y * TILE) + "px";
                    checkNearbyInteractables();
                    updateMinimap();
                }

                function checkNearbyNPC() {
                    const textEl = document.getElementById("interaction-text");
                    const iconEl = document.getElementById("interaction-icon");

                    if (gameState !== "MAP" || isTransitioning || isBattleStarting || isMoving) {
                        nearbyNPC = null;
                        if (interactionHint) interactionHint.classList.remove("visible", "mode-attack", "mode-shop", "mode-talk", "mode-default", "mode-chest");
                        return;
                    }

                    nearbyNPC = null;
                    // Prioritize enemies for interaction check
                    const adjacentNPCs = npcs.filter(n => Math.abs(player.x - n.x) + Math.abs(player.y - n.y) === 1);
                    const enemyNPC = adjacentNPCs.find(n => n.type === "enemy");

                    if (enemyNPC) nearbyNPC = enemyNPC;
                    else if (adjacentNPCs.length > 0) nearbyNPC = adjacentNPCs[0];

                    if (!nearbyNPC) {
                        checkNearbyChest();
                        if (!nearbyChest && interactionHint) {
                            interactionHint.classList.remove("visible", "mode-attack", "mode-shop", "mode-talk", "mode-default", "mode-chest");
                        }
                        return;
                    }

                    let label = "Interagieren", icon = "ğŸ¤", mode = "mode-default";
                    if (nearbyNPC.type === "talk") { label = "Ansprechen"; icon = "ğŸ’¬"; mode = "mode-talk"; }
                    else if (nearbyNPC.type === "shop") { label = "Einkaufen"; icon = "ğŸ›’"; mode = "mode-shop"; }
                    else if (nearbyNPC.type === "skillshop") { label = "Training"; icon = "ğŸ“š"; mode = "mode-shop"; }
                    else if (nearbyNPC.type === "enemy") { label = "Angreifen"; icon = "âš”ï¸"; mode = "mode-attack"; }

                    if (textEl) textEl.innerText = label;
                    if (iconEl) iconEl.innerText = icon;
                    if (interactionHint) {
                        interactionHint.classList.remove("mode-attack", "mode-shop", "mode-talk", "mode-default", "mode-chest");
                        interactionHint.classList.add("visible", mode);
                    }
                }

                // ===== NPC INTERACTION =====
                function interactNPC(npc) {
                    if (isBattleStarting || isTransitioning) return;

                    if (npc.type !== "enemy" && !metNPCs.find(n => n.name === npc.name)) {
                        metNPCs.push({ name: npc.name, sprite: npc.sprite, role: npc.role || npc.type });
                    }

                    if (npc.type === "shop") { openShop(); return; }
                    if (npc.type === "skillshop") { openSkillShop(); return; }
                    if (npc.type === "enemy") { startBattle(npc); return; }

                    let lines = Array.isArray(npc.dialog) ? npc.dialog.slice() : ["..."];
                    if (npc.name === "Justin" && player.name.toLowerCase() === "justin") {
                        const idx = lines.findIndex(t => t.toLowerCase().includes("ich bin justin"));
                        lines.splice((idx >= 0 ? idx + 1 : 1), 0, "Warteâ€¦ du heiÃŸt auch Justin? Cool! ğŸ˜„");
                    }

                    lines.forEach((line, i) => {
                        if (i === 0) showMessage(line, npc.name, npc.sprite);
                        else queueMessage(line, npc.name, npc.sprite);
                    });

                    if (npc.choiceId === "justin_help") {
                        queueMessage(npc.choicePrompt || "Kann ich dir helfen?", npc.name, npc.sprite, () => openJustinChoice(npc));
                    } else if (npc.choiceId === "sertac_coffee") {
                        queueMessage(npc.choicePrompt || "Holst du mir Kaffee?", npc.name, npc.sprite, () => openSertacChoice(npc));
                    } else if (npc.choiceId === "andreas_quest") {
                        queueMessage(npc.choicePrompt || "Ich suche etwas...", npc.name, npc.sprite, () => openAndreasChoice(npc));
                    }
                }

                function openJustinChoice(npc) {
                    if (typeof window.showChoice !== "function") return;
                    window.showChoice("Was brauchst du?", [
                        { label: "Tipp", value: "tip", hint: "ğŸ’¡" },
                        { label: "Steuerung", value: "controls", hint: "ğŸ®" },
                        { label: "Cheats?", value: "cheats", hint: "ğŸ”§" },
                        { label: "Nichts", value: "no", hint: "âœ–" }
                    ], npc.name, npc.sprite, (val) => {
                        if (val === "tip") { showMessage("Tipp: Heile lieber 1 Zug zu frÃ¼h als 1 zu spÃ¤t.", npc.name, npc.sprite); }
                        else if (val === "controls") { showMessage("Pfeiltasten/WASD: laufen, ENTER: interagieren, E: MenÃ¼, C: Cheats", npc.name, npc.sprite); }
                        else if (val === "cheats") { showMessage("DrÃ¼cke [C] fÃ¼r die Cheat-Konsole! /help fÃ¼r Befehle.", npc.name, npc.sprite); }
                        else { showMessage("Alles klar. Viel Erfolg! ğŸ¢", npc.name, npc.sprite); }
                    });
                }

                function openSertacChoice(npc) {
                    if (typeof window.showChoice !== "function") return;
                    window.showChoice("Holst du mir jetzt Kaffee?", [
                        { label: "Ne man hol es dir selber.", value: "no", hint: "âœ–" },
                        { label: "Ich habe Kaffee... Abe-", value: "deal", hint: "ğŸ’°" }
                    ], npc.name, npc.sprite, (val) => {
                        if (val === "no") {
                            showMessage("Eyâ€¦ okay. Dann halt nicht. ğŸ˜’", npc.name, npc.sprite);
                            queueMessage("Wenn's brennt, dann komme ich nicht wegen das. Digga...", npc.name, npc.sprite);
                            return;
                        }
                        if (val === "deal") {
                            if (!hasAndConsumeItem("kaffee", 1)) {
                                showMessage("Du hast keinen Kaffee!", npc.name, npc.sprite);
                                return;
                            }
                            showMessage("*nimmt den Kaffee* Nice! Hier, 60 Gold.", npc.name, npc.sprite);
                            player.gold += 60;
                            updateHUD();
                            return;
                        }
                        showMessage("Schon gut, vergiss es...", npc.name, npc.sprite);
                    });
                }

                function openAndreasChoice(npc) {
                    if (typeof window.showChoice !== "function") return;
                    
                    // Initialize quest state if not exists
                    if (!player.questState) player.questState = {};
                    
                    // Quest states: null, active, completed, rewards_claimed
                    const questState = player.questState.andreasQuest || null;
                    
                    if (questState === null || questState === undefined) {
                        // Start quest
                        window.showChoice("HÃ¶r zu... Ich habe ein sehr wichtiges Dokument verloren. Es liegt irgendwo im BÃ¼ro herum. KÃ¶nntest du es fÃ¼r mich finden?", [
                            { label: "Ja, helfe dir gerne!", value: "accept", hint: "âœ…" },
                            { label: "Nein, viel zu umstÃ¤ndlich.", value: "decline", hint: "âŒ" }
                        ], npc.name, npc.sprite, (val) => {
                            if (val === "accept") {
                                player.questState.andreasQuest = "active";
                                showMessage("Wunderbar! Das Dokument ist wichtig fÃ¼r meine PrÃ¤sentation. Ich gebe dir einen Hinweis: Es liegt nicht weit von meinem Schreibtisch entfernt. ğŸ“„", npc.name, npc.sprite);
                                queueMessage("Quest gestartet: Finde das Geheime Dokument!", "ğŸ“‹ System", "ğŸ“‹");
                            } else {
                                showMessage("Schade... falls du es dir anders Ã¼berlegst, bin ich hier.", npc.name, npc.sprite);
                            }
                        });
                    } else if (questState === "active") {
                        // Check if player has the document
                        if (hasItem("geheimes_dokument", 1)) {
                            window.showChoice("Hast du mein Dokument gefunden?", [
                                { label: "Ja, hier ist es!", value: "turn_in", hint: "ğŸ“„" },
                                { label: "Noch nicht, suche weiter...", value: "not_yet", hint: "ğŸ”" }
                            ], npc.name, npc.sprite, (val) => {
                                if (val === "turn_in") {
                                    if (consumeItem("geheimes_dokument", 1)) {
                                        player.questState.andreasQuest = "completed";
                                        showMessage("Perfekt! Das ist genau das, was ich brauchte! ğŸ‰", npc.name, npc.sprite);
                                        queueMessage("Als DankeschÃ¶n mÃ¶chte ich dir etwas Besonderes beibringen...", npc.name, npc.sprite, () => {
                                            // Award special skill
                                            if (!player.unlockedSkills) player.unlockedSkills = ["tacker", "kaffee", "meeting"];
                                            if (!player.unlockedSkills.includes("ueberstunden")) {
                                                player.unlockedSkills.push("ueberstunden");
                                                showMessage("Du hast die exklusive FÃ¤higkeit 'Ãœberstunden-Boost' gelernt! ğŸ’ª", "ğŸ“‹ System", "ğŸ“‹");
                                                queueMessage("Mit dieser FÃ¤higkeit kannst du alle deine Statuswerte temporÃ¤r stark erhÃ¶hen!", "ğŸ“‹ System", "ğŸ“‹");
                                            } else {
                                                showMessage("Du hast bereits diese FÃ¤higkeit gelernt. Hier sind 100 Gold als EntschÃ¤digung! ğŸ’°", npc.name, npc.sprite);
                                                player.gold += 100;
                                                updateHUD();
                                            }
                                        });
                                    } else {
                                        showMessage("Du hast das Dokument nicht!", npc.name, npc.sprite);
                                    }
                                } else {
                                    showMessage("Kein Problem, nimm dir Zeit. Es liegt irgendwo im BÃ¼ro.", npc.name, npc.sprite);
                                }
                            });
                        } else {
                            window.showChoice("Hast du mein Dokument gefunden?", [
                                { label: "Nein, noch nicht...", value: "not_yet", hint: "ğŸ”" }
                            ], npc.name, npc.sprite, (val) => {
                                showMessage("Kein Problem! Tipp: Ich habe es heute Morgen irgendwo im BÃ¼ro liegen lassen. Schau in alle Ecken! ğŸ”", npc.name, npc.sprite);
                            });
                        }
                    } else if (questState === "completed") {
                        showMessage("Danke nochmals fÃ¼r deine Hilfe! Diese FÃ¤higkeit wird dir bestimmt nÃ¼tzlich sein. ğŸ’ª", npc.name, npc.sprite);
                    }

                // Quest helper functions
                function hasItem(itemId, amount = 1) {
                    const it = player.inventory.find(i => i.id === itemId && i.count >= amount);
                    return !!it;
                }

                function consumeItem(itemId, amount = 1) {
                    const it = player.inventory.find(i => i.id === itemId && i.count > 0);
                    if (!it) return false;
                    it.count -= amount;
                    if (it.count <= 0) {
                        player.inventory = player.inventory.filter(i => i !== it);
                    }
                    updateHUD();
                    return true;
                }

                function addItemToInventory(itemId, amount = 1) {
                    const existing = player.inventory.find(i => i.id === itemId);
                    if (existing) {
                        existing.count += amount;
                    } else {
                        player.inventory.push({ id: itemId, count: amount });
                    }
                    updateHUD();
                }

                // Secret Document Quest Item - spawn on random positions
                window.checkSecretDocumentTile = function() {
                    if (!player.questState || player.questState.andreasQuest !== "active") return;
                    if (hasItem("geheimes_dokument", 1)) return;
                    
                    const secretSpots = [
                        { x: 3, y: 3, name: "unter dem Schreibtisch" },
                        { x: 18, y: 2, name: "im Aktenregal" },
                        { x: 2, y: 15, name: "hinter der Pflanze" },
                        { x: 15, y: 14, name: "im Kopierer" },
                        { x: 8, y: 18, name: "in der Schublade" },
                        { x: 19, y: 9, name: "am Whiteboard" }
                    ];
                    
                    secretSpots.forEach(spot => {
                        if (player.x === spot.x && player.y === spot.y && Math.random() < 0.2) {
                            showMessage(`Du findest etwas! Es ist Andreas' geheimes Dokument! ğŸ“„`, "ğŸ’¡ Entdeckung", "ğŸ”");
                            queueMessage("Das muss zu Andreas! Beeile dich zurÃ¼ck.", "ğŸ’¡ Entdeckung", "ğŸ”", () => {
                                addItemToInventory("geheimes_dokument", 1);
                            });
                        }
                    });
                }
                }

                function hasAndConsumeItem(itemId, amount = 1) {
                    const it = player.inventory.find(i => i.id === itemId && i.count > 0);
                    if (!it) return false;
                    it.count -= amount;
                    if (it.count <= 0) player.inventory = player.inventory.filter(i => i !== it);
                    return true;
                }

                // ===== MESSAGES =====
                function showMessage(text, speaker = "", portrait = "ğŸ’¬", callback = null) {
                    msgQueue.push({ text, speaker, portrait, callback });
                    if (msgBox && !msgBox.classList.contains("visible") && !msgLocked) processMsg();
                }

                function queueMessage(text, speaker = "", portrait = "ğŸ’¬", callback = null) {
                    msgQueue.push({ text, speaker, portrait, callback });
                }

                function processMsg() {
                    if (msgLocked) return;
                    if (msgQueue.length === 0) {
                        if (msgBox) msgBox.classList.remove("visible");
                        if (gameState === "MESSAGE") gameState = "MAP";
                        if (currentMsgCallback) { const cb = currentMsgCallback; currentMsgCallback = null; cb(); }
                        checkNearbyInteractables();
                        return;
                    }

                    msgLocked = true;
                    const msg = msgQueue.shift();
                    currentMsgCallback = msg.callback;
                    gameState = "MESSAGE";
                    if (interactionHint) interactionHint.classList.remove("visible");

                    if (typeTimer) clearTimeout(typeTimer);
                    const msgText = document.getElementById("msg-text");
                    if (msgText) msgText.innerHTML = "";
                    if (msgBox) msgBox.classList.add("visible");

                    const speakerEl = document.getElementById("msg-speaker");
                    const portraitEl = document.getElementById("msg-portrait");
                    if (speakerEl) speakerEl.innerText = msg.speaker;
                    if (portraitEl) portraitEl.innerText = msg.portrait;

                    fullText = msg.text;
                    typeIndex = 0;
                    isTyping = true;

                    parseEmojis(msgBox);
                    setTimeout(() => { msgLocked = false; typeChar(); }, 50);
                }

                function typeChar() {
                    if (typeIndex < fullText.length && isTyping) {
                        const msgText = document.getElementById("msg-text");
                        if (msgText) msgText.innerHTML += fullText[typeIndex];
                        typeIndex++;
                        typeTimer = setTimeout(typeChar, 18);
                    } else {
                        isTyping = false;
                    }
                }

                function advanceMsg() {
                    if (msgLocked) return;
                    if (isTyping) {
                        if (typeTimer) clearTimeout(typeTimer);
                        isTyping = false;
                        const msgText = document.getElementById("msg-text");
                        if (msgText) msgText.innerHTML = fullText;
                    } else {
                        processMsg();
                    }
                }

                function forceCloseMessage() {
                    if (typeTimer) clearTimeout(typeTimer);
                    isTyping = false;
                    msgLocked = false;
                    msgQueue = [];
                    fullText = "";
                    typeIndex = 0;

                    const choiceBox = document.getElementById("msg-choice");
                    if (choiceBox) { choiceBox.classList.remove("visible"); choiceBox.innerHTML = ""; }
                    if (msgBox) msgBox.classList.remove("visible");
                    gameState = "MAP";
                    checkNearbyInteractables();
                }

                // ===== MENU =====
                window.openMenu = function () {
                    if (gameState !== "MAP") return;
                    gameState = "MENU";
                    // Remove map effects when opening menu
                    const gameWin = document.getElementById("rpg-game-window");
                    if (gameWin) gameWin.classList.remove("effect-particles", "effect-dim", "effect-windows");
                    showScreen("rpg-menu-screen");
                    updateMenuStats();
                    updateTeamTab();
                    updateWorldMapTab();
                };

                window.closeMenu = function () {
                    showScreen("rpg-game-screen");
                    gameState = "MAP";
                    // Restore map effects when closing menu
                    const gameWin = document.getElementById("rpg-game-window");
                    if (gameWin) {
                        gameWin.classList.remove("effect-particles", "effect-dim", "effect-windows");
                        if (currentMapId === "flur") gameWin.classList.add("effect-particles");
                        else if (currentMapId === "boss_office") gameWin.classList.add("effect-dim");
                        else if (currentMapId === "buero" || currentMapId === "zentrale") gameWin.classList.add("effect-windows");
                        else if (currentMapId === "kantine") gameWin.classList.add("effect-windows");
                    }
                };

                document.querySelectorAll(".menu-tab").forEach(tab => {
                    tab.addEventListener("click", () => {
                        document.querySelectorAll(".menu-tab").forEach(t => t.classList.remove("active"));
                        document.querySelectorAll(".menu-tab-content").forEach(c => c.classList.remove("active"));
                        tab.classList.add("active");
                        const content = document.getElementById("tab-" + tab.dataset.tab);
                        if (content) content.classList.add("active");
                    });
                });

                function showMenuToast(text, type = "") {
                    const el = document.getElementById("menu-toast");
                    if (!el) return;
                    el.classList.remove("show", "good", "bad");
                    if (type) el.classList.add(type);
                    el.innerText = text;
                    el.classList.add("show");
                    clearTimeout(el._t);
                    el._t = setTimeout(() => el.classList.remove("show"), 1800);
                }

                function useItemFromMenu(item) {
                    const canHealHp = item.heal && player.hp < player.maxHp;
                    const canHealMp = item.mpHeal && player.mp < player.maxMp;

                    if (!canHealHp && !canHealMp) {
                        showMenuToast("Du bist bereits voll (HP/MP).", "bad");
                        return;
                    }

                    item.count--;
                    if (item.count <= 0) player.inventory = player.inventory.filter(i => i !== item);

                    let healedHp = 0, healedMp = 0;
                    if (item.heal) { const old = player.hp; player.hp = Math.min(player.maxHp, player.hp + item.heal); healedHp = player.hp - old; }
                    if (item.mpHeal) { const old = player.mp; player.mp = Math.min(player.maxMp, player.mp + item.mpHeal); healedMp = player.mp - old; }

                    updateHUD();
                    updateMenuStats();

                    let msg = "Benutzt: " + item.name + " (";
                    if (healedHp) msg += `+${healedHp} HP`;
                    if (healedHp && healedMp) msg += ", ";
                    if (healedMp) msg += `+${healedMp} MP`;
                    msg += ")";
                    showMenuToast(msg, "good");
                }

                function updateMenuStats() {
                    const update = (id, val) => { const el = document.getElementById(id); if (el) el.innerText = val; };
                    update("menu-hp", player.hp + "/" + player.maxHp);
                    update("menu-mp", player.mp + "/" + player.maxMp);
                    update("menu-atk", player.atk);
                    update("menu-def", player.def);
                    update("menu-gold", player.gold);
                    update("menu-exp", player.exp + " / " + player.expNext);
                    update("menu-lvl", player.lvl);

                    const expBar = document.getElementById("menu-exp-bar");
                    if (expBar) expBar.style.width = (player.exp / player.expNext * 100) + "%";

                    const inv = document.getElementById("menu-inventory");
                    if (!inv) return;
                    inv.innerHTML = "";

                    if (player.inventory.length === 0) {
                        inv.innerHTML = "<div class='menu-item'><span class='menu-item-icon'>ğŸ“­</span><span class='menu-item-name'>Leer</span></div>";
                        return;
                    }

                    player.inventory.forEach(item => {
                        const parts = item.name.split(" ");
                        const icon = parts[0];
                        const name = parts.slice(1).join(" ") || item.name;

                        const el = document.createElement("div");
                        el.className = "menu-item";

                        const usable = (item.heal || item.mpHeal);
                        if (usable) el.classList.add("usable");

                        el.innerHTML = `<span class="menu-item-icon">${icon}</span><span class="menu-item-name">${name}</span><span class="menu-item-count">x${item.count}</span>`;

                        if (usable) {
                            el.style.cursor = "pointer";
                            el.onclick = () => useItemFromMenu(item);
                        }

                        inv.appendChild(el);
                    });

                    parseEmojis(inv);
                }

                function updateTeamTab() {
                    const grid = document.getElementById("team-grid");
                    if (!grid) return;
                    grid.innerHTML = "";

                    const allNPCs = [
                        { name: "Justin", sprite: "ğŸ‘¨â€ğŸ’»", role: "Entwickler" },
                        { name: "Jannik", sprite: "ğŸ‘¨â€ğŸ¦±", role: "Azubi" },
                        { name: "Hamda", sprite: "ğŸ‘©â€ğŸ¦±", role: "Azubi" },
                        { name: "Deborha", sprite: "ğŸ‘©", role: "Azubi" },
                        { name: "Thomas", sprite: "ğŸ‘¨â€ğŸ’¼", role: "Teamleiter" },
                        { name: "Andreas", sprite: "ğŸ‘¨â€ğŸ’¼", role: "Verkauf" },
                        { name: "Emmely", sprite: "ğŸ‘©â€ğŸ’¼", role: "Verkauf" },
                        { name: "Alexander", sprite: "ğŸ§”", role: "Verkauf" },
                        { name: "Sertac", sprite: "ğŸ‘¨â€ğŸ’»", role: "Zentrale" },
                        { name: "Frau Muth", sprite: "ğŸ‘©â€ğŸ«", role: "Ausbilderin" },
                        { name: "Frau Gerlacher", sprite: "ğŸ‘©â€ğŸ’¼", role: "Ausbilderin" },
                        { name: "Herr Abend", sprite: "ğŸ‘¨â€ğŸ«", role: "Ausbilder" },
                        { name: "Hausmeister Klaus", sprite: "ğŸ‘¨â€ğŸ”§", role: "Hausmeister" },
                        { name: "Lisa", sprite: "ğŸ‘©â€ğŸ’»", role: "IT-Support" },
                        { name: "Max", sprite: "ğŸ‘¨â€ğŸ’»", role: "Programmierer" },
                        { name: "Koch Werner", sprite: "ğŸ‘¨â€ğŸ³", role: "Chefkoch" },
                        { name: "Lagerarbeiter Tim", sprite: "ğŸ‘·", role: "Lager" },
                        { name: "Manager Stefan", sprite: "ğŸ‘”", role: "Management" }
                    ];

                    allNPCs.forEach(npc => {
                        const met = metNPCs.find(m => m.name === npc.name);
                        const el = document.createElement("div");
                        el.className = "team-member" + (met ? " met" : "");
                        el.innerHTML = `<span class="team-portrait">${met ? npc.sprite : "â“"}</span><div class="team-info"><div class="team-name">${met ? npc.name : "???"}</div><div class="team-role">${met ? npc.role : "Unbekannt"}</div></div>`;
                        grid.appendChild(el);
                    });

                    parseEmojis(grid);
                }

                function updateWorldMapTab() {
                    const worldMap = document.getElementById("world-map");
                    if (!worldMap) return;
                    worldMap.innerHTML = "";

                    const rooms = [
                        { id: "buero", name: "HauptbÃ¼ro", icon: "ğŸ¢", unlocked: true },
                        { id: "flur", name: "Hauptflur", icon: "ğŸšª", unlocked: true },
                        { id: "zentrale", name: "Zentrale", icon: "ğŸ–¥ï¸", unlocked: true },
                        { id: "kantine", name: "Kantine", icon: "ğŸ½ï¸", unlocked: true },
                        { id: "lager", name: "Lager", icon: "ğŸ“¦", unlocked: true },
                        { id: "serverraum", name: "Serverraum", icon: "ğŸ’»", unlocked: true },
                        { id: "konferenz", name: "Konferenz", icon: "ğŸ“Š", unlocked: true },
                        { id: "boss_office", name: "ChefbÃ¼ro", icon: "ğŸ‘”", unlocked: canAccessBoss() }
                    ];

                    rooms.forEach(room => {
                        const el = document.createElement("div");
                        el.className = "world-map-room";
                        if (room.id === currentMapId) el.classList.add("current");
                        if (!room.unlocked) el.classList.add("locked");

                        const enemies = (MAPS[room.id]?.npcs?.filter(n => {
                            if (n.type !== "enemy") return false;
                            return !defeatedEnemies.has(`${room.id}_${n.x}_${n.y}_${n.enemyId}`);
                        }) || []).length;

                        const chests = (MAPS[room.id]?.chests?.filter(c => {
                            return !openedChests.has(`${room.id}_${c.x}_${c.y}`);
                        }) || []).length;

                        el.innerHTML = `<div class="room-icon">${room.icon}</div><div class="room-name">${room.name}</div><div class="room-status">${room.unlocked ? `${enemies}ğŸ‘¾ ${chests}ğŸ“¦` : "ğŸ”’ Gesperrt"}</div>`;
                        worldMap.appendChild(el);
                    });

                    parseEmojis(worldMap);
                }

                // ===== SAVE/LOAD =====
                window.saveGame = function () {
                    // Ensure player object has the latest gender and dept
                    player.gender = playerGender;
                    player.dept = playerDept;
                    if (!player.unlockedSkills) player.unlockedSkills = [];

                    const saveData = {
                        version: "4.0.2",
                        // Top-level metadata for compatibility with older save readers
                        name: player.name,
                        gender: playerGender,
                        dept: playerDept,
                        player: player,
                        defeatedEnemies: Array.from(defeatedEnemies),
                        openedChests: Array.from(openedChests),
                        metNPCs: metNPCs,
                        currentMapId: currentMapId,
                        battleCount: battleCount,
                        chestCount: chestCount,
                        unlockedSkills: player.unlockedSkills,
                        timestamp: Date.now()
                    };

                    try {
                        console.log("[BÃ¼roVersum] Saving game:", saveData);
                        localStorage.setItem('bueroversum_save', JSON.stringify(saveData));
                        showMenuToast("ğŸ’¾ Spiel gespeichert!", "good");
                    } catch (e) {
                        showMenuToast("âŒ Speichern fehlgeschlagen!", "bad");
                        console.error("[BÃ¼roVersum] Save error:", e);
                    }
                };

                window.loadGame = function () {
                    const saved = localStorage.getItem('bueroversum_save');
                    if (!saved) { showMenuToast("âŒ Kein Spielstand gefunden!", "bad"); return; }

                    try {
                        const data = JSON.parse(saved);
                        console.log("[BÃ¼roVersum] Loaded save:", data);

                        // Restore player object with all properties
                        player = data.player || {};
                        player.name = player.name || data.name || "Held";
                        player.unlockedSkills = data.unlockedSkills || player.unlockedSkills || ["tacker", "kaffee", "meeting"];

                        // Restore gender and department
                        playerGender = data.gender || player.gender || "m";
                        playerDept = data.dept || player.dept || "einkauf";

                        // Ensure player sprite is correct
                        player.sprite = player.sprite || GENDER_SPRITES[playerGender];
                        player.gender = playerGender;
                        player.dept = playerDept;

                        // Restore game state
                        defeatedEnemies = new Set(data.defeatedEnemies || []);
                        openedChests = new Set(data.openedChests || []);
                        metNPCs = data.metNPCs || [];
                        battleCount = data.battleCount || 0;
                        chestCount = data.chestCount || 0;

                        // Update ALL UI elements with correct name and sprite
                        const update = (id, val) => { const el = document.getElementById(id); if (el) el.innerText = val; };
                        update("hud-player-name", player.name);
                        update("player-sprite-name", player.name);
                        update("battle-player-name", player.name);
                        update("menu-player-name", player.name);
                        update("vs-player-name", player.name);

                        // Update sprites everywhere
                        update("hud-portrait", player.sprite);
                        update("menu-portrait", player.sprite);
                        update("battle-portrait", player.sprite);
                        update("vs-player-sprite", player.sprite);

                        const spriteBody = document.querySelector("#rpg-player .sprite-body");
                        if (spriteBody) spriteBody.innerText = player.sprite;

                        const battlePortrait = document.querySelector(".player-portrait-battle");
                        if (battlePortrait) battlePortrait.innerText = player.sprite;

                        // Update player title in menu
                        update("menu-player-title", GENDER_TITLES[playerGender] + " - " + DEPT_NAMES[playerDept]);

                        // Close any open menus and start transition when loading
                        if (gameState === "MENU") closeMenu();
                        if (mapTrans) {
                            const transText = mapTrans.querySelector('.transition-text');
                            if (transText) transText.innerText = MAPS[data.currentMapId]?.name || 'Laden...';
                        }
                        startMapTransition();

                        // After transition, show game screen and load map (with normal transition effects)
                        setTimeout(() => {
                            showScreen("rpg-game-screen");
                            loadMap(data.currentMapId || "buero", true);
                            gameState = "MAP";
                            startCameraLoop();
                            updateHUD();
                            updateMenuStats();
                            showMenuToast("ğŸ“‚ Spielstand geladen!", "good");
                        }, 550);

                    } catch (e) {
                        showMenuToast("âŒ Laden fehlgeschlagen!", "bad");
                        console.error("Load error:", e);
                    }
                };

                // ===== SHOP =====
                function openShop() {
                    gameState = "SHOP";
                    // Remove map effects when opening shop
                    const gameWin = document.getElementById("rpg-game-window");
                    if (gameWin) gameWin.classList.remove("effect-particles", "effect-dim", "effect-windows");
                    const goldEl = document.getElementById("shop-gold");
                    const keeperText = document.getElementById("shop-keeper-text");
                    if (goldEl) goldEl.innerText = player.gold;
                    if (keeperText) keeperText.innerText = '"Willkommen! Was darf es sein?"';
                    renderShopItems();
                    showScreen("rpg-shop-screen");
                }

                function renderShopItems() {
                    const container = document.getElementById("shop-items");
                    if (!container) return;
                    container.innerHTML = "";

                    SHOP_ITEMS.forEach(item => {
                        const canAfford = player.gold >= item.price;
                        const el = document.createElement("div");
                        el.className = "shop-item" + (canAfford ? "" : " too-expensive");
                        el.innerHTML = `<span class="shop-item-icon">${item.icon}</span><div class="shop-item-info"><span class="shop-item-name">${item.name}</span><span class="shop-item-desc">${item.desc}</span></div><span class="shop-item-price">${item.price}G</span>`;
                        el.onclick = () => buyItem(item);
                        container.appendChild(el);
                    });

                    parseEmojis(container);
                }

                function buyItem(item) {
                    const keeperText = document.getElementById("shop-keeper-text");

                    if (player.gold < item.price) {
                        if (keeperText) keeperText.innerText = '"Nicht genug Gold!"';
                        return;
                    }

                    player.gold -= item.price;
                    const goldEl = document.getElementById("shop-gold");
                    if (goldEl) goldEl.innerText = player.gold;

                    const shopItems = document.querySelectorAll(".shop-item");
                    shopItems.forEach(el => {
                        if (el.querySelector(".shop-item-name")?.innerText === item.name) {
                            el.classList.add("purchased");
                            setTimeout(() => el.classList.remove("purchased"), 500);
                        }
                    });

                    renderShopItems();

                    if (item.heal) {
                        const existing = player.inventory.find(i => i.id === item.id);
                        if (existing) existing.count++;
                        else player.inventory.push({ id: item.id, name: item.icon + " " + item.name, heal: item.heal, mpHeal: item.mpHeal || 0, count: 1 });
                        if (keeperText) keeperText.innerText = `"${item.name} - gute Wahl!"`;
                    } else if (item.atkBoost) {
                        player.atk += item.atkBoost;
                        if (keeperText) keeperText.innerText = `"Angriff +${item.atkBoost}!"`;
                    } else if (item.defBoost) {
                        player.def += item.defBoost;
                        if (keeperText) keeperText.innerText = `"Verteidigung +${item.defBoost}!"`;
                    } else if (item.hpBoost) {
                        player.maxHp += item.hpBoost;
                        player.hp = player.maxHp;
                        if (keeperText) keeperText.innerText = `"Max HP +${item.hpBoost}!"`;
                    } else if (item.mpBoost) {
                        player.maxMp += item.mpBoost;
                        player.mp = player.maxMp;
                        if (keeperText) keeperText.innerText = `"Max MP +${item.mpBoost}!"`;
                    }

                    updateHUD();
                }

                window.closeShop = function () {
                    showScreen("rpg-game-screen");
                    gameState = "MAP";
                    // Restore map effects when closing shop
                    const gameWin = document.getElementById("rpg-game-window");
                    if (gameWin) {
                        gameWin.classList.remove("effect-particles", "effect-dim", "effect-windows");
                        if (currentMapId === "flur") gameWin.classList.add("effect-particles");
                        else if (currentMapId === "boss_office") gameWin.classList.add("effect-dim");
                        else if (currentMapId === "buero" || currentMapId === "zentrale") gameWin.classList.add("effect-windows");
                        else if (currentMapId === "kantine") gameWin.classList.add("effect-windows");
                    }
                };

                // ===== SKILL SHOP =====
                function openSkillShop() {
                    gameState = "SKILLSHOP";
                    // Remove map effects when opening skill shop
                    const gameWin = document.getElementById("rpg-game-window");
                    if (gameWin) gameWin.classList.remove("effect-particles", "effect-dim", "effect-windows");
                    const goldEl = document.getElementById("skillshop-gold");
                    const keeperText = document.getElementById("skillshop-keeper-text");
                    if (goldEl) goldEl.innerText = player.gold;
                    if (keeperText) keeperText.innerText = '"MÃ¶chtest du neue FÃ¤higkeiten erlernen?"';
                    renderSkillShopItems();
                    showScreen("rpg-skillshop-screen");
                }

                function renderSkillShopItems() {
                    const container = document.getElementById("skillshop-items");
                    if (!container) return;
                    container.innerHTML = "";

                    if (!player.unlockedSkills) player.unlockedSkills = [];

                    SKILL_ITEMS.forEach(skill => {
                        const isUnlocked = player.unlockedSkills.includes(skill.id);
                        const canAfford = player.gold >= skill.price;
                        const el = document.createElement("div");
                        let className = "shop-item";
                        if (isUnlocked) className += " purchased"; // Already learned
                        else if (!canAfford) className += " too-expensive";
                        el.className = className;
                        
                        const priceText = isUnlocked ? "âœ“ Gelernt" : `${skill.price}G`;
                        el.innerHTML = `<span class="shop-item-icon">${skill.icon}</span><div class="shop-item-info"><span class="shop-item-name">${skill.name}</span><span class="shop-item-desc">${skill.desc}</span></div><span class="shop-item-price">${priceText}</span>`;
                        
                        if (!isUnlocked) {
                            el.onclick = () => buySkill(skill);
                            el.style.cursor = "pointer";
                        } else {
                            el.style.cursor = "default";
                        }
                        container.appendChild(el);
                    });

                    parseEmojis(container);
                }

                function buySkill(skill) {
                    const keeperText = document.getElementById("skillshop-keeper-text");

                    if (player.gold < skill.price) {
                        if (keeperText) keeperText.innerText = '"Nicht genug Gold fÃ¼r diesen Skill!"';
                        return;
                    }

                    if (!player.unlockedSkills) player.unlockedSkills = [];

                    if (player.unlockedSkills.includes(skill.id)) {
                        if (keeperText) keeperText.innerText = '"Du kennst diesen Skill bereits!"';
                        return;
                    }

                    player.gold -= skill.price;
                    player.unlockedSkills.push(skill.id);
                    
                    const goldEl = document.getElementById("skillshop-gold");
                    if (goldEl) goldEl.innerText = player.gold;

                    const skillShopItems = document.querySelectorAll("#skillshop-items .shop-item");
                    skillShopItems.forEach(el => {
                        if (el.querySelector(".shop-item-name")?.innerText === skill.name) {
                            el.classList.add("purchased");
                            setTimeout(() => el.classList.remove("purchased"), 500);
                        }
                    });

                    renderSkillShopItems();
                    if (keeperText) keeperText.innerText = `"${skill.name} gelernt! ğŸ“š"`;
                    updateHUD();
                }

                window.closeSkillShop = function () {
                    showScreen("rpg-game-screen");
                    gameState = "MAP";
                    // Restore map effects when closing skill shop
                    const gameWin = document.getElementById("rpg-game-window");
                    if (gameWin) {
                        gameWin.classList.remove("effect-particles", "effect-dim", "effect-windows");
                        if (currentMapId === "flur") gameWin.classList.add("effect-particles");
                        else if (currentMapId === "boss_office") gameWin.classList.add("effect-dim");
                        else if (currentMapId === "buero" || currentMapId === "zentrale") gameWin.classList.add("effect-windows");
                        else if (currentMapId === "kantine") gameWin.classList.add("effect-windows");
                    }
                };

                // ===== BATTLE SYSTEM =====
                function triggerBumpEffect(el = null) {
                    const gameWin = document.getElementById("rpg-game-window");
                    const camera = document.getElementById("rpg-camera");

                    if (gameWin) {
                        // 1. FLASH & SHOCKWAVE (Immediate)
                        const flash = document.createElement("div");
                        flash.style.cssText = "position:absolute;top:0;left:0;width:100%;height:100%;z-index:9999;pointer-events:none;background:white;opacity:0;";
                        flash.classList.add("flash-white");
                        gameWin.appendChild(flash);

                        const sw = document.createElement("div");
                        sw.className = "battle-shockwave";
                        gameWin.appendChild(sw);

                        gameWin.classList.add("screen-shake");

                        // Wait 0.5s for the flash before starting the zoom effect
                        setTimeout(() => {
                            // 2. PRECISE ZOOM-IN TO PLAYER (Using viewport center)
                            if (camera && playerEl) {
                                // Zoom from viewport center for consistent zoom effect
                                camera.style.transformOrigin = "50% 50%";
                                camera.classList.add("battle-zoom-in");
                                camera.classList.add("battle-spiral-blur");
                            }
                        }, 500); // Give the flash 0.5s time before the transition kicks in

                        setTimeout(() => {
                            gameWin.classList.remove("screen-shake");
                            flash.remove();
                            sw.remove();
                        }, 1200);
                    }
                    if (playerEl) {
                        playerEl.classList.add("bump");
                        setTimeout(() => playerEl.classList.remove("bump"), 500);
                    }
                    if (el) {
                        el.classList.add("bump");
                        setTimeout(() => el.classList.remove("bump"), 500);
                    }
                }

                function startBattle(npc) {
                    if (isBattleStarting) return;

                    // Remove map effects when starting battle
                    const gameWin = document.getElementById("rpg-game-window");
                    if (gameWin) gameWin.classList.remove("effect-particles", "effect-dim", "effect-windows");

                    const cameraEl = document.getElementById("rpg-camera");
                    const mapTrans = document.getElementById("map-transition");

                    // Find NPC element
                    let npcEl = null;
                    if (npcLayer) {
                        const idx = npcs.indexOf(npc);
                        if (idx !== -1) npcEl = npcLayer.children[idx];
                    }
                    triggerBumpEffect(npcEl);

                    const enemyData = ENEMIES[npc.enemyId];
                    if (!enemyData) return;

                    isBattleStarting = true;
                    battleLocked = true;
                    gameState = "BATTLE_INTRO";
                    stopCameraLoop();

                    currentEnemy = { ...enemyData, npcRef: npc };
                    enemyHp = currentEnemy.hp;
                    enemyMaxHp = currentEnemy.hp;
                    isPlayerTurn = true;
                    battleMenuIndex = 0;
                    bossPhase = 0;

                    const update = (id, val) => { const el = document.getElementById(id); if (el) el.innerText = val; };
                    update("vs-player-name", player.name);
                    update("vs-enemy-name", currentEnemy.name);
                    update("vs-enemy-sprite", currentEnemy.sprite);
                    update("vs-player-sprite", player.sprite);

                    // ===== BATTLE PANELS SEQUENCE =====
                    // 0ms: Panels start opening
                    const battlePanels = document.getElementById("battle-panels");
                    if (battlePanels) {
                        battlePanels.classList.add("active", "open");
                    }

                    // SHOW MAP-TRANSITION IMMEDIATELY (Flash Phase 0ms) - even though panels will hide it
                    if (mapTrans) {
                        mapTrans.classList.add("active", "battle-hold", "no-content");
                    }

                    // Timeline: Panels open(0-600ms) â†’ Zoom(500-1700ms) â†’ Screen swap(900ms) â†’ Panels close(1050-1650ms) â†’ VS-Splash(1300ms)
                    battleStartTimeout = setTimeout(() => {
                        showScreen("rpg-battle-screen");
                        update("battle-enemy-name", currentEnemy.name);
                        update("battle-enemy-sprite", currentEnemy.sprite);

                        const enemySprite = document.getElementById("battle-enemy-sprite");
                        const playerSprite = document.getElementById("battle-player-sprite");
                        if (enemySprite) enemySprite.className = "";
                        if (playerSprite) { playerSprite.className = ""; playerSprite.innerText = player.sprite; }

                        updateBattleUI();
                        parseEmojis(document.getElementById("rpg-battle-screen"));

                        // 1050ms: Start closing panels
                        setTimeout(() => {
                            if (battlePanels) {
                                battlePanels.classList.remove("open");
                                battlePanels.classList.add("close");
                            }

                            // 1300ms: Show VS-Splash after panels are closing
                            setTimeout(() => {
                                const vsSplash = document.getElementById("battle-vs-splash");
                                const vsMessage = document.getElementById("vs-message");
                                const bossBanner = document.getElementById("boss-vs-banner");
                                
                                // Set VS message
                                if (vsMessage && currentEnemy.vsMessage) {
                                    vsMessage.innerText = currentEnemy.vsMessage;
                                    vsMessage.style.display = "block";
                                } else if (vsMessage) {
                                    vsMessage.style.display = "none";
                                }
                                
                                // Set Boss special banner
                                if (bossBanner && currentEnemy.isBoss) {
                                    bossBanner.innerText = "âš”ï¸ BOSS FIGHT âš”ï¸";
                                    bossBanner.style.display = "block";
                                } else if (bossBanner) {
                                    bossBanner.style.display = "none";
                                }
                                
                                if (vsSplash) vsSplash.classList.add("active");
                                if (mapTrans) {
                                    mapTrans.classList.remove("active", "opening");
                                }
                            }, 250); // 1050 + 250 = 1300
                        }, 150); // Wait 150ms before closing panels

                    }, 850);

                    // Clean up zoom and complete battle setup after all animations
                    setTimeout(() => {
                        // Reset camera zoom after enough time for animation
                        if (cameraEl) {
                            cameraEl.classList.remove("battle-zoom-in", "battle-spiral-blur");
                            cameraEl.style.transformOrigin = "";
                            cameraEl.style.transform = "";
                        }

                        // Hide transition and panels completely
                        if (mapTrans) {
                            mapTrans.classList.remove("active", "battle-hold", "opening", "no-content");
                        }

                        if (battlePanels) {
                            battlePanels.classList.remove("active", "open", "close");
                        }

                        const vsSplash = document.getElementById("battle-vs-splash");
                        if (vsSplash) vsSplash.classList.remove("active");

                        isBattleStarting = false;
                        battleLocked = false;
                        gameState = "BATTLE";

                        updateBattleMenu();
                        renderSkillMenu();

                        if (currentEnemy.isBoss && currentEnemy.phases) {
                            battleLog(currentEnemy.phases[0].dialog);
                        } else {
                            battleLog("Ein wilder " + currentEnemy.name + " erscheint!");
                        }

                        setTimeout(() => showTurn("Dein Zug!", true), 300);
                    }, 2700);
                }

                function updateBattleUI() {
                    const enemyHpPercent = Math.max(0, enemyHp / enemyMaxHp * 100);

                    const updateEl = (id, val) => { const el = document.getElementById(id); if (el) el.innerText = val; };
                    const updateStyle = (id, prop, val) => { const el = document.getElementById(id); if (el) el.style[prop] = val; };

                    updateStyle("battle-enemy-hp-fill", "width", enemyHpPercent + "%");
                    updateEl("battle-enemy-hp-text", Math.max(0, Math.floor(enemyHp)) + "/" + enemyMaxHp);

                    // Player HP (FIXED)
                    const hpPercent = (player.hp / player.maxHp * 100);
                    updateStyle("battle-hp-fill", "width", hpPercent + "%");
                    updateEl("battle-hp-text", player.hp + "/" + player.maxHp);

                    // Player MP (FIXED)
                    const mpPercent = (player.mp / player.maxMp * 100);
                    updateStyle("battle-mp-fill", "width", mpPercent + "%");
                    updateEl("battle-mp-text", player.mp + "/" + player.maxMp);

                    updateHUD();
                }

                function battleLog(text) {
                    const logEl = document.getElementById("battle-log-text");
                    if (!logEl) return;
                    logEl.style.opacity = "0";
                    setTimeout(() => { logEl.innerText = text; logEl.style.opacity = "1"; }, 100);
                }

                function showTurn(text, isPlayer = true) {
                    if (gameState === "BATTLE_INTRO") return;

                    const indicator = document.getElementById("turn-indicator");
                    const turnText = document.getElementById("turn-text");
                    const turnIcon = document.getElementById("turn-icon");

                    if (turnIndicatorTimeout) clearTimeout(turnIndicatorTimeout);
                    if (!indicator) return;

                    indicator.classList.remove("active", "enemy-turn");
                    void indicator.offsetWidth;

                    if (turnText) turnText.innerText = text;
                    if (turnIcon) turnIcon.innerText = isPlayer ? "âš”ï¸" : "ğŸ’¢";

                    if (!isPlayer) indicator.classList.add("enemy-turn");
                    indicator.classList.add("active");

                    turnIndicatorTimeout = setTimeout(() => indicator.classList.remove("active"), 1800);
                }

                function updateBattleMenu() {
                    document.querySelectorAll(".battle-cmd").forEach((btn, i) => {
                        btn.classList.toggle("selected", i === battleMenuIndex);
                        btn.classList.toggle("disabled", battleLocked);
                    });
                }

                document.querySelectorAll(".battle-cmd").forEach(btn => {
                    btn.addEventListener("click", () => {
                        if (gameState === "BATTLE" && isPlayerTurn && !battleLocked) {
                            doBattleAction(btn.dataset.cmd);
                        }
                    });
                });

                function doBattleAction(action) {
                    battleLocked = true;
                    updateBattleMenu();

                    if (action === "attack") performAttack();
                    else if (action === "skill") openSkillMenu();
                    else if (action === "item") openBattleItemMenu();
                    else if (action === "run") attemptFlee();
                }

                function performAttack() {
                    const playerSprite = document.getElementById("battle-player-sprite");
                    if (playerSprite) playerSprite.classList.add("attack");

                    setTimeout(() => {
                        if (playerSprite) playerSprite.classList.remove("attack");
                        const baseDmg = player.atk + Math.floor(Math.random() * 10);
                        const isCrit = Math.random() < 0.15;
                        let dmg = Math.max(1, baseDmg - currentEnemy.def);
                        if (isCrit) dmg = Math.floor(dmg * 1.8);

                        damageEnemy(dmg, isCrit);

                        if (isCrit) {
                            battleLog("KRITISCHER TREFFER! " + dmg + " Schaden! ğŸ’¥");
                            spawnBattleEffect("enemy", "ğŸ’¥");
                        } else {
                            battleLog("Angriff! " + dmg + " Schaden!");
                        }

                        checkBattleEnd();
                    }, 400);
                }

                function renderSkillMenu() {
                    const list = document.getElementById("battle-skill-list");
                    if (!list) return;
                    list.innerHTML = "";

                    const allSkills = [
                        { id: "tacker", name: "Tacker-Angriff", icon: "ğŸ“", cost: 4 },
                        { id: "kaffee", name: "Kaffee-Wurf", icon: "â˜•", cost: 6 },
                        { id: "meeting", name: "Meeting einberufen", icon: "ğŸ“Š", cost: 8 },
                        { id: "papier", name: "Papier-Papiertiger", icon: "ğŸ“„", cost: 5 },
                        { id: "fax", name: "Fax-Blitz", icon: "ğŸ“ ", cost: 7 },
                        { id: "printer", name: "Drucker-Crash", icon: "ğŸ–¨ï¸", cost: 9 },
                        { id: "ueberstunden", name: "Ãœberstunden-Boost", icon: "ğŸ’ª", cost: 12 },
                    ];

                    const unlockedSkills = player.unlockedSkills || ["tacker", "kaffee", "meeting"];
                    const availableSkills = allSkills.filter(skill => unlockedSkills.includes(skill.id));

                    availableSkills.forEach(skill => {
                        const row = document.createElement("div");
                        row.className = "skill-row";
                        row.dataset.skill = skill.id;
                        row.innerHTML = `<span class="skill-icon">${skill.icon}</span><span class="skill-name">${skill.name}</span><span class="skill-cost">${skill.cost} â˜•</span>`;
                        row.onclick = () => performSkill(skill.id);
                        list.appendChild(row);
                    });
                }

                function performSkill(skillId) {
                    closeSkillMenu(false);

                    const skills = {
                        tacker: { cost: 4, dmgMult: 2, icon: "ğŸ“", name: "Tacker-Angriff" },
                        kaffee: { cost: 6, dmgMult: 2.5, icon: "â˜•", name: "Kaffee-Wurf" },
                        meeting: { cost: 8, dmgMult: 3, icon: "ğŸ“Š", name: "Meeting einberufen" },
                        papier: { cost: 5, dmgMult: 2.2, icon: "ğŸ“„", name: "Papier-Papiertiger" },
                        fax: { cost: 7, dmgMult: 2.8, icon: "ğŸ“ ", name: "Fax-Blitz" },
                        printer: { cost: 9, dmgMult: 3.2, icon: "ğŸ–¨ï¸", name: "Drucker-Crash" },
                        ueberstunden: { cost: 12, dmgMult: 0, icon: "ğŸ’ª", name: "Ãœberstunden-Boost", type: "buff" }
                    };

                    const skill = skills[skillId];
                    if (!skill) return;

                    if (player.mp < skill.cost) {
                        battleLog(`Nicht genug MP! (${skill.cost} benÃ¶tigt)`);
                        openSkillMenu();
                        return;
                    }

                    player.mp -= skill.cost;

                    const playerSprite = document.getElementById("battle-player-sprite");
                    if (playerSprite) playerSprite.classList.add("skill");

                    setTimeout(() => {
                        if (playerSprite) playerSprite.classList.remove("skill");
                        
                        // Handle buff skills differently
                        if (skill.type === "buff") {
                            // Ãœberstunden-Boost: Increase stats temporarily
                            const atkBoost = Math.floor(player.atk * 0.5);
                            const defBoost = Math.floor(player.def * 0.5);
                            player.atk += atkBoost;
                            player.def += defBoost;
                            
                            battleLog(`${skill.name}! ${skill.icon} Angriff +${atkBoost}, Verteidigung +${defBoost}!`);
                            spawnBattleEffect("player", skill.icon);
                            updateBattleUI();
                            
                            // Stats return to normal after enemy's turn
                            setTimeout(() => {
                                player.atk -= atkBoost;
                                player.def -= defBoost;
                                battleLog("Ãœberstunden-Boost ist vorbei. Statuswerte normalisiert.");
                                updateBattleUI();
                            }, 3000);
                            
                            setTimeout(enemyTurn, 800);
                        } else {
                            // Normal damage skill
                            const dmg = Math.max(1, Math.floor(player.atk * skill.dmgMult + Math.random() * 15) - currentEnemy.def);
                            damageEnemy(dmg, false);
                            battleLog(`${skill.name}! ${skill.icon} ${dmg} Schaden!`);
                            spawnBattleEffect("enemy", skill.icon);
                            checkBattleEnd();
                        }
                    }, 500);
                }

                function openSkillMenu() {
                    battleLocked = true;
                    updateBattleMenu();
                    const menu = document.getElementById("battle-skill-menu");
                    if (menu) menu.classList.add("visible");
                }

                window.closeSkillMenu = function (unlock = true) {
                    const menu = document.getElementById("battle-skill-menu");
                    if (menu) menu.classList.remove("visible");
                    if (unlock && gameState === "BATTLE" && isPlayerTurn) {
                        battleLocked = false;
                        updateBattleMenu();
                    }
                };

                function openBattleItemMenu() {
                    battleLocked = true;
                    updateBattleMenu();

                    const list = document.getElementById("battle-item-list");
                    if (!list) return;
                    list.innerHTML = "";

                    const healItems = player.inventory.filter(i => (i.heal || i.mpHeal) && i.count > 0);

                    if (healItems.length === 0) {
                        list.innerHTML = "<div style='padding:15px;color:#888;text-align:center'>Keine Items</div>";
                    } else {
                        healItems.forEach(item => {
                            const parts = item.name.split(" ");
                            const row = document.createElement("div");
                            row.className = "item-row";
                            row.innerHTML = `<span class="item-icon">${parts[0]}</span><span class="item-name">${parts.slice(1).join(" ")}</span><span class="item-count">x${item.count}</span>`;
                            row.onclick = () => useBattleItem(item);
                            list.appendChild(row);
                        });
                    }

                    const menu = document.getElementById("battle-item-menu");
                    if (menu) menu.classList.add("visible");
                }

                window.closeItemMenu = function (unlock = true) {
                    const menu = document.getElementById("battle-item-menu");
                    if (menu) menu.classList.remove("visible");
                    if (unlock && gameState === "BATTLE" && isPlayerTurn) {
                        battleLocked = false;
                        updateBattleMenu();
                    }
                };

                function useBattleItem(item) {
                    closeItemMenu(false);

                    item.count--;
                    if (item.count <= 0) player.inventory = player.inventory.filter(i => i !== item);

                    let healAmt = 0;
                    if (item.heal) {
                        const oldHp = player.hp;
                        player.hp = Math.min(player.hp + item.heal, player.maxHp);
                        healAmt = player.hp - oldHp;
                    }
                    if (item.mpHeal) player.mp = Math.min(player.mp + item.mpHeal, player.maxMp);

                    battleLog("Du benutzt " + item.name + "!");
                    spawnBattleEffect("player", "âœ¨");

                    const dmgEl = document.getElementById("battle-dmg-player");
                    if (dmgEl) {
                        dmgEl.innerText = "+" + healAmt;
                        dmgEl.style.color = "#4f8";
                        dmgEl.className = "dmg-show dmg-heal";
                    }

                    updateBattleUI();
                    setTimeout(enemyTurn, 800);
                }

                function attemptFlee() {
                    if (currentEnemy.isBoss) {
                        battleLog("Keine Flucht vor dem Chef! ğŸ˜±");
                        battleLocked = false;
                        updateBattleMenu();
                    } else if (Math.random() > 0.35) {
                        battleLog("Flucht erfolgreich! ğŸƒ");
                        setTimeout(endBattleToMap, 1000);
                    } else {
                        battleLog("Flucht gescheitert!");
                        setTimeout(enemyTurn, 1000);
                    }
                }

                function damageEnemy(dmg, isCrit) {
                    enemyHp -= dmg;
                    if (enemyHp < 0) enemyHp = 0;

                    showDmgPopup("battle-dmg-enemy", dmg, isCrit ? "#f4f" : "#ff0", isCrit);

                    const enemySprite = document.getElementById("battle-enemy-sprite");
                    if (enemySprite) {
                        enemySprite.classList.add("hit");
                        setTimeout(() => enemySprite.classList.remove("hit"), 500);
                    }

                    if (currentEnemy.isBoss && currentEnemy.phases) {
                        const hpPercent = (enemyHp / enemyMaxHp) * 100;
                        for (let i = currentEnemy.phases.length - 1; i > bossPhase; i--) {
                            if (hpPercent <= currentEnemy.phases[i].hpPercent) {
                                bossPhase = i;
                                currentEnemy.atk = currentEnemy.phases[i].atk;
                                setTimeout(() => battleLog(currentEnemy.phases[i].dialog), 800);
                                break;
                            }
                        }
                    }

                    updateBattleUI();
                }

                function damagePlayer(dmg) {
                    if (godMode) { dmg = 0; battleLog("God Mode aktiv! Kein Schaden!"); }

                    player.hp -= dmg;
                    if (player.hp < 0) player.hp = 0;

                    showDmgPopup("battle-dmg-player", dmg, "#f44", false);

                    const playerSprite = document.getElementById("battle-player-sprite");
                    if (playerSprite) {
                        playerSprite.classList.add("hurt");
                        setTimeout(() => playerSprite.classList.remove("hurt"), 400);
                    }

                    updateBattleUI();
                }

                function showDmgPopup(id, dmg, color, isCrit) {
                    const el = document.getElementById(id);
                    if (!el) return;
                    el.innerText = (isCrit ? "ğŸ’¥" : "") + dmg;
                    el.style.color = color;
                    el.className = "";
                    void el.offsetWidth;
                    el.classList.add("dmg-show");
                    if (isCrit) el.classList.add("dmg-crit");
                }

                function spawnBattleEffect(target, emoji) {
                    const container = document.getElementById("battle-effect-" + target);
                    if (!container) return;
                    container.innerText = emoji;
                    container.classList.remove("effect-show");
                    void container.offsetWidth;
                    container.classList.add("effect-show");
                }

                function checkBattleEnd() {
                    if (enemyHp <= 0) {
                        const enemySprite = document.getElementById("battle-enemy-sprite");
                        if (enemySprite) enemySprite.classList.add("death");
                        battleLog(currentEnemy.name + " wurde besiegt! ğŸ‰");
                        setTimeout(showVictory, 1200);
                    } else {
                        setTimeout(enemyTurn, 1000);
                    }
                }

                function animateXPCounter(startValue, endValue, maxValue, duration) {
                    const xpCurrentEl = document.getElementById("xp-current");
                    if (!xpCurrentEl) return;

                    const startTime = Date.now();
                    const update = (id, val) => { const el = document.getElementById(id); if (el) el.innerText = val; };

                    function animateFrame() {
                        const now = Date.now();
                        const progress = Math.min((now - startTime) / duration, 1);
                        const currentValue = Math.floor(startValue + (endValue - startValue) * progress);
                        update("xp-current", currentValue);

                        if (progress < 1) {
                            requestAnimationFrame(animateFrame);
                        } else {
                            update("xp-current", endValue);
                        }
                    }

                    animateFrame();
                }

                function enemyTurn() {
                    if (gameState !== "BATTLE") return;

                    isPlayerTurn = false;
                    showTurn("Gegner-Zug!", false);

                    setTimeout(() => {
                        const baseDmg = currentEnemy.atk + Math.floor(Math.random() * 8);
                        const dmg = Math.max(1, baseDmg - player.def);

                        damagePlayer(dmg);
                        battleLog(currentEnemy.name + " greift an! " + dmg + " Schaden!");
                        spawnBattleEffect("player", "ğŸ’¢");

                        if (player.hp <= 0) {
                            const playerSprite = document.getElementById("battle-player-sprite");
                            if (playerSprite) playerSprite.classList.add("death");
                            setTimeout(showDefeat, 1000);
                        } else {
                            setTimeout(() => {
                                isPlayerTurn = true;
                                battleLocked = false;
                                updateBattleMenu();
                                showTurn("Dein Zug!", true);
                            }, 1000);
                        }
                    }, 700);
                }

                function showVictory() {
                    battleCount++;

                    const update = (id, val) => { const el = document.getElementById(id); if (el) el.innerText = val; };
                    update("victory-gold", currentEnemy.gold);
                    update("victory-exp", currentEnemy.exp);

                    // Calculate XP before adding
                    const oldLvl = player.lvl;
                    const oldExp = player.exp;
                    const oldExpNext = player.expNext;
                    const gainedExp = currentEnemy.exp;

                    player.gold += currentEnemy.gold;
                    player.exp += currentEnemy.exp;

                    let leveledUp = false;
                    while (player.exp >= player.expNext) {
                        player.lvl++;
                        player.exp -= player.expNext;
                        player.expNext = Math.floor(player.expNext * 1.4);
                        player.maxHp += 20; player.hp = player.maxHp;
                        player.atk += 4; player.def += 2;
                        player.maxMp += 3; player.mp = player.maxMp;
                        leveledUp = true;
                    }

                    // Setup XP bar animation
                    const xpBarContainer = document.getElementById("xp-bar-container");
                    const xpBarFill = document.getElementById("xp-bar-fill");
                    const xpCurrentEl = document.getElementById("xp-current");
                    const xpMaxEl = document.getElementById("xp-max");
                    
                    if (xpBarContainer && xpBarFill) {
                        xpBarContainer.classList.add("visible");
                        update("xp-current", oldExp);
                        update("xp-max", oldExpNext);
                        
                        // Animate XP bar fill and numbers after short delay
                        setTimeout(() => {
                            const newExpValue = oldExp + gainedExp;
                            const newExpPercent = newExpValue / oldExpNext * 100;
                            
                            // Animate bar width
                            xpBarFill.style.width = Math.min(newExpPercent, 100) + "%";
                            
                            // Animate XP numbers
                            animateXPCounter(oldExp, newExpValue, oldExpNext, 800);
                        }, 300);
                    }

                    const levelupDisplay = document.getElementById("levelup-display");
                    if (leveledUp) {
                        update("old-level", oldLvl);
                        update("new-level", player.lvl);
                        // Delay levelup display until after XP bar animation
                        setTimeout(() => {
                            if (levelupDisplay) levelupDisplay.classList.add("visible");
                        }, 1100);
                    } else {
                        if (levelupDisplay) levelupDisplay.classList.remove("visible");
                    }

                    const chestContainer = document.getElementById("victory-chest");
                    if (Math.random() < 0.35 && chestContainer) {
                        const chestItem = CHEST_ITEMS[Math.floor(Math.random() * CHEST_ITEMS.length)];
                        update("chest-item", chestItem.icon + " " + chestItem.name);

                        if (chestItem.type === "gold") player.gold += chestItem.amount;
                        else if (chestItem.type === "atk") player.atk += chestItem.amount;
                        else if (chestItem.type === "hp") { player.maxHp += chestItem.amount; player.hp += chestItem.amount; }
                        else if (chestItem.type === "exp") player.exp += chestItem.amount;
                        else if (chestItem.type === "item") {
                            const itemData = SHOP_ITEMS.find(s => s.id === chestItem.itemId);
                            if (itemData) {
                                const existing = player.inventory.find(i => i.id === chestItem.itemId);
                                if (existing) existing.count++;
                                else player.inventory.push({ id: chestItem.itemId, name: itemData.icon + " " + itemData.name, heal: itemData.heal, mpHeal: itemData.mpHeal || 0, count: 1 });
                            }
                        }
                        chestContainer.classList.add("visible");
                    } else if (chestContainer) {
                        chestContainer.classList.remove("visible");
                    }

                    const npc = currentEnemy.npcRef;
                    defeatedEnemies.add(`${currentMapId}_${npc.x}_${npc.y}_${npc.enemyId}`);

                    const npcIdx = npcs.findIndex(n => n.x === npc.x && n.y === npc.y && n.enemyId === npc.enemyId);
                    if (npcIdx > -1) npcs.splice(npcIdx, 1);
                    spawnNPCs();

                    // Reset XP bar for fresh animation
                    if (xpBarFill) xpBarFill.style.width = "0%";

                    const victoryScreen = document.getElementById("victory-screen");
                    if (victoryScreen) { victoryScreen.classList.add("visible"); parseEmojis(victoryScreen); }
                }

                window.endVictory = function () {
                    document.getElementById("victory-screen")?.classList.remove("visible");
                    document.getElementById("levelup-display")?.classList.remove("visible");

                    if (currentEnemy.isBoss) showEnding();
                    else endBattleToMap();
                };

                function showDefeat() {
                    const defeatScreen = document.getElementById("defeat-screen");
                    if (defeatScreen) defeatScreen.classList.add("visible");
                }

                window.respawnPlayer = function () {
                    document.getElementById("defeat-screen")?.classList.remove("visible");

                    player.hp = Math.floor(player.maxHp / 2);
                    player.mp = player.maxMp;
                    player.gold = Math.max(0, player.gold - 20);

                    endBattleToMap(() => {
                        const revived = reviveEnemiesOnDeath(3, ["buero", "flur", "zentrale"]);
                        loadMap("buero", true);

                        setTimeout(() => {
                            showMessage("Du wachst im BÃ¼ro auf... (-20 Gold)", "ğŸ“‹ System", "ğŸ“‹");
                            if (revived > 0) queueMessage(`âš ï¸ ${revived} Gegner sind wieder aufgetaucht...`, "ğŸ“‹ System", "ğŸ“‹");
                        }, 1600);
                    });
                };

                function reviveEnemiesOnDeath(count = 3, includeMaps = []) {
                    const candidates = [];

                    includeMaps.forEach(mapId => {
                        const map = MAPS[mapId];
                        if (!map || !Array.isArray(map.npcs)) return;

                        map.npcs.forEach(npc => {
                            if (npc.type !== "enemy" || npc.isBoss) return;
                            const key = `${mapId}_${npc.x}_${npc.y}_${npc.enemyId}`;
                            if (defeatedEnemies.has(key)) candidates.push(key);
                        });
                    });

                    if (candidates.length === 0) return 0;

                    for (let i = candidates.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [candidates[i], candidates[j]] = [candidates[j], candidates[i]];
                    }

                    const reviveCount = Math.min(count, candidates.length);
                    for (let i = 0; i < reviveCount; i++) defeatedEnemies.delete(candidates[i]);
                    return reviveCount;
                }

                function endBattleToMap(after = null) {
                    const transOut = document.getElementById("battle-transition-out");

                    isTransitioning = true;
                    gameState = "TRANSITION";
                    keysHeld = {};
                    stopMoveLoop();
                    if (interactionHint) interactionHint.classList.remove("visible");

                    if (transOut) transOut.classList.add("active");

                    setTimeout(() => {
                        showScreen("rpg-game-screen");
                        updateHUD();
                        startCameraLoop();
                        startNPCMovementLoop(); // Restart NPC movement upon return to map
                        
                        // Immediately restore map effects when battle screen shows
                        const gameWin = document.getElementById("rpg-game-window");
                        if (gameWin) {
                            gameWin.classList.remove("effect-particles", "effect-dim", "effect-windows");
                            if (currentMapId === "flur") gameWin.classList.add("effect-particles");
                            else if (currentMapId === "boss_office") gameWin.classList.add("effect-dim");
                            else if (currentMapId === "buero" || currentMapId === "zentrale") gameWin.classList.add("effect-windows");
                            else if (currentMapId === "kantine") gameWin.classList.add("effect-windows");
                        }
                    }, 450);

                    setTimeout(() => {
                        if (transOut) transOut.classList.remove("active");
                        isTransitioning = false;

                        // Reset message system for fresh start
                        msgLocked = false;
                        isTyping = false;
                        fullText = "";
                        typeIndex = 0;
                        if (typeTimer) clearTimeout(typeTimer);
                        typeTimer = null;
                        // Force close any existing message box
                        if (msgBox) msgBox.classList.remove("visible");

                        gameState = "MAP";

                        checkNearbyInteractables();
                        if (typeof after === "function") after();
                    }, 1400);  // Animation: 0.35s + 0.9s delay + 0.35s = 1.25s + Puffer
                }

                function showEnding() {
                    const update = (id, val) => { const el = document.getElementById(id); if (el) el.innerText = val; };
                    update("ending-name", player.name);
                    update("ending-level", player.lvl);
                    update("ending-gold", player.gold);
                    update("ending-battles", battleCount);
                    update("ending-chests", chestCount);

                    setTimeout(() => {
                        showScreen("rpg-ending-screen");
                        gameState = "ENDING";
                        parseEmojis(document.getElementById("rpg-ending-screen"));
                    }, 500);
                }

                // ===== HUD =====
                function updateHUD() {
                    const update = (id, val) => { const el = document.getElementById(id); if (el) el.innerText = val; };
                    const updateStyle = (id, prop, val) => { const el = document.getElementById(id); if (el) el.style[prop] = val; };

                    update("hud-hp", player.hp);
                    update("hud-max-hp", player.maxHp);
                    update("hud-mp", player.mp);
                    update("hud-gold", player.gold);
                    update("hud-level", player.lvl);
                    updateStyle("hud-hp-bar", "width", (player.hp / player.maxHp * 100) + "%");
                    updateStyle("hud-mp-bar", "width", (player.mp / player.maxMp * 100) + "%");
                    updateStyle("hud-exp-bar", "width", (player.exp / player.expNext * 100) + "%");
                }

                // ===== KEYBOARD CONTROLS (FIXED) =====
                document.addEventListener("keydown", (e) => {
                    if (!overlay || !overlay.classList.contains("open")) return;

                    if (keysHeld[e.key] && ["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight", "w", "a", "s", "d", "W", "A", "S", "D"].includes(e.key)) {
                        return;
                    }

                    keysHeld[e.key] = true;
                    if (["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight", "w", "a", "s", "d", "W", "A", "S", "D"].includes(e.key)) {
                        directionHistory = directionHistory.filter(k => k !== e.key);
                        directionHistory.push(e.key);
                    }

                    if (e.key === "Escape") {
                        e.preventDefault();
                        if (cheatConsoleVisible) { toggleCheatConsole(); return; }
                        if (typeof choiceActive !== "undefined" && choiceActive) {
                            if (typeof cancelChoice === "function") cancelChoice();
                            else forceCloseMessage();
                            return;
                        }
                        if (gameState === "MESSAGE") { forceCloseMessage(); return; }
                        if (gameState === "BATTLE") {
                            if (document.getElementById("battle-item-menu")?.classList.contains("visible")) { closeItemMenu(); return; }
                            if (document.getElementById("battle-skill-menu")?.classList.contains("visible")) { closeSkillMenu(); return; }
                        }
                        if (gameState === "MENU") { closeMenu(); return; }
                        if (gameState === "SHOP") { closeShop(); return; }
                        if (gameState === "TRANSITION" || gameState === "BATTLE_INTRO") return;
                        closeRPG();
                        return;
                    }

                    if ((e.key === "c" || e.key === "C") && gameState === "MAP" && !cheatConsoleVisible) {
                        toggleCheatConsole();
                        return;
                    }

                    if (gameState === "SPLASH") {
                        if (e.key === "Enter" || e.key === " ") { e.preventDefault(); skipSplash(); }
                        return;
                    }

                    if (gameState === "CHOICE") return;

                    if (gameState === "MESSAGE") {
                        if (e.key === "Enter" || e.key === " ") { e.preventDefault(); advanceMsg(); }
                        return;
                    }

                    if (gameState === "MAP" && !isTransitioning && !isBattleStarting && !cheatConsoleVisible) {
                        if (e.key === "e" || e.key === "E") { openMenu(); return; }
                        if (e.key === "m" || e.key === "M") { toggleMinimap(); return; }

                        if (e.key === "Enter" || e.key === " ") {
                            e.preventDefault();
                            if (nearbyNPC) { interactNPC(nearbyNPC); return; }
                            if (nearbyChest && !nearbyChest.opened) {
                                const idx = currentChests.indexOf(nearbyChest);
                                const chestEl = chestLayer?.querySelector(`[data-index="${idx}"]`);
                                if (chestEl) openChest(nearbyChest, chestEl);
                                return;
                            }
                        }

                        if (["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight", "w", "a", "s", "d", "W", "A", "S", "D"].includes(e.key)) {
                            e.preventDefault();
                            processHeldKeys();
                            setTimeout(() => { if (keysHeld[e.key]) startMoveLoop(); }, 150);
                        }
                        return;
                    }

                    if (gameState === "MENU") {
                        if (e.key === "e" || e.key === "E") { closeMenu(); return; }
                        return;
                    }

                    if (gameState === "BATTLE" && isPlayerTurn && !battleLocked) {
                        if (document.getElementById("battle-item-menu")?.classList.contains("visible")) return;
                        if (document.getElementById("battle-skill-menu")?.classList.contains("visible")) return;

                        e.preventDefault();
                        const cmds = ["attack", "skill", "item", "run"];

                        if (e.key === "ArrowUp") { battleMenuIndex = battleMenuIndex >= 2 ? battleMenuIndex - 2 : battleMenuIndex; updateBattleMenu(); }
                        else if (e.key === "ArrowDown") { battleMenuIndex = battleMenuIndex < 2 ? battleMenuIndex + 2 : battleMenuIndex; updateBattleMenu(); }
                        else if (e.key === "ArrowLeft") { battleMenuIndex = (battleMenuIndex % 2 === 1) ? battleMenuIndex - 1 : battleMenuIndex; updateBattleMenu(); }
                        else if (e.key === "ArrowRight") { battleMenuIndex = (battleMenuIndex % 2 === 0) ? battleMenuIndex + 1 : battleMenuIndex; updateBattleMenu(); }
                        else if (e.key === "Enter" || e.key === " ") { doBattleAction(cmds[battleMenuIndex]); }
                        return;
                    }
                });

                document.addEventListener("keyup", (e) => {
                    delete keysHeld[e.key];
                    directionHistory = directionHistory.filter(k => k !== e.key);
                    const moveKeys = ["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight", "w", "a", "s", "d", "W", "A", "S", "D"];
                    if (!Object.keys(keysHeld).some(k => moveKeys.includes(k))) stopMoveLoop();
                });

                function processHeldKeys() {
                    if (cheatConsoleVisible || isMoving) return;

                    let moveKey = null;
                    // Check direction history (stack) for most recent key
                    for (let i = directionHistory.length - 1; i >= 0; i--) {
                        if (keysHeld[directionHistory[i]]) {
                            moveKey = directionHistory[i];
                            break;
                        }
                    }

                    // Fallback for Touch controls (which set keysHeld but not history)
                    if (!moveKey) {
                        if (keysHeld["ArrowUp"]) moveKey = "ArrowUp";
                        else if (keysHeld["ArrowDown"]) moveKey = "ArrowDown";
                        else if (keysHeld["ArrowLeft"]) moveKey = "ArrowLeft";
                        else if (keysHeld["ArrowRight"]) moveKey = "ArrowRight";
                    }

                    if (moveKey) {
                        if (["ArrowUp", "w", "W"].includes(moveKey)) tryMove(0, -1);
                        else if (["ArrowDown", "s", "S"].includes(moveKey)) tryMove(0, 1);
                        else if (["ArrowLeft", "a", "A"].includes(moveKey)) tryMove(-1, 0);
                        else if (["ArrowRight", "d", "D"].includes(moveKey)) tryMove(1, 0);
                    }
                }

                function startMoveLoop() {
                    if (!moveInterval && gameState === "MAP") moveInterval = setInterval(processHeldKeys, 130);
                }

                function stopMoveLoop() {
                    if (moveInterval) { clearInterval(moveInterval); moveInterval = null; }
                }

                // ===== MOBILE TOUCH CONTROLS =====
                document.querySelectorAll(".dpad-btn").forEach(btn => {
                    const dir = btn.dataset.dir;

                    const startAction = (e) => {
                        e.preventDefault();
                        e.stopPropagation();

                        if (dir === "up") { keysHeld["ArrowUp"] = true; tryMove(0, -1); startMoveLoop(); }
                        else if (dir === "down") { keysHeld["ArrowDown"] = true; tryMove(0, 1); startMoveLoop(); }
                        else if (dir === "left") { keysHeld["ArrowLeft"] = true; tryMove(-1, 0); startMoveLoop(); }
                        else if (dir === "right") { keysHeld["ArrowRight"] = true; tryMove(1, 0); startMoveLoop(); }
                        else if (dir === "ok") {
                            if (gameState === "MESSAGE") advanceMsg();
                            else if (gameState === "SPLASH") skipSplash();
                            else if (gameState === "MAP") {
                                if (nearbyNPC) interactNPC(nearbyNPC);
                                else if (nearbyChest && !nearbyChest.opened) {
                                    const idx = currentChests.indexOf(nearbyChest);
                                    const chestEl = chestLayer?.querySelector(`[data-index="${idx}"]`);
                                    if (chestEl) openChest(nearbyChest, chestEl);
                                }
                            }
                        }
                    };

                    const endAction = (e) => {
                        e.preventDefault();
                        Object.keys(keysHeld).forEach(k => delete keysHeld[k]);
                        stopMoveLoop();
                    };

                    btn.addEventListener("mousedown", startAction);
                    btn.addEventListener("mouseup", endAction);
                    btn.addEventListener("mouseleave", endAction);
                    btn.addEventListener("touchstart", startAction, { passive: false });
                    btn.addEventListener("touchend", endAction, { passive: false });
                    btn.addEventListener("touchcancel", endAction, { passive: false });
                });

                // ===== CHOICE SYSTEM =====
                let choiceActive = false;
                let choiceIndex = 0;
                let choiceOptions = [];
                let choiceCallback = null;
                let choicePrevState = "MESSAGE";

                function renderChoice() {
                    const box = document.getElementById("msg-choice");
                    if (!box) return;

                    box.innerHTML = "";
                    box.classList.add("visible");

                    choiceOptions.forEach((opt, i) => {
                        const row = document.createElement("div");
                        row.className = "choice-row" + (i === choiceIndex ? " selected" : "");
                        row.innerHTML = `<div class="choice-left"><div class="choice-cursor">${i === choiceIndex ? "â–º" : ""}</div><div class="choice-text">${opt.label}</div></div><div style="opacity:.6">${opt.hint || ""}</div>`;
                        row.onclick = () => { choiceIndex = i; confirmChoice(); };
                        box.appendChild(row);
                    });

                    const hint = document.createElement("div");
                    hint.className = "choice-hint";
                    hint.innerText = "â†‘â†“ wÃ¤hlen â€¢ ENTER bestÃ¤tigen";
                    box.appendChild(hint);

                    parseEmojis(box);
                }

                function closeChoiceUI() {
                    const box = document.getElementById("msg-choice");
                    if (box) { box.classList.remove("visible"); box.innerHTML = ""; }
                    choiceActive = false;
                    choiceOptions = [];
                    choiceCallback = null;
                }

                function confirmChoice() {
                    if (!choiceActive || choiceOptions.length === 0) return;
                    const picked = choiceOptions[choiceIndex];
                    const cb = choiceCallback;
                    closeChoiceUI();
                    gameState = choicePrevState === "MESSAGE" ? "MESSAGE" : "MAP";
                    // If returning to MAP, ensure the message box is hidden so it doesn't block interaction
                    if (gameState === "MAP") { if (msgBox) msgBox.classList.remove('visible'); }
                    checkNearbyInteractables();
                    if (typeof cb === "function") cb(picked.value, picked);
                    if (msgQueue.length > 0) processMsg();
                }

                function cancelChoice() {
                    const cb = choiceCallback;
                    closeChoiceUI();
                    gameState = choicePrevState === "MESSAGE" ? "MESSAGE" : "MAP";
                    // Hide the message box when cancelling back to the map
                    if (gameState === "MAP") { if (msgBox) msgBox.classList.remove('visible'); }
                    checkNearbyInteractables();
                    if (typeof cb === "function") cb(null, null);
                }

                window.showChoice = function (question, options, speaker = "System", portrait = "ğŸ“‹", onSelect = null) {
                    if (typeTimer) clearTimeout(typeTimer);
                    isTyping = false;
                    msgLocked = false;

                    choicePrevState = (gameState === "MESSAGE") ? "MESSAGE" : "MAP";
                    gameState = "CHOICE";

                    choiceActive = true;
                    choiceIndex = 0;
                    choiceOptions = (options || []).map(o => ({
                        label: String(o.label ?? o),
                        value: (o.value ?? o),
                        hint: o.hint || ""
                    }));
                    choiceCallback = onSelect;

                    if (msgBox) msgBox.classList.add("visible");
                    const speakerEl = document.getElementById("msg-speaker");
                    const portraitEl = document.getElementById("msg-portrait");
                    const textEl = document.getElementById("msg-text");
                    if (speakerEl) speakerEl.innerText = speaker;
                    if (portraitEl) portraitEl.innerText = portrait;
                    if (textEl) textEl.innerText = question;
                    if (interactionHint) interactionHint.classList.remove("visible");

                    renderChoice();
                };

                document.addEventListener("keydown", function (e) {
                    if (!overlay || !overlay.classList.contains("open")) return;
                    if (!choiceActive) return;

                    e.preventDefault();
                    e.stopImmediatePropagation();

                    if (e.key === "ArrowUp") { choiceIndex = (choiceIndex - 1 + choiceOptions.length) % choiceOptions.length; renderChoice(); }
                    else if (e.key === "ArrowDown") { choiceIndex = (choiceIndex + 1) % choiceOptions.length; renderChoice(); }
                    else if (e.key === "Enter" || e.key === " ") confirmChoice();
                    else if (e.key === "Escape") cancelChoice();
                }, true);

                // ===== EXPOSE GLOBAL FUNCTIONS =====
                window.openRPG = openRPG;
                window.closeRPG = closeRPG;
                window.openMenu = openMenu;
                window.closeMenu = closeMenu;
                window.openShop = openShop;
                window.closeShop = closeShop;
                window.saveGame = saveGame;
                window.loadGame = loadGame;
                window.toggleCheatConsole = toggleCheatConsole;
                window.toggleMinimap = toggleMinimap;
                window.endVictory = endVictory;
                window.respawnPlayer = respawnPlayer;
                window.closeSkillMenu = closeSkillMenu;
                window.closeItemMenu = closeItemMenu;
                // expose quit action as closing the RPG overlay by default
                window.quitGame = closeRPG;
                window.showChoice = showChoice;

                console.log("ğŸ¢ BÃ¼roVersum RPG v4.0.1 geladen!");
                console.log("ğŸ’¡ Tipp: DrÃ¼cke [C] im Spiel fÃ¼r Cheats!");

            });
        })();
    </script>
